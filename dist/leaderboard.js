import { engine, Material, MeshRenderer } from "@dcl/sdk/ecs";
import { TextShape, Transform } from "@dcl/sdk/ecs";
import { Color4, Vector3 } from "@dcl/sdk/math";
import { getPlayer } from "@dcl/sdk/players";
import { DEBUG } from "./definitions";
export function LSCQuestLeaderboard(questId, transform, updateInterval, limit, order = 'asc', sortBy = 'elapsedTime', completed = true, showBackground = true, title = "Leaderboard") {
    let leaderboard = engine.addEntity();
    Transform.create(leaderboard, transform);
    const rowWidth = 3;
    const rowHeight = 0.4;
    function formatScoreType(type) {
        if (type === 'elapsedTime')
            return 'Time';
        return type.charAt(0).toUpperCase() + type.slice(1);
    }
    const titleEntity = engine.addEntity();
    Transform.create(titleEntity, {
        parent: leaderboard,
        position: Vector3.create(0, 0.6, 0)
    });
    TextShape.create(titleEntity, {
        text: title,
        fontSize: 2.5,
        textAlign: 4
    });
    const leftPos = -1.3;
    const centerPos = 0;
    const rightPos = 1;
    const headerEntity = engine.addEntity();
    Transform.create(headerEntity, {
        parent: leaderboard,
        position: Vector3.create(0, 0.2, 0)
    });
    const headerBgEntity = engine.addEntity();
    Transform.create(headerBgEntity, {
        parent: headerEntity,
        position: Vector3.create(0, 0, 0.03),
        scale: Vector3.create(rowWidth, rowHeight, 1)
    });
    MeshRenderer.setPlane(headerBgEntity);
    Material.setPbrMaterial(headerBgEntity, {
        albedoColor: Color4.create(0 / 255, 255 / 255, 213 / 255, 1)
    });
    const rankHeaderEntity = engine.addEntity();
    Transform.create(rankHeaderEntity, {
        parent: headerEntity,
        position: Vector3.create(leftPos, 0, 0.02)
    });
    TextShape.create(rankHeaderEntity, {
        text: "Rank",
        fontSize: 1.5,
        textAlign: 4
    });
    const nameHeaderEntity = engine.addEntity();
    Transform.create(nameHeaderEntity, {
        parent: headerEntity,
        position: Vector3.create(centerPos - 0.4, 0, 0.02)
    });
    TextShape.create(nameHeaderEntity, {
        text: "Player",
        fontSize: 1.5,
        textAlign: 3
    });
    const scoreHeaderEntity = engine.addEntity();
    Transform.create(scoreHeaderEntity, {
        parent: headerEntity,
        position: Vector3.create(rightPos, 0, 0.02)
    });
    TextShape.create(scoreHeaderEntity, {
        text: formatScoreType(sortBy),
        fontSize: 1.5,
        textAlign: 4
    });
    const leaderboardRows = [];
    for (let i = 0; i < limit; i++) {
        const rowEntity = engine.addEntity();
        Transform.create(rowEntity, {
            parent: leaderboard,
            position: Vector3.create(0, -i * 0.5 - 0.2, 0)
        });
        const backgroundEntity = engine.addEntity();
        if (showBackground) {
            Transform.create(backgroundEntity, {
                parent: rowEntity,
                position: Vector3.create(0, 0, 0.01),
                scale: Vector3.create(rowWidth, rowHeight, 1)
            });
            MeshRenderer.setPlane(backgroundEntity);
            Material.setPbrMaterial(backgroundEntity, {
                albedoColor: i % 2 === 0 ?
                    Color4.create(18 / 255, 23 / 255, 37 / 255, 1) :
                    Color4.create(26 / 255, 34 / 255, 53 / 255, 1)
            });
        }
        else {
            Transform.create(backgroundEntity, {
                parent: rowEntity,
                scale: Vector3.Zero()
            });
        }
        const rankEntity = engine.addEntity();
        Transform.create(rankEntity, {
            parent: rowEntity,
            position: Vector3.create(leftPos, 0, 0)
        });
        TextShape.create(rankEntity, { text: `#${i + 1}`, fontSize: 1.5 });
        const profileEntity = engine.addEntity();
        Transform.create(profileEntity, {
            parent: rowEntity,
            position: Vector3.create(centerPos - 0.8, 0, 0),
            scale: Vector3.create(0.3, 0.3, 0.3)
        });
        MeshRenderer.setPlane(profileEntity);
        Material.setPbrMaterial(profileEntity, {
            texture: Material.Texture.Avatar({
                userId: '',
            }),
        });
        const nameEntity = engine.addEntity();
        Transform.create(nameEntity, {
            parent: rowEntity,
            position: Vector3.create(centerPos - 0.4, 0, 0)
        });
        TextShape.create(nameEntity, { text: `Name`, fontSize: 1.5, textAlign: 3 });
        const scoreEntity = engine.addEntity();
        Transform.create(scoreEntity, {
            parent: rowEntity,
            position: Vector3.create(rightPos, 0, 0)
        });
        TextShape.create(scoreEntity, { text: `Score`, fontSize: 1.5 });
        leaderboardRows.push({
            rank: i + 1,
            rowEntity,
            backgroundEntity,
            rankEntity,
            profileEntity,
            nameEntity,
            scoreEntity
        });
    }
    let time = 0;
    function leaderboardUpdate(dt) {
        if (time > 0) {
            time -= dt;
        }
        else {
            time = updateInterval;
            updateLSCQuestLeaderboard();
        }
    }
    async function updateLSCQuestLeaderboard() {
        try {
            const playerData = getPlayer();
            const playerID = playerData ? playerData.userId : '';
            const playerName = playerData?.name || 'You';
            let params = [`completed=${completed}`, `order=${order}`, `limit=${limit}`, `sortBy=${sortBy}`];
            let response = await fetch(DEBUG ? `http://localhost:5353/api/quests/${questId}/users?` + params.join('&') : `https://angzaar-plaza.dcl-iwb.co/ws/api/quests/${questId}/users?` + params.join('&'));
            let data = await response.json();
            if (!data || data.length === 0) {
                const row = leaderboardRows[0];
                if (Transform.has(row.rowEntity)) {
                    Transform.getMutable(row.rowEntity).scale = Vector3.create(1, 1, 1);
                    if (showBackground) {
                        Transform.getMutable(row.backgroundEntity).scale = Vector3.create(rowWidth, rowHeight, 1);
                    }
                    TextShape.getMutable(row.rankEntity).text = "";
                    TextShape.getMutable(row.nameEntity).text = "No data available";
                    TextShape.getMutable(row.scoreEntity).text = "";
                    Transform.getMutable(row.profileEntity).scale = Vector3.Zero();
                    for (let i = 1; i < leaderboardRows.length; i++) {
                        const remainingRow = leaderboardRows[i];
                        if (Transform.has(remainingRow.rowEntity)) {
                            Transform.getMutable(remainingRow.rowEntity).scale = Vector3.Zero();
                            if (showBackground) {
                                Transform.getMutable(remainingRow.backgroundEntity).scale = Vector3.Zero();
                            }
                        }
                    }
                    return;
                }
            }
            for (let i = 0; i < leaderboardRows.length; i++) {
                const row = leaderboardRows[i];
                const rowData = data[i];
                if (rowData) {
                    if (!Transform.has(row.rowEntity))
                        continue;
                    Transform.getMutable(row.rowEntity).scale = Vector3.create(1, 1, 1);
                    if (showBackground) {
                        Transform.getMutable(row.backgroundEntity).scale = Vector3.create(rowWidth, rowHeight, 1);
                    }
                    const rankText = `#${i + 1}`;
                    TextShape.getMutable(row.rankEntity).text = rankText;
                    Material.setPbrMaterial(row.profileEntity, {
                        texture: Material.Texture.Avatar({
                            userId: rowData.userId,
                        }),
                    });
                    const name = rowData.name || 'Anonymous';
                    TextShape.getMutable(row.nameEntity).text = name.length > 10 ? name.slice(0, 10) : name;
                    let scoreText = '';
                    if (sortBy === 'elapsedTime') {
                        const ms = rowData.elapsedTime * 1000;
                        const seconds = Math.floor(ms / 1000);
                        const minutes = Math.floor(seconds / 60);
                        const hours = Math.floor(minutes / 60);
                        if (hours > 0) {
                            scoreText = `${hours}h ${minutes % 60}m`;
                        }
                        else if (minutes > 0) {
                            scoreText = `${minutes}m ${seconds % 60}s`;
                        }
                        else {
                            scoreText = `${seconds}s`;
                        }
                    }
                    else {
                        scoreText = rowData[sortBy]?.toString() || '0';
                    }
                    TextShape.getMutable(row.scoreEntity).text = scoreText;
                }
                else {
                    if (Transform.has(row.rowEntity)) {
                        Transform.getMutable(row.rowEntity).scale = Vector3.Zero();
                        if (showBackground) {
                            Transform.getMutable(row.backgroundEntity).scale = Vector3.Zero();
                        }
                    }
                }
            }
        }
        catch (e) {
            console.log('error updating quest leaderboard', e);
            const row = leaderboardRows[0];
            if (Transform.has(row.rowEntity)) {
                Transform.getMutable(row.rowEntity).scale = Vector3.create(1, 1, 1);
                if (showBackground) {
                    Transform.getMutable(row.backgroundEntity).scale = Vector3.create(rowWidth, rowHeight, 1);
                }
                TextShape.getMutable(row.rankEntity).text = "";
                TextShape.getMutable(row.nameEntity).text = "Error loading data";
                TextShape.getMutable(row.scoreEntity).text = "";
                Transform.getMutable(row.profileEntity).scale = Vector3.Zero();
                for (let i = 1; i < leaderboardRows.length; i++) {
                    const remainingRow = leaderboardRows[i];
                    if (Transform.has(remainingRow.rowEntity)) {
                        Transform.getMutable(remainingRow.rowEntity).scale = Vector3.Zero();
                        if (showBackground) {
                            Transform.getMutable(remainingRow.backgroundEntity).scale = Vector3.Zero();
                        }
                    }
                }
            }
        }
    }
    engine.addSystem(leaderboardUpdate);
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibGVhZGVyYm9hcmQuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi9zcmMvbGVhZGVyYm9hcmQudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUFFLE1BQU0sRUFBVSxRQUFRLEVBQUUsWUFBWSxFQUFnQyxNQUFNLGNBQWMsQ0FBQztBQUNwRyxPQUFPLEVBQUUsU0FBUyxFQUFFLFNBQVMsRUFBRSxNQUFNLGNBQWMsQ0FBQztBQUNwRCxPQUFPLEVBQUUsTUFBTSxFQUFFLE9BQU8sRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUNoRCxPQUFPLEVBQUUsU0FBUyxFQUFFLE1BQU0sa0JBQWtCLENBQUM7QUFDN0MsT0FBTyxFQUFFLEtBQUssRUFBRSxNQUFNLGVBQWUsQ0FBQztBQWV0QyxNQUFNLFVBQVUsbUJBQW1CLENBQ2pDLE9BQWMsRUFDZCxTQUF1QixFQUN2QixjQUFxQixFQUNyQixLQUFZLEVBQ1osUUFBdUIsS0FBSyxFQUM1QixTQUFnQixhQUFhLEVBQzdCLFlBQW9CLElBQUksRUFDeEIsaUJBQXlCLElBQUksRUFDN0IsUUFBZSxhQUFhO0lBRzVCLElBQUksV0FBVyxHQUFHLE1BQU0sQ0FBQyxTQUFTLEVBQUUsQ0FBQTtJQUNwQyxTQUFTLENBQUMsTUFBTSxDQUFDLFdBQVcsRUFBRSxTQUFTLENBQUMsQ0FBQTtJQUd4QyxNQUFNLFFBQVEsR0FBRyxDQUFDLENBQUE7SUFDbEIsTUFBTSxTQUFTLEdBQUcsR0FBRyxDQUFBO0lBR3JCLFNBQVMsZUFBZSxDQUFDLElBQVk7UUFDbkMsSUFBSSxJQUFJLEtBQUssYUFBYTtZQUFFLE9BQU8sTUFBTSxDQUFDO1FBQzFDLE9BQU8sSUFBSSxDQUFDLE1BQU0sQ0FBQyxDQUFDLENBQUMsQ0FBQyxXQUFXLEVBQUUsR0FBRyxJQUFJLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQyxDQUFDO0lBQ3RELENBQUM7SUFHRCxNQUFNLFdBQVcsR0FBRyxNQUFNLENBQUMsU0FBUyxFQUFFLENBQUE7SUFDdEMsU0FBUyxDQUFDLE1BQU0sQ0FBQyxXQUFXLEVBQUU7UUFDNUIsTUFBTSxFQUFFLFdBQVc7UUFDbkIsUUFBUSxFQUFFLE9BQU8sQ0FBQyxNQUFNLENBQUMsQ0FBQyxFQUFFLEdBQUcsRUFBRSxDQUFDLENBQUM7S0FDcEMsQ0FBQyxDQUFBO0lBQ0YsU0FBUyxDQUFDLE1BQU0sQ0FBQyxXQUFXLEVBQUU7UUFDNUIsSUFBSSxFQUFFLEtBQUs7UUFDWCxRQUFRLEVBQUUsR0FBRztRQUNiLFNBQVMsR0FBaUM7S0FDM0MsQ0FBQyxDQUFBO0lBR0YsTUFBTSxPQUFPLEdBQUcsQ0FBQyxHQUFHLENBQUE7SUFDcEIsTUFBTSxTQUFTLEdBQUcsQ0FBQyxDQUFBO0lBQ25CLE1BQU0sUUFBUSxHQUFHLENBQUMsQ0FBQTtJQUdsQixNQUFNLFlBQVksR0FBRyxNQUFNLENBQUMsU0FBUyxFQUFFLENBQUE7SUFDdkMsU0FBUyxDQUFDLE1BQU0sQ0FBQyxZQUFZLEVBQUU7UUFDN0IsTUFBTSxFQUFFLFdBQVc7UUFDbkIsUUFBUSxFQUFFLE9BQU8sQ0FBQyxNQUFNLENBQUMsQ0FBQyxFQUFFLEdBQUcsRUFBRSxDQUFDLENBQUM7S0FDcEMsQ0FBQyxDQUFBO0lBR0YsTUFBTSxjQUFjLEdBQUcsTUFBTSxDQUFDLFNBQVMsRUFBRSxDQUFBO0lBQ3pDLFNBQVMsQ0FBQyxNQUFNLENBQUMsY0FBYyxFQUFFO1FBQy9CLE1BQU0sRUFBRSxZQUFZO1FBQ3BCLFFBQVEsRUFBRSxPQUFPLENBQUMsTUFBTSxDQUFDLENBQUMsRUFBRSxDQUFDLEVBQUUsSUFBSSxDQUFDO1FBQ3BDLEtBQUssRUFBRSxPQUFPLENBQUMsTUFBTSxDQUFDLFFBQVEsRUFBRSxTQUFTLEVBQUUsQ0FBQyxDQUFDO0tBQzlDLENBQUMsQ0FBQTtJQUNGLFlBQVksQ0FBQyxRQUFRLENBQUMsY0FBYyxDQUFDLENBQUE7SUFDckMsUUFBUSxDQUFDLGNBQWMsQ0FBQyxjQUFjLEVBQUU7UUFDdEMsV0FBVyxFQUFFLE1BQU0sQ0FBQyxNQUFNLENBQUMsQ0FBQyxHQUFDLEdBQUcsRUFBRSxHQUFHLEdBQUMsR0FBRyxFQUFFLEdBQUcsR0FBQyxHQUFHLEVBQUMsQ0FBQyxDQUFDO0tBQ3RELENBQUMsQ0FBQTtJQUdGLE1BQU0sZ0JBQWdCLEdBQUcsTUFBTSxDQUFDLFNBQVMsRUFBRSxDQUFBO0lBQzNDLFNBQVMsQ0FBQyxNQUFNLENBQUMsZ0JBQWdCLEVBQUU7UUFDakMsTUFBTSxFQUFFLFlBQVk7UUFDcEIsUUFBUSxFQUFFLE9BQU8sQ0FBQyxNQUFNLENBQUMsT0FBTyxFQUFFLENBQUMsRUFBRSxJQUFJLENBQUM7S0FDM0MsQ0FBQyxDQUFBO0lBQ0YsU0FBUyxDQUFDLE1BQU0sQ0FBQyxnQkFBZ0IsRUFBRTtRQUNqQyxJQUFJLEVBQUUsTUFBTTtRQUNaLFFBQVEsRUFBRSxHQUFHO1FBQ2IsU0FBUyxHQUFpQztLQUMzQyxDQUFDLENBQUE7SUFFRixNQUFNLGdCQUFnQixHQUFHLE1BQU0sQ0FBQyxTQUFTLEVBQUUsQ0FBQTtJQUMzQyxTQUFTLENBQUMsTUFBTSxDQUFDLGdCQUFnQixFQUFFO1FBQ2pDLE1BQU0sRUFBRSxZQUFZO1FBQ3BCLFFBQVEsRUFBRSxPQUFPLENBQUMsTUFBTSxDQUFDLFNBQVMsR0FBRyxHQUFHLEVBQUUsQ0FBQyxFQUFFLElBQUksQ0FBQztLQUNuRCxDQUFDLENBQUE7SUFDRixTQUFTLENBQUMsTUFBTSxDQUFDLGdCQUFnQixFQUFFO1FBQ2pDLElBQUksRUFBRSxRQUFRO1FBQ2QsUUFBUSxFQUFFLEdBQUc7UUFDYixTQUFTLEdBQStCO0tBQ3pDLENBQUMsQ0FBQTtJQUVGLE1BQU0saUJBQWlCLEdBQUcsTUFBTSxDQUFDLFNBQVMsRUFBRSxDQUFBO0lBQzVDLFNBQVMsQ0FBQyxNQUFNLENBQUMsaUJBQWlCLEVBQUU7UUFDbEMsTUFBTSxFQUFFLFlBQVk7UUFDcEIsUUFBUSxFQUFFLE9BQU8sQ0FBQyxNQUFNLENBQUMsUUFBUSxFQUFFLENBQUMsRUFBRSxJQUFJLENBQUM7S0FDNUMsQ0FBQyxDQUFBO0lBQ0YsU0FBUyxDQUFDLE1BQU0sQ0FBQyxpQkFBaUIsRUFBRTtRQUNsQyxJQUFJLEVBQUUsZUFBZSxDQUFDLE1BQU0sQ0FBQztRQUM3QixRQUFRLEVBQUUsR0FBRztRQUNiLFNBQVMsR0FBaUM7S0FDM0MsQ0FBQyxDQUFBO0lBR0YsTUFBTSxlQUFlLEdBUWhCLEVBQUUsQ0FBQTtJQUdQLEtBQUksSUFBSSxDQUFDLEdBQUcsQ0FBQyxFQUFFLENBQUMsR0FBRyxLQUFLLEVBQUUsQ0FBQyxFQUFFLEVBQUMsQ0FBQztRQUU3QixNQUFNLFNBQVMsR0FBRyxNQUFNLENBQUMsU0FBUyxFQUFFLENBQUE7UUFDcEMsU0FBUyxDQUFDLE1BQU0sQ0FBQyxTQUFTLEVBQUU7WUFDMUIsTUFBTSxFQUFFLFdBQVc7WUFDbkIsUUFBUSxFQUFFLE9BQU8sQ0FBQyxNQUFNLENBQUMsQ0FBQyxFQUFFLENBQUMsQ0FBQyxHQUFHLEdBQUcsR0FBRyxHQUFHLEVBQUUsQ0FBQyxDQUFDO1NBQy9DLENBQUMsQ0FBQTtRQUdGLE1BQU0sZ0JBQWdCLEdBQUcsTUFBTSxDQUFDLFNBQVMsRUFBRSxDQUFBO1FBQzNDLElBQUksY0FBYyxFQUFFLENBQUM7WUFDbkIsU0FBUyxDQUFDLE1BQU0sQ0FBQyxnQkFBZ0IsRUFBRTtnQkFDakMsTUFBTSxFQUFFLFNBQVM7Z0JBQ2pCLFFBQVEsRUFBRSxPQUFPLENBQUMsTUFBTSxDQUFDLENBQUMsRUFBRSxDQUFDLEVBQUUsSUFBSSxDQUFDO2dCQUNwQyxLQUFLLEVBQUUsT0FBTyxDQUFDLE1BQU0sQ0FBQyxRQUFRLEVBQUUsU0FBUyxFQUFFLENBQUMsQ0FBQzthQUM5QyxDQUFDLENBQUE7WUFDRixZQUFZLENBQUMsUUFBUSxDQUFDLGdCQUFnQixDQUFDLENBQUE7WUFDdkMsUUFBUSxDQUFDLGNBQWMsQ0FBQyxnQkFBZ0IsRUFBRTtnQkFDeEMsV0FBVyxFQUFFLENBQUMsR0FBRyxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUM7b0JBQ3hCLE1BQU0sQ0FBQyxNQUFNLENBQUMsRUFBRSxHQUFDLEdBQUcsRUFBRSxFQUFFLEdBQUMsR0FBRyxFQUFDLEVBQUUsR0FBQyxHQUFHLEVBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQztvQkFDeEMsTUFBTSxDQUFDLE1BQU0sQ0FBQyxFQUFFLEdBQUMsR0FBRyxFQUFDLEVBQUUsR0FBQyxHQUFHLEVBQUUsRUFBRSxHQUFDLEdBQUcsRUFBRSxDQUFDLENBQUM7YUFDMUMsQ0FBQyxDQUFBO1FBQ0osQ0FBQzthQUFNLENBQUM7WUFDTixTQUFTLENBQUMsTUFBTSxDQUFDLGdCQUFnQixFQUFFO2dCQUNqQyxNQUFNLEVBQUUsU0FBUztnQkFDakIsS0FBSyxFQUFFLE9BQU8sQ0FBQyxJQUFJLEVBQUU7YUFDdEIsQ0FBQyxDQUFBO1FBQ0osQ0FBQztRQUdELE1BQU0sVUFBVSxHQUFHLE1BQU0sQ0FBQyxTQUFTLEVBQUUsQ0FBQTtRQUNyQyxTQUFTLENBQUMsTUFBTSxDQUFDLFVBQVUsRUFBRTtZQUMzQixNQUFNLEVBQUUsU0FBUztZQUNqQixRQUFRLEVBQUUsT0FBTyxDQUFDLE1BQU0sQ0FBQyxPQUFPLEVBQUUsQ0FBQyxFQUFFLENBQUMsQ0FBQztTQUN4QyxDQUFDLENBQUE7UUFDRixTQUFTLENBQUMsTUFBTSxDQUFDLFVBQVUsRUFBRSxFQUFDLElBQUksRUFBQyxJQUFJLENBQUMsR0FBRyxDQUFDLEVBQUUsRUFBRSxRQUFRLEVBQUMsR0FBRyxFQUFDLENBQUMsQ0FBQTtRQUc5RCxNQUFNLGFBQWEsR0FBRyxNQUFNLENBQUMsU0FBUyxFQUFFLENBQUE7UUFDeEMsU0FBUyxDQUFDLE1BQU0sQ0FBQyxhQUFhLEVBQUU7WUFDOUIsTUFBTSxFQUFFLFNBQVM7WUFDakIsUUFBUSxFQUFFLE9BQU8sQ0FBQyxNQUFNLENBQUMsU0FBUyxHQUFHLEdBQUcsRUFBRSxDQUFDLEVBQUUsQ0FBQyxDQUFDO1lBQy9DLEtBQUssRUFBRSxPQUFPLENBQUMsTUFBTSxDQUFDLEdBQUcsRUFBQyxHQUFHLEVBQUMsR0FBRyxDQUFDO1NBQ25DLENBQUMsQ0FBQTtRQUNGLFlBQVksQ0FBQyxRQUFRLENBQUMsYUFBYSxDQUFDLENBQUE7UUFDcEMsUUFBUSxDQUFDLGNBQWMsQ0FBQyxhQUFhLEVBQUU7WUFDckMsT0FBTyxFQUFFLFFBQVEsQ0FBQyxPQUFPLENBQUMsTUFBTSxDQUFDO2dCQUMvQixNQUFNLEVBQUUsRUFBRTthQUNYLENBQUM7U0FDSCxDQUFDLENBQUE7UUFHRixNQUFNLFVBQVUsR0FBRyxNQUFNLENBQUMsU0FBUyxFQUFFLENBQUE7UUFDckMsU0FBUyxDQUFDLE1BQU0sQ0FBQyxVQUFVLEVBQUU7WUFDM0IsTUFBTSxFQUFFLFNBQVM7WUFDakIsUUFBUSxFQUFFLE9BQU8sQ0FBQyxNQUFNLENBQUMsU0FBUyxHQUFHLEdBQUcsRUFBRSxDQUFDLEVBQUUsQ0FBQyxDQUFDO1NBQ2hELENBQUMsQ0FBQTtRQUNGLFNBQVMsQ0FBQyxNQUFNLENBQUMsVUFBVSxFQUFFLEVBQUMsSUFBSSxFQUFDLE1BQU0sRUFBRSxRQUFRLEVBQUMsR0FBRyxFQUFHLFNBQVMsR0FBK0IsRUFBQyxDQUFDLENBQUE7UUFHcEcsTUFBTSxXQUFXLEdBQUcsTUFBTSxDQUFDLFNBQVMsRUFBRSxDQUFBO1FBQ3RDLFNBQVMsQ0FBQyxNQUFNLENBQUMsV0FBVyxFQUFFO1lBQzVCLE1BQU0sRUFBRSxTQUFTO1lBQ2pCLFFBQVEsRUFBRSxPQUFPLENBQUMsTUFBTSxDQUFDLFFBQVEsRUFBRSxDQUFDLEVBQUUsQ0FBQyxDQUFDO1NBQ3pDLENBQUMsQ0FBQTtRQUNGLFNBQVMsQ0FBQyxNQUFNLENBQUMsV0FBVyxFQUFFLEVBQUMsSUFBSSxFQUFDLE9BQU8sRUFBRSxRQUFRLEVBQUMsR0FBRyxFQUFDLENBQUMsQ0FBQTtRQUczRCxlQUFlLENBQUMsSUFBSSxDQUFDO1lBQ25CLElBQUksRUFBRSxDQUFDLEdBQUcsQ0FBQztZQUNYLFNBQVM7WUFDVCxnQkFBZ0I7WUFDaEIsVUFBVTtZQUNWLGFBQWE7WUFDYixVQUFVO1lBQ1YsV0FBVztTQUNaLENBQUMsQ0FBQTtJQUNKLENBQUM7SUFFRCxJQUFJLElBQUksR0FBRyxDQUFDLENBQUE7SUFDWixTQUFTLGlCQUFpQixDQUFDLEVBQVM7UUFDbEMsSUFBRyxJQUFJLEdBQUcsQ0FBQyxFQUFDLENBQUM7WUFDWCxJQUFJLElBQUksRUFBRSxDQUFBO1FBQ1osQ0FBQzthQUFJLENBQUM7WUFDSixJQUFJLEdBQUcsY0FBYyxDQUFBO1lBQ3JCLHlCQUF5QixFQUFFLENBQUE7UUFDN0IsQ0FBQztJQUNILENBQUM7SUFFRCxLQUFLLFVBQVUseUJBQXlCO1FBQ3RDLElBQUcsQ0FBQztZQUVGLE1BQU0sVUFBVSxHQUFHLFNBQVMsRUFBRSxDQUFDO1lBQy9CLE1BQU0sUUFBUSxHQUFHLFVBQVUsQ0FBQyxDQUFDLENBQUMsVUFBVSxDQUFDLE1BQU0sQ0FBQyxDQUFDLENBQUMsRUFBRSxDQUFDO1lBQ3JELE1BQU0sVUFBVSxHQUFHLFVBQVUsRUFBRSxJQUFJLElBQUksS0FBSyxDQUFDO1lBWTdDLElBQUksTUFBTSxHQUFHLENBQUMsYUFBYSxTQUFTLEVBQUUsRUFBRSxTQUFTLEtBQUssRUFBRSxFQUFFLFNBQVMsS0FBSyxFQUFFLEVBQUUsVUFBVSxNQUFNLEVBQUUsQ0FBQyxDQUFBO1lBQy9GLElBQUksUUFBUSxHQUFHLE1BQU0sS0FBSyxDQUFFLEtBQUssQ0FBQyxDQUFDLENBQUMsb0NBQW9DLE9BQU8sU0FBUyxHQUFHLE1BQU0sQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQyxDQUFDLGtEQUFrRCxPQUFPLFNBQVMsR0FBRyxNQUFNLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUE7WUFDcE0sSUFBSSxJQUFJLEdBQUcsTUFBTSxRQUFRLENBQUMsSUFBSSxFQUFFLENBQUE7WUFJaEMsSUFBSSxDQUFDLElBQUksSUFBSSxJQUFJLENBQUMsTUFBTSxLQUFLLENBQUMsRUFBRSxDQUFDO2dCQUUvQixNQUFNLEdBQUcsR0FBRyxlQUFlLENBQUMsQ0FBQyxDQUFDLENBQUE7Z0JBQzlCLElBQUksU0FBUyxDQUFDLEdBQUcsQ0FBQyxHQUFHLENBQUMsU0FBUyxDQUFDLEVBQUUsQ0FBQztvQkFDakMsU0FBUyxDQUFDLFVBQVUsQ0FBQyxHQUFHLENBQUMsU0FBUyxDQUFDLENBQUMsS0FBSyxHQUFHLE9BQU8sQ0FBQyxNQUFNLENBQUMsQ0FBQyxFQUFFLENBQUMsRUFBRSxDQUFDLENBQUMsQ0FBQTtvQkFFbkUsSUFBSSxjQUFjLEVBQUUsQ0FBQzt3QkFDbkIsU0FBUyxDQUFDLFVBQVUsQ0FBQyxHQUFHLENBQUMsZ0JBQWdCLENBQUMsQ0FBQyxLQUFLLEdBQUcsT0FBTyxDQUFDLE1BQU0sQ0FBQyxRQUFRLEVBQUUsU0FBUyxFQUFFLENBQUMsQ0FBQyxDQUFBO29CQUMzRixDQUFDO29CQUVELFNBQVMsQ0FBQyxVQUFVLENBQUMsR0FBRyxDQUFDLFVBQVUsQ0FBQyxDQUFDLElBQUksR0FBRyxFQUFFLENBQUE7b0JBQzlDLFNBQVMsQ0FBQyxVQUFVLENBQUMsR0FBRyxDQUFDLFVBQVUsQ0FBQyxDQUFDLElBQUksR0FBRyxtQkFBbUIsQ0FBQTtvQkFDL0QsU0FBUyxDQUFDLFVBQVUsQ0FBQyxHQUFHLENBQUMsV0FBVyxDQUFDLENBQUMsSUFBSSxHQUFHLEVBQUUsQ0FBQTtvQkFHL0MsU0FBUyxDQUFDLFVBQVUsQ0FBQyxHQUFHLENBQUMsYUFBYSxDQUFDLENBQUMsS0FBSyxHQUFHLE9BQU8sQ0FBQyxJQUFJLEVBQUUsQ0FBQTtvQkFHOUQsS0FBSyxJQUFJLENBQUMsR0FBRyxDQUFDLEVBQUUsQ0FBQyxHQUFHLGVBQWUsQ0FBQyxNQUFNLEVBQUUsQ0FBQyxFQUFFLEVBQUUsQ0FBQzt3QkFDaEQsTUFBTSxZQUFZLEdBQUcsZUFBZSxDQUFDLENBQUMsQ0FBQyxDQUFBO3dCQUN2QyxJQUFJLFNBQVMsQ0FBQyxHQUFHLENBQUMsWUFBWSxDQUFDLFNBQVMsQ0FBQyxFQUFFLENBQUM7NEJBQzFDLFNBQVMsQ0FBQyxVQUFVLENBQUMsWUFBWSxDQUFDLFNBQVMsQ0FBQyxDQUFDLEtBQUssR0FBRyxPQUFPLENBQUMsSUFBSSxFQUFFLENBQUE7NEJBQ25FLElBQUksY0FBYyxFQUFFLENBQUM7Z0NBQ25CLFNBQVMsQ0FBQyxVQUFVLENBQUMsWUFBWSxDQUFDLGdCQUFnQixDQUFDLENBQUMsS0FBSyxHQUFHLE9BQU8sQ0FBQyxJQUFJLEVBQUUsQ0FBQTs0QkFDNUUsQ0FBQzt3QkFDSCxDQUFDO29CQUNILENBQUM7b0JBQ0QsT0FBTTtnQkFDUixDQUFDO1lBQ0gsQ0FBQztZQUdELEtBQUksSUFBSSxDQUFDLEdBQUcsQ0FBQyxFQUFFLENBQUMsR0FBRyxlQUFlLENBQUMsTUFBTSxFQUFFLENBQUMsRUFBRSxFQUFFLENBQUM7Z0JBQy9DLE1BQU0sR0FBRyxHQUFHLGVBQWUsQ0FBQyxDQUFDLENBQUMsQ0FBQTtnQkFDOUIsTUFBTSxPQUFPLEdBQUcsSUFBSSxDQUFDLENBQUMsQ0FBQyxDQUFBO2dCQUV2QixJQUFJLE9BQU8sRUFBRSxDQUFDO29CQUVaLElBQUksQ0FBQyxTQUFTLENBQUMsR0FBRyxDQUFDLEdBQUcsQ0FBQyxTQUFTLENBQUM7d0JBQUUsU0FBUTtvQkFHM0MsU0FBUyxDQUFDLFVBQVUsQ0FBQyxHQUFHLENBQUMsU0FBUyxDQUFDLENBQUMsS0FBSyxHQUFHLE9BQU8sQ0FBQyxNQUFNLENBQUMsQ0FBQyxFQUFFLENBQUMsRUFBRSxDQUFDLENBQUMsQ0FBQTtvQkFHbkUsSUFBSSxjQUFjLEVBQUUsQ0FBQzt3QkFDbkIsU0FBUyxDQUFDLFVBQVUsQ0FBQyxHQUFHLENBQUMsZ0JBQWdCLENBQUMsQ0FBQyxLQUFLLEdBQUcsT0FBTyxDQUFDLE1BQU0sQ0FBQyxRQUFRLEVBQUUsU0FBUyxFQUFFLENBQUMsQ0FBQyxDQUFBO29CQUMzRixDQUFDO29CQUdELE1BQU0sUUFBUSxHQUFHLElBQUksQ0FBQyxHQUFHLENBQUMsRUFBRSxDQUFBO29CQUM1QixTQUFTLENBQUMsVUFBVSxDQUFDLEdBQUcsQ0FBQyxVQUFVLENBQUMsQ0FBQyxJQUFJLEdBQUcsUUFBUSxDQUFBO29CQUVwRCxRQUFRLENBQUMsY0FBYyxDQUFDLEdBQUcsQ0FBQyxhQUFhLEVBQUU7d0JBQ3pDLE9BQU8sRUFBRSxRQUFRLENBQUMsT0FBTyxDQUFDLE1BQU0sQ0FBQzs0QkFDL0IsTUFBTSxFQUFFLE9BQU8sQ0FBQyxNQUFNO3lCQUN2QixDQUFDO3FCQUNILENBQUMsQ0FBQTtvQkFHRixNQUFNLElBQUksR0FBRyxPQUFPLENBQUMsSUFBSSxJQUFJLFdBQVcsQ0FBQTtvQkFDeEMsU0FBUyxDQUFDLFVBQVUsQ0FBQyxHQUFHLENBQUMsVUFBVSxDQUFDLENBQUMsSUFBSSxHQUFHLElBQUksQ0FBQyxNQUFNLEdBQUcsRUFBRSxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDLENBQUMsRUFBRSxFQUFFLENBQUMsQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUFBO29CQUd2RixJQUFJLFNBQVMsR0FBRyxFQUFFLENBQUE7b0JBQ2xCLElBQUksTUFBTSxLQUFLLGFBQWEsRUFBRSxDQUFDO3dCQUU3QixNQUFNLEVBQUUsR0FBRyxPQUFPLENBQUMsV0FBVyxHQUFHLElBQUksQ0FBQTt3QkFDckMsTUFBTSxPQUFPLEdBQUcsSUFBSSxDQUFDLEtBQUssQ0FBQyxFQUFFLEdBQUcsSUFBSSxDQUFDLENBQUE7d0JBQ3JDLE1BQU0sT0FBTyxHQUFHLElBQUksQ0FBQyxLQUFLLENBQUMsT0FBTyxHQUFHLEVBQUUsQ0FBQyxDQUFBO3dCQUN4QyxNQUFNLEtBQUssR0FBRyxJQUFJLENBQUMsS0FBSyxDQUFDLE9BQU8sR0FBRyxFQUFFLENBQUMsQ0FBQTt3QkFFdEMsSUFBSSxLQUFLLEdBQUcsQ0FBQyxFQUFFLENBQUM7NEJBQ2QsU0FBUyxHQUFHLEdBQUcsS0FBSyxLQUFLLE9BQU8sR0FBRyxFQUFFLEdBQUcsQ0FBQTt3QkFDMUMsQ0FBQzs2QkFBTSxJQUFJLE9BQU8sR0FBRyxDQUFDLEVBQUUsQ0FBQzs0QkFDdkIsU0FBUyxHQUFHLEdBQUcsT0FBTyxLQUFLLE9BQU8sR0FBRyxFQUFFLEdBQUcsQ0FBQTt3QkFDNUMsQ0FBQzs2QkFBTSxDQUFDOzRCQUNOLFNBQVMsR0FBRyxHQUFHLE9BQU8sR0FBRyxDQUFBO3dCQUMzQixDQUFDO29CQUNILENBQUM7eUJBQU0sQ0FBQzt3QkFFTixTQUFTLEdBQUcsT0FBTyxDQUFDLE1BQU0sQ0FBQyxFQUFFLFFBQVEsRUFBRSxJQUFJLEdBQUcsQ0FBQTtvQkFDaEQsQ0FBQztvQkFFRCxTQUFTLENBQUMsVUFBVSxDQUFDLEdBQUcsQ0FBQyxXQUFXLENBQUMsQ0FBQyxJQUFJLEdBQUcsU0FBUyxDQUFBO2dCQUN4RCxDQUFDO3FCQUFNLENBQUM7b0JBRU4sSUFBSSxTQUFTLENBQUMsR0FBRyxDQUFDLEdBQUcsQ0FBQyxTQUFTLENBQUMsRUFBRSxDQUFDO3dCQUNqQyxTQUFTLENBQUMsVUFBVSxDQUFDLEdBQUcsQ0FBQyxTQUFTLENBQUMsQ0FBQyxLQUFLLEdBQUcsT0FBTyxDQUFDLElBQUksRUFBRSxDQUFBO3dCQUcxRCxJQUFJLGNBQWMsRUFBRSxDQUFDOzRCQUNuQixTQUFTLENBQUMsVUFBVSxDQUFDLEdBQUcsQ0FBQyxnQkFBZ0IsQ0FBQyxDQUFDLEtBQUssR0FBRyxPQUFPLENBQUMsSUFBSSxFQUFFLENBQUE7d0JBQ25FLENBQUM7b0JBQ0gsQ0FBQztnQkFDSCxDQUFDO1lBQ0gsQ0FBQztRQUNILENBQUM7UUFBQyxPQUFNLENBQUssRUFBRSxDQUFDO1lBQ2QsT0FBTyxDQUFDLEdBQUcsQ0FBQyxrQ0FBa0MsRUFBRSxDQUFDLENBQUMsQ0FBQTtZQUVsRCxNQUFNLEdBQUcsR0FBRyxlQUFlLENBQUMsQ0FBQyxDQUFDLENBQUE7WUFDOUIsSUFBSSxTQUFTLENBQUMsR0FBRyxDQUFDLEdBQUcsQ0FBQyxTQUFTLENBQUMsRUFBRSxDQUFDO2dCQUNqQyxTQUFTLENBQUMsVUFBVSxDQUFDLEdBQUcsQ0FBQyxTQUFTLENBQUMsQ0FBQyxLQUFLLEdBQUcsT0FBTyxDQUFDLE1BQU0sQ0FBQyxDQUFDLEVBQUUsQ0FBQyxFQUFFLENBQUMsQ0FBQyxDQUFBO2dCQUVuRSxJQUFJLGNBQWMsRUFBRSxDQUFDO29CQUNuQixTQUFTLENBQUMsVUFBVSxDQUFDLEdBQUcsQ0FBQyxnQkFBZ0IsQ0FBQyxDQUFDLEtBQUssR0FBRyxPQUFPLENBQUMsTUFBTSxDQUFDLFFBQVEsRUFBRSxTQUFTLEVBQUUsQ0FBQyxDQUFDLENBQUE7Z0JBQzNGLENBQUM7Z0JBRUQsU0FBUyxDQUFDLFVBQVUsQ0FBQyxHQUFHLENBQUMsVUFBVSxDQUFDLENBQUMsSUFBSSxHQUFHLEVBQUUsQ0FBQTtnQkFDOUMsU0FBUyxDQUFDLFVBQVUsQ0FBQyxHQUFHLENBQUMsVUFBVSxDQUFDLENBQUMsSUFBSSxHQUFHLG9CQUFvQixDQUFBO2dCQUNoRSxTQUFTLENBQUMsVUFBVSxDQUFDLEdBQUcsQ0FBQyxXQUFXLENBQUMsQ0FBQyxJQUFJLEdBQUcsRUFBRSxDQUFBO2dCQUcvQyxTQUFTLENBQUMsVUFBVSxDQUFDLEdBQUcsQ0FBQyxhQUFhLENBQUMsQ0FBQyxLQUFLLEdBQUcsT0FBTyxDQUFDLElBQUksRUFBRSxDQUFBO2dCQUc5RCxLQUFLLElBQUksQ0FBQyxHQUFHLENBQUMsRUFBRSxDQUFDLEdBQUcsZUFBZSxDQUFDLE1BQU0sRUFBRSxDQUFDLEVBQUUsRUFBRSxDQUFDO29CQUNoRCxNQUFNLFlBQVksR0FBRyxlQUFlLENBQUMsQ0FBQyxDQUFDLENBQUE7b0JBQ3ZDLElBQUksU0FBUyxDQUFDLEdBQUcsQ0FBQyxZQUFZLENBQUMsU0FBUyxDQUFDLEVBQUUsQ0FBQzt3QkFDMUMsU0FBUyxDQUFDLFVBQVUsQ0FBQyxZQUFZLENBQUMsU0FBUyxDQUFDLENBQUMsS0FBSyxHQUFHLE9BQU8sQ0FBQyxJQUFJLEVBQUUsQ0FBQTt3QkFDbkUsSUFBSSxjQUFjLEVBQUUsQ0FBQzs0QkFDbkIsU0FBUyxDQUFDLFVBQVUsQ0FBQyxZQUFZLENBQUMsZ0JBQWdCLENBQUMsQ0FBQyxLQUFLLEdBQUcsT0FBTyxDQUFDLElBQUksRUFBRSxDQUFBO3dCQUM1RSxDQUFDO29CQUNILENBQUM7Z0JBQ0gsQ0FBQztZQUNILENBQUM7UUFDSCxDQUFDO0lBQ0gsQ0FBQztJQUVELE1BQU0sQ0FBQyxTQUFTLENBQUMsaUJBQWlCLENBQUMsQ0FBQTtBQUdyQyxDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgZW5naW5lLCBFbnRpdHksIE1hdGVyaWFsLCBNZXNoUmVuZGVyZXIsIFRleHRBbGlnbk1vZGUsIFRyYW5zZm9ybVR5cGUgfSBmcm9tIFwiQGRjbC9zZGsvZWNzXCI7XG5pbXBvcnQgeyBUZXh0U2hhcGUsIFRyYW5zZm9ybSB9IGZyb20gXCJAZGNsL3Nkay9lY3NcIjtcbmltcG9ydCB7IENvbG9yNCwgVmVjdG9yMyB9IGZyb20gXCJAZGNsL3Nkay9tYXRoXCI7XG5pbXBvcnQgeyBnZXRQbGF5ZXIgfSBmcm9tIFwiQGRjbC9zZGsvcGxheWVyc1wiO1xuaW1wb3J0IHsgREVCVUcgfSBmcm9tIFwiLi9kZWZpbml0aW9uc1wiO1xuXG5cbi8qKlxuICogXG4gKiBAcGFyYW0gcXVlc3RJZCBcbiAqIEBwYXJhbSBwb3NpdGlvbiBcbiAqIEBwYXJhbSB1cGRhdGVJbnRlcnZhbCBcbiAqIEBwYXJhbSBsaW1pdCBcbiAqIEBwYXJhbSBvcmRlciBcbiAqIEBwYXJhbSBzb3J0QnkgXG4gKiBAcGFyYW0gY29tcGxldGVkIFxuICogQHBhcmFtIHNob3dCYWNrZ3JvdW5kXG4gKiBAcGFyYW0gdGl0bGVcbiAqL1xuZXhwb3J0IGZ1bmN0aW9uIExTQ1F1ZXN0TGVhZGVyYm9hcmQoXG4gIHF1ZXN0SWQ6c3RyaW5nLCBcbiAgdHJhbnNmb3JtOlRyYW5zZm9ybVR5cGUsIFxuICB1cGRhdGVJbnRlcnZhbDpudW1iZXIsXG4gIGxpbWl0Om51bWJlcixcbiAgb3JkZXI6ICdhc2MnIHwgJ2FzYycgPSAnYXNjJyxcbiAgc29ydEJ5OnN0cmluZyA9ICdlbGFwc2VkVGltZScsXG4gIGNvbXBsZXRlZDpib29sZWFuID0gdHJ1ZSxcbiAgc2hvd0JhY2tncm91bmQ6Ym9vbGVhbiA9IHRydWUsXG4gIHRpdGxlOnN0cmluZyA9IFwiTGVhZGVyYm9hcmRcIlxuICApe1xuICAgIFxuICBsZXQgbGVhZGVyYm9hcmQgPSBlbmdpbmUuYWRkRW50aXR5KClcbiAgVHJhbnNmb3JtLmNyZWF0ZShsZWFkZXJib2FyZCwgdHJhbnNmb3JtKVxuICBcbiAgLy8gUm93IGRpbWVuc2lvbnNcbiAgY29uc3Qgcm93V2lkdGggPSAzXG4gIGNvbnN0IHJvd0hlaWdodCA9IDAuNFxuICBcbiAgLy8gSGVscGVyIGZ1bmN0aW9uIHRvIGZvcm1hdCB0aGUgc2NvcmUgdHlwZSBmb3IgZGlzcGxheVxuICBmdW5jdGlvbiBmb3JtYXRTY29yZVR5cGUodHlwZTogc3RyaW5nKTogc3RyaW5nIHtcbiAgICBpZiAodHlwZSA9PT0gJ2VsYXBzZWRUaW1lJykgcmV0dXJuICdUaW1lJztcbiAgICByZXR1cm4gdHlwZS5jaGFyQXQoMCkudG9VcHBlckNhc2UoKSArIHR5cGUuc2xpY2UoMSk7IC8vIENhcGl0YWxpemUgZmlyc3QgbGV0dGVyXG4gIH1cbiAgXG4gIC8vIENyZWF0ZSB0aXRsZVxuICBjb25zdCB0aXRsZUVudGl0eSA9IGVuZ2luZS5hZGRFbnRpdHkoKVxuICBUcmFuc2Zvcm0uY3JlYXRlKHRpdGxlRW50aXR5LCB7XG4gICAgcGFyZW50OiBsZWFkZXJib2FyZCxcbiAgICBwb3NpdGlvbjogVmVjdG9yMy5jcmVhdGUoMCwgMC42LCAwKVxuICB9KVxuICBUZXh0U2hhcGUuY3JlYXRlKHRpdGxlRW50aXR5LCB7XG4gICAgdGV4dDogdGl0bGUsXG4gICAgZm9udFNpemU6IDIuNSxcbiAgICB0ZXh0QWxpZ246IFRleHRBbGlnbk1vZGUuVEFNX01JRERMRV9DRU5URVJcbiAgfSlcbiAgXG4gIC8vIFJvdyBwb3NpdGlvbnMgKGNlbnRlcmVkKVxuICBjb25zdCBsZWZ0UG9zID0gLTEuM1xuICBjb25zdCBjZW50ZXJQb3MgPSAwXG4gIGNvbnN0IHJpZ2h0UG9zID0gMVxuICBcbiAgLy8gQ3JlYXRlIGhlYWRlciByb3dcbiAgY29uc3QgaGVhZGVyRW50aXR5ID0gZW5naW5lLmFkZEVudGl0eSgpXG4gIFRyYW5zZm9ybS5jcmVhdGUoaGVhZGVyRW50aXR5LCB7XG4gICAgcGFyZW50OiBsZWFkZXJib2FyZCxcbiAgICBwb3NpdGlvbjogVmVjdG9yMy5jcmVhdGUoMCwgMC4yLCAwKVxuICB9KVxuICBcbiAgLy8gSGVhZGVyIGJhY2tncm91bmRcbiAgY29uc3QgaGVhZGVyQmdFbnRpdHkgPSBlbmdpbmUuYWRkRW50aXR5KClcbiAgVHJhbnNmb3JtLmNyZWF0ZShoZWFkZXJCZ0VudGl0eSwge1xuICAgIHBhcmVudDogaGVhZGVyRW50aXR5LFxuICAgIHBvc2l0aW9uOiBWZWN0b3IzLmNyZWF0ZSgwLCAwLCAwLjAzKSxcbiAgICBzY2FsZTogVmVjdG9yMy5jcmVhdGUocm93V2lkdGgsIHJvd0hlaWdodCwgMSlcbiAgfSlcbiAgTWVzaFJlbmRlcmVyLnNldFBsYW5lKGhlYWRlckJnRW50aXR5KVxuICBNYXRlcmlhbC5zZXRQYnJNYXRlcmlhbChoZWFkZXJCZ0VudGl0eSwge1xuICAgIGFsYmVkb0NvbG9yOiBDb2xvcjQuY3JlYXRlKDAvMjU1LCAyNTUvMjU1LCAyMTMvMjU1LDEpXG4gIH0pXG4gIFxuICAvLyBIZWFkZXIgbGFiZWxzXG4gIGNvbnN0IHJhbmtIZWFkZXJFbnRpdHkgPSBlbmdpbmUuYWRkRW50aXR5KClcbiAgVHJhbnNmb3JtLmNyZWF0ZShyYW5rSGVhZGVyRW50aXR5LCB7XG4gICAgcGFyZW50OiBoZWFkZXJFbnRpdHksXG4gICAgcG9zaXRpb246IFZlY3RvcjMuY3JlYXRlKGxlZnRQb3MsIDAsIDAuMDIpXG4gIH0pXG4gIFRleHRTaGFwZS5jcmVhdGUocmFua0hlYWRlckVudGl0eSwge1xuICAgIHRleHQ6IFwiUmFua1wiLFxuICAgIGZvbnRTaXplOiAxLjUsXG4gICAgdGV4dEFsaWduOiBUZXh0QWxpZ25Nb2RlLlRBTV9NSURETEVfQ0VOVEVSXG4gIH0pXG4gIFxuICBjb25zdCBuYW1lSGVhZGVyRW50aXR5ID0gZW5naW5lLmFkZEVudGl0eSgpXG4gIFRyYW5zZm9ybS5jcmVhdGUobmFtZUhlYWRlckVudGl0eSwge1xuICAgIHBhcmVudDogaGVhZGVyRW50aXR5LFxuICAgIHBvc2l0aW9uOiBWZWN0b3IzLmNyZWF0ZShjZW50ZXJQb3MgLSAwLjQsIDAsIDAuMDIpXG4gIH0pXG4gIFRleHRTaGFwZS5jcmVhdGUobmFtZUhlYWRlckVudGl0eSwge1xuICAgIHRleHQ6IFwiUGxheWVyXCIsXG4gICAgZm9udFNpemU6IDEuNSxcbiAgICB0ZXh0QWxpZ246IFRleHRBbGlnbk1vZGUuVEFNX01JRERMRV9MRUZUXG4gIH0pXG4gIFxuICBjb25zdCBzY29yZUhlYWRlckVudGl0eSA9IGVuZ2luZS5hZGRFbnRpdHkoKVxuICBUcmFuc2Zvcm0uY3JlYXRlKHNjb3JlSGVhZGVyRW50aXR5LCB7XG4gICAgcGFyZW50OiBoZWFkZXJFbnRpdHksXG4gICAgcG9zaXRpb246IFZlY3RvcjMuY3JlYXRlKHJpZ2h0UG9zLCAwLCAwLjAyKVxuICB9KVxuICBUZXh0U2hhcGUuY3JlYXRlKHNjb3JlSGVhZGVyRW50aXR5LCB7XG4gICAgdGV4dDogZm9ybWF0U2NvcmVUeXBlKHNvcnRCeSksXG4gICAgZm9udFNpemU6IDEuNSxcbiAgICB0ZXh0QWxpZ246IFRleHRBbGlnbk1vZGUuVEFNX01JRERMRV9DRU5URVJcbiAgfSlcbiAgXG4gIC8vIEFycmF5IHRvIHN0b3JlIHJlZmVyZW5jZXMgdG8gYWxsIGxlYWRlcmJvYXJkIGVudGl0aWVzXG4gIGNvbnN0IGxlYWRlcmJvYXJkUm93czogQXJyYXk8e1xuICAgIHJhbms6IG51bWJlcixcbiAgICByb3dFbnRpdHk6IEVudGl0eSxcbiAgICBiYWNrZ3JvdW5kRW50aXR5OiBFbnRpdHksXG4gICAgcmFua0VudGl0eTogRW50aXR5LFxuICAgIHByb2ZpbGVFbnRpdHk6IEVudGl0eSxcbiAgICBuYW1lRW50aXR5OiBFbnRpdHksXG4gICAgc2NvcmVFbnRpdHk6IEVudGl0eVxuICB9PiA9IFtdXG5cbiAgLy8gQ3JlYXRlIHBsYWNlaG9sZGVyIHJvd3NcbiAgZm9yKGxldCBpID0gMDsgaSA8IGxpbWl0OyBpKyspe1xuICAgIC8vIENyZWF0ZSByb3cgY29udGFpbmVyIGVudGl0eVxuICAgIGNvbnN0IHJvd0VudGl0eSA9IGVuZ2luZS5hZGRFbnRpdHkoKVxuICAgIFRyYW5zZm9ybS5jcmVhdGUocm93RW50aXR5LCB7XG4gICAgICBwYXJlbnQ6IGxlYWRlcmJvYXJkLFxuICAgICAgcG9zaXRpb246IFZlY3RvcjMuY3JlYXRlKDAsIC1pICogMC41IC0gMC4yLCAwKVxuICAgIH0pXG4gIFxuICAgIC8vIENyZWF0ZSBiYWNrZ3JvdW5kIGVudGl0eVxuICAgIGNvbnN0IGJhY2tncm91bmRFbnRpdHkgPSBlbmdpbmUuYWRkRW50aXR5KClcbiAgICBpZiAoc2hvd0JhY2tncm91bmQpIHtcbiAgICAgIFRyYW5zZm9ybS5jcmVhdGUoYmFja2dyb3VuZEVudGl0eSwge1xuICAgICAgICBwYXJlbnQ6IHJvd0VudGl0eSxcbiAgICAgICAgcG9zaXRpb246IFZlY3RvcjMuY3JlYXRlKDAsIDAsIDAuMDEpLFxuICAgICAgICBzY2FsZTogVmVjdG9yMy5jcmVhdGUocm93V2lkdGgsIHJvd0hlaWdodCwgMSlcbiAgICAgIH0pXG4gICAgICBNZXNoUmVuZGVyZXIuc2V0UGxhbmUoYmFja2dyb3VuZEVudGl0eSlcbiAgICAgIE1hdGVyaWFsLnNldFBick1hdGVyaWFsKGJhY2tncm91bmRFbnRpdHksIHtcbiAgICAgICAgYWxiZWRvQ29sb3I6IGkgJSAyID09PSAwID8gXG4gICAgICAgICAgQ29sb3I0LmNyZWF0ZSgxOC8yNTUsIDIzLzI1NSwzNy8yNTUsMSkgOlxuICAgICAgICAgIENvbG9yNC5jcmVhdGUoMjYvMjU1LDM0LzI1NSwgNTMvMjU1LCAxKVxuICAgICAgfSlcbiAgICB9IGVsc2Uge1xuICAgICAgVHJhbnNmb3JtLmNyZWF0ZShiYWNrZ3JvdW5kRW50aXR5LCB7XG4gICAgICAgIHBhcmVudDogcm93RW50aXR5LFxuICAgICAgICBzY2FsZTogVmVjdG9yMy5aZXJvKClcbiAgICAgIH0pXG4gICAgfVxuXG4gICAgLy8gQ3JlYXRlIHJhbmsgZW50aXR5ICgjMSwgIzIsIGV0Yy4pXG4gICAgY29uc3QgcmFua0VudGl0eSA9IGVuZ2luZS5hZGRFbnRpdHkoKVxuICAgIFRyYW5zZm9ybS5jcmVhdGUocmFua0VudGl0eSwge1xuICAgICAgcGFyZW50OiByb3dFbnRpdHksXG4gICAgICBwb3NpdGlvbjogVmVjdG9yMy5jcmVhdGUobGVmdFBvcywgMCwgMClcbiAgICB9KVxuICAgIFRleHRTaGFwZS5jcmVhdGUocmFua0VudGl0eSwge3RleHQ6YCMke2kgKyAxfWAsIGZvbnRTaXplOjEuNX0pXG5cbiAgICAvLyBDcmVhdGUgcHJvZmlsZSBpbWFnZSBlbnRpdHlcbiAgICBjb25zdCBwcm9maWxlRW50aXR5ID0gZW5naW5lLmFkZEVudGl0eSgpXG4gICAgVHJhbnNmb3JtLmNyZWF0ZShwcm9maWxlRW50aXR5LCB7XG4gICAgICBwYXJlbnQ6IHJvd0VudGl0eSxcbiAgICAgIHBvc2l0aW9uOiBWZWN0b3IzLmNyZWF0ZShjZW50ZXJQb3MgLSAwLjgsIDAsIDApLFxuICAgICAgc2NhbGU6IFZlY3RvcjMuY3JlYXRlKDAuMywwLjMsMC4zKVxuICAgIH0pXG4gICAgTWVzaFJlbmRlcmVyLnNldFBsYW5lKHByb2ZpbGVFbnRpdHkpXG4gICAgTWF0ZXJpYWwuc2V0UGJyTWF0ZXJpYWwocHJvZmlsZUVudGl0eSwge1xuICAgICAgdGV4dHVyZTogTWF0ZXJpYWwuVGV4dHVyZS5BdmF0YXIoe1xuICAgICAgICB1c2VySWQ6ICcnLFxuICAgICAgfSksXG4gICAgfSlcblxuICAgIC8vIENyZWF0ZSBuYW1lIGVudGl0eVxuICAgIGNvbnN0IG5hbWVFbnRpdHkgPSBlbmdpbmUuYWRkRW50aXR5KClcbiAgICBUcmFuc2Zvcm0uY3JlYXRlKG5hbWVFbnRpdHksIHtcbiAgICAgIHBhcmVudDogcm93RW50aXR5LFxuICAgICAgcG9zaXRpb246IFZlY3RvcjMuY3JlYXRlKGNlbnRlclBvcyAtIDAuNCwgMCwgMClcbiAgICB9KVxuICAgIFRleHRTaGFwZS5jcmVhdGUobmFtZUVudGl0eSwge3RleHQ6YE5hbWVgLCBmb250U2l6ZToxLjUsICB0ZXh0QWxpZ246IFRleHRBbGlnbk1vZGUuVEFNX01JRERMRV9MRUZUfSlcblxuICAgIC8vIENyZWF0ZSBzY29yZSBlbnRpdHlcbiAgICBjb25zdCBzY29yZUVudGl0eSA9IGVuZ2luZS5hZGRFbnRpdHkoKVxuICAgIFRyYW5zZm9ybS5jcmVhdGUoc2NvcmVFbnRpdHksIHtcbiAgICAgIHBhcmVudDogcm93RW50aXR5LFxuICAgICAgcG9zaXRpb246IFZlY3RvcjMuY3JlYXRlKHJpZ2h0UG9zLCAwLCAwKVxuICAgIH0pXG4gICAgVGV4dFNoYXBlLmNyZWF0ZShzY29yZUVudGl0eSwge3RleHQ6YFNjb3JlYCwgZm9udFNpemU6MS41fSlcblxuICAgIC8vIFN0b3JlIHJlZmVyZW5jZXMgdG8gYWxsIGVudGl0aWVzXG4gICAgbGVhZGVyYm9hcmRSb3dzLnB1c2goe1xuICAgICAgcmFuazogaSArIDEsXG4gICAgICByb3dFbnRpdHksXG4gICAgICBiYWNrZ3JvdW5kRW50aXR5LFxuICAgICAgcmFua0VudGl0eSxcbiAgICAgIHByb2ZpbGVFbnRpdHksXG4gICAgICBuYW1lRW50aXR5LFxuICAgICAgc2NvcmVFbnRpdHlcbiAgICB9KVxuICB9XG5cbiAgbGV0IHRpbWUgPSAwXG4gIGZ1bmN0aW9uIGxlYWRlcmJvYXJkVXBkYXRlKGR0Om51bWJlcil7XG4gICAgaWYodGltZSA+IDApe1xuICAgICAgdGltZSAtPSBkdFxuICAgIH1lbHNle1xuICAgICAgdGltZSA9IHVwZGF0ZUludGVydmFsXG4gICAgICB1cGRhdGVMU0NRdWVzdExlYWRlcmJvYXJkKClcbiAgICB9XG4gIH1cblxuICBhc3luYyBmdW5jdGlvbiB1cGRhdGVMU0NRdWVzdExlYWRlcmJvYXJkKCl7XG4gICAgdHJ5e1xuICAgICAgLy8gR2V0IGN1cnJlbnQgcGxheWVyIGluZm9ybWF0aW9uIGZpcnN0XG4gICAgICBjb25zdCBwbGF5ZXJEYXRhID0gZ2V0UGxheWVyKCk7XG4gICAgICBjb25zdCBwbGF5ZXJJRCA9IHBsYXllckRhdGEgPyBwbGF5ZXJEYXRhLnVzZXJJZCA6ICcnO1xuICAgICAgY29uc3QgcGxheWVyTmFtZSA9IHBsYXllckRhdGE/Lm5hbWUgfHwgJ1lvdSc7XG4gICAgICBcbiAgICAgIC8vIERlZmluZSB0aGUgdXNlciBkYXRhIGludGVyZmFjZVxuICAgICAgaW50ZXJmYWNlIFVzZXJEYXRhIHtcbiAgICAgICAgdXNlcklkOiBzdHJpbmc7XG4gICAgICAgIG5hbWU6IHN0cmluZztcbiAgICAgICAgZWxhcHNlZFRpbWU6IG51bWJlcjtcbiAgICAgICAgY29tcGxldGVkOiBib29sZWFuO1xuICAgICAgICBba2V5OiBzdHJpbmddOiBhbnk7IC8vIEFsbG93IGZvciBkeW5hbWljIHByb3BlcnRpZXMgLy9cbiAgICAgIH1cbiAgICAgIFxuICAgICAgLy8gR2V0IGxlYWRlcmJvYXJkIGRhdGEgZnJvbSBBUElcbiAgICAgIGxldCBwYXJhbXMgPSBbYGNvbXBsZXRlZD0ke2NvbXBsZXRlZH1gLCBgb3JkZXI9JHtvcmRlcn1gLCBgbGltaXQ9JHtsaW1pdH1gLCBgc29ydEJ5PSR7c29ydEJ5fWBdXG4gICAgICBsZXQgcmVzcG9uc2UgPSBhd2FpdCBmZXRjaCggREVCVUcgPyBgaHR0cDovL2xvY2FsaG9zdDo1MzUzL2FwaS9xdWVzdHMvJHtxdWVzdElkfS91c2Vycz9gICsgcGFyYW1zLmpvaW4oJyYnKSA6IGBodHRwczovL2FuZ3phYXItcGxhemEuZGNsLWl3Yi5jby93cy9hcGkvcXVlc3RzLyR7cXVlc3RJZH0vdXNlcnM/YCArIHBhcmFtcy5qb2luKCcmJykpIFxuICAgICAgbGV0IGRhdGEgPSBhd2FpdCByZXNwb25zZS5qc29uKClcbiAgICAgIC8vIGNvbnNvbGUubG9nKCdsZWFkZXJib2FyZCBkYXRhOicsIGRhdGEpO1xuICAgICAgXG4gICAgICAvLyBDaGVjayBpZiBkYXRhIGlzIGVtcHR5XG4gICAgICBpZiAoIWRhdGEgfHwgZGF0YS5sZW5ndGggPT09IDApIHtcbiAgICAgICAgLy8gU2hvdyBcIm5vIGRhdGFcIiBtZXNzYWdlIGluIHRoZSBmaXJzdCByb3dcbiAgICAgICAgY29uc3Qgcm93ID0gbGVhZGVyYm9hcmRSb3dzWzBdXG4gICAgICAgIGlmIChUcmFuc2Zvcm0uaGFzKHJvdy5yb3dFbnRpdHkpKSB7XG4gICAgICAgICAgVHJhbnNmb3JtLmdldE11dGFibGUocm93LnJvd0VudGl0eSkuc2NhbGUgPSBWZWN0b3IzLmNyZWF0ZSgxLCAxLCAxKVxuICAgICAgICAgIFxuICAgICAgICAgIGlmIChzaG93QmFja2dyb3VuZCkge1xuICAgICAgICAgICAgVHJhbnNmb3JtLmdldE11dGFibGUocm93LmJhY2tncm91bmRFbnRpdHkpLnNjYWxlID0gVmVjdG9yMy5jcmVhdGUocm93V2lkdGgsIHJvd0hlaWdodCwgMSlcbiAgICAgICAgICB9XG4gICAgICAgICAgXG4gICAgICAgICAgVGV4dFNoYXBlLmdldE11dGFibGUocm93LnJhbmtFbnRpdHkpLnRleHQgPSBcIlwiXG4gICAgICAgICAgVGV4dFNoYXBlLmdldE11dGFibGUocm93Lm5hbWVFbnRpdHkpLnRleHQgPSBcIk5vIGRhdGEgYXZhaWxhYmxlXCJcbiAgICAgICAgICBUZXh0U2hhcGUuZ2V0TXV0YWJsZShyb3cuc2NvcmVFbnRpdHkpLnRleHQgPSBcIlwiXG4gICAgICAgICAgXG4gICAgICAgICAgLy8gSGlkZSBwcm9maWxlIGltYWdlXG4gICAgICAgICAgVHJhbnNmb3JtLmdldE11dGFibGUocm93LnByb2ZpbGVFbnRpdHkpLnNjYWxlID0gVmVjdG9yMy5aZXJvKClcbiAgICAgICAgICBcbiAgICAgICAgICAvLyBIaWRlIHJlbWFpbmluZyByb3dzXG4gICAgICAgICAgZm9yIChsZXQgaSA9IDE7IGkgPCBsZWFkZXJib2FyZFJvd3MubGVuZ3RoOyBpKyspIHtcbiAgICAgICAgICAgIGNvbnN0IHJlbWFpbmluZ1JvdyA9IGxlYWRlcmJvYXJkUm93c1tpXVxuICAgICAgICAgICAgaWYgKFRyYW5zZm9ybS5oYXMocmVtYWluaW5nUm93LnJvd0VudGl0eSkpIHtcbiAgICAgICAgICAgICAgVHJhbnNmb3JtLmdldE11dGFibGUocmVtYWluaW5nUm93LnJvd0VudGl0eSkuc2NhbGUgPSBWZWN0b3IzLlplcm8oKVxuICAgICAgICAgICAgICBpZiAoc2hvd0JhY2tncm91bmQpIHtcbiAgICAgICAgICAgICAgICBUcmFuc2Zvcm0uZ2V0TXV0YWJsZShyZW1haW5pbmdSb3cuYmFja2dyb3VuZEVudGl0eSkuc2NhbGUgPSBWZWN0b3IzLlplcm8oKVxuICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgICAgfVxuICAgICAgICAgIHJldHVyblxuICAgICAgICB9XG4gICAgICB9XG4gICAgICBcbiAgICAgIC8vIFVwZGF0ZSBsZWFkZXJib2FyZCB3aXRoIGRhdGFcbiAgICAgIGZvcihsZXQgaSA9IDA7IGkgPCBsZWFkZXJib2FyZFJvd3MubGVuZ3RoOyBpKyspIHtcbiAgICAgICAgY29uc3Qgcm93ID0gbGVhZGVyYm9hcmRSb3dzW2ldXG4gICAgICAgIGNvbnN0IHJvd0RhdGEgPSBkYXRhW2ldXG4gICAgICAgIFxuICAgICAgICBpZiAocm93RGF0YSkge1xuICAgICAgICAgIC8vIFNob3cgdGhpcyByb3cgYW5kIHVwZGF0ZSB3aXRoIHVzZXIgZGF0YVxuICAgICAgICAgIGlmICghVHJhbnNmb3JtLmhhcyhyb3cucm93RW50aXR5KSkgY29udGludWVcbiAgICAgICAgICBcbiAgICAgICAgICAvLyBNYWtlIHJvdyB2aXNpYmxlXG4gICAgICAgICAgVHJhbnNmb3JtLmdldE11dGFibGUocm93LnJvd0VudGl0eSkuc2NhbGUgPSBWZWN0b3IzLmNyZWF0ZSgxLCAxLCAxKVxuICAgICAgICAgIFxuICAgICAgICAgIC8vIE9ubHkgdXBkYXRlIGJhY2tncm91bmQgaWYgaXQncyBlbmFibGVkXG4gICAgICAgICAgaWYgKHNob3dCYWNrZ3JvdW5kKSB7XG4gICAgICAgICAgICBUcmFuc2Zvcm0uZ2V0TXV0YWJsZShyb3cuYmFja2dyb3VuZEVudGl0eSkuc2NhbGUgPSBWZWN0b3IzLmNyZWF0ZShyb3dXaWR0aCwgcm93SGVpZ2h0LCAxKVxuICAgICAgICAgIH1cbiAgICAgICAgICBcbiAgICAgICAgICAvLyBTZXQgdXNlciByYW5rICgjMSwgIzIsIGV0Yy4pXG4gICAgICAgICAgY29uc3QgcmFua1RleHQgPSBgIyR7aSArIDF9YFxuICAgICAgICAgIFRleHRTaGFwZS5nZXRNdXRhYmxlKHJvdy5yYW5rRW50aXR5KS50ZXh0ID0gcmFua1RleHRcblxuICAgICAgICAgIE1hdGVyaWFsLnNldFBick1hdGVyaWFsKHJvdy5wcm9maWxlRW50aXR5LCB7XG4gICAgICAgICAgICB0ZXh0dXJlOiBNYXRlcmlhbC5UZXh0dXJlLkF2YXRhcih7XG4gICAgICAgICAgICAgIHVzZXJJZDogcm93RGF0YS51c2VySWQsXG4gICAgICAgICAgICB9KSxcbiAgICAgICAgICB9KVxuICAgICAgICAgIFxuICAgICAgICAgIC8vIFNldCB1c2VyIG5hbWVcbiAgICAgICAgICBjb25zdCBuYW1lID0gcm93RGF0YS5uYW1lIHx8ICdBbm9ueW1vdXMnXG4gICAgICAgICAgVGV4dFNoYXBlLmdldE11dGFibGUocm93Lm5hbWVFbnRpdHkpLnRleHQgPSBuYW1lLmxlbmd0aCA+IDEwID8gbmFtZS5zbGljZSgwLCAxMCkgOiBuYW1lXG4gICAgICAgICAgXG4gICAgICAgICAgLy8gU2V0IHVzZXIgc2NvcmUgKHRpbWUsIHByb2dyZXNzLCBldGMuKVxuICAgICAgICAgIGxldCBzY29yZVRleHQgPSAnJ1xuICAgICAgICAgIGlmIChzb3J0QnkgPT09ICdlbGFwc2VkVGltZScpIHtcbiAgICAgICAgICAgIC8vIEZvcm1hdCB0aW1lIGRpc3BsYXlcbiAgICAgICAgICAgIGNvbnN0IG1zID0gcm93RGF0YS5lbGFwc2VkVGltZSAqIDEwMDBcbiAgICAgICAgICAgIGNvbnN0IHNlY29uZHMgPSBNYXRoLmZsb29yKG1zIC8gMTAwMClcbiAgICAgICAgICAgIGNvbnN0IG1pbnV0ZXMgPSBNYXRoLmZsb29yKHNlY29uZHMgLyA2MClcbiAgICAgICAgICAgIGNvbnN0IGhvdXJzID0gTWF0aC5mbG9vcihtaW51dGVzIC8gNjApXG4gICAgICAgICAgICBcbiAgICAgICAgICAgIGlmIChob3VycyA+IDApIHtcbiAgICAgICAgICAgICAgc2NvcmVUZXh0ID0gYCR7aG91cnN9aCAke21pbnV0ZXMgJSA2MH1tYFxuICAgICAgICAgICAgfSBlbHNlIGlmIChtaW51dGVzID4gMCkge1xuICAgICAgICAgICAgICBzY29yZVRleHQgPSBgJHttaW51dGVzfW0gJHtzZWNvbmRzICUgNjB9c2BcbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgIHNjb3JlVGV4dCA9IGAke3NlY29uZHN9c2BcbiAgICAgICAgICAgIH1cbiAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgLy8gRm9yIG90aGVyIHNjb3JlIHR5cGVzXG4gICAgICAgICAgICBzY29yZVRleHQgPSByb3dEYXRhW3NvcnRCeV0/LnRvU3RyaW5nKCkgfHwgJzAnXG4gICAgICAgICAgfVxuXG4gICAgICAgICAgVGV4dFNoYXBlLmdldE11dGFibGUocm93LnNjb3JlRW50aXR5KS50ZXh0ID0gc2NvcmVUZXh0XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgLy8gSGlkZSB0aGlzIHJvdyBhcyB0aGVyZSdzIG5vIGRhdGFcbiAgICAgICAgICBpZiAoVHJhbnNmb3JtLmhhcyhyb3cucm93RW50aXR5KSkge1xuICAgICAgICAgICAgVHJhbnNmb3JtLmdldE11dGFibGUocm93LnJvd0VudGl0eSkuc2NhbGUgPSBWZWN0b3IzLlplcm8oKVxuICAgICAgICAgICAgXG4gICAgICAgICAgICAvLyBPbmx5IHVwZGF0ZSBiYWNrZ3JvdW5kIGlmIGl0J3MgZW5hYmxlZFxuICAgICAgICAgICAgaWYgKHNob3dCYWNrZ3JvdW5kKSB7XG4gICAgICAgICAgICAgIFRyYW5zZm9ybS5nZXRNdXRhYmxlKHJvdy5iYWNrZ3JvdW5kRW50aXR5KS5zY2FsZSA9IFZlY3RvcjMuWmVybygpXG4gICAgICAgICAgICB9XG4gICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICB9XG4gICAgfSBjYXRjaChlOmFueSkge1xuICAgICAgY29uc29sZS5sb2coJ2Vycm9yIHVwZGF0aW5nIHF1ZXN0IGxlYWRlcmJvYXJkJywgZSlcbiAgICAgIC8vIFNob3cgZXJyb3IgbWVzc2FnZSBpbiB0aGUgZmlyc3Qgcm93XG4gICAgICBjb25zdCByb3cgPSBsZWFkZXJib2FyZFJvd3NbMF1cbiAgICAgIGlmIChUcmFuc2Zvcm0uaGFzKHJvdy5yb3dFbnRpdHkpKSB7XG4gICAgICAgIFRyYW5zZm9ybS5nZXRNdXRhYmxlKHJvdy5yb3dFbnRpdHkpLnNjYWxlID0gVmVjdG9yMy5jcmVhdGUoMSwgMSwgMSlcbiAgICAgICAgXG4gICAgICAgIGlmIChzaG93QmFja2dyb3VuZCkge1xuICAgICAgICAgIFRyYW5zZm9ybS5nZXRNdXRhYmxlKHJvdy5iYWNrZ3JvdW5kRW50aXR5KS5zY2FsZSA9IFZlY3RvcjMuY3JlYXRlKHJvd1dpZHRoLCByb3dIZWlnaHQsIDEpXG4gICAgICAgIH1cbiAgICAgICAgXG4gICAgICAgIFRleHRTaGFwZS5nZXRNdXRhYmxlKHJvdy5yYW5rRW50aXR5KS50ZXh0ID0gXCJcIlxuICAgICAgICBUZXh0U2hhcGUuZ2V0TXV0YWJsZShyb3cubmFtZUVudGl0eSkudGV4dCA9IFwiRXJyb3IgbG9hZGluZyBkYXRhXCJcbiAgICAgICAgVGV4dFNoYXBlLmdldE11dGFibGUocm93LnNjb3JlRW50aXR5KS50ZXh0ID0gXCJcIlxuICAgICAgICBcbiAgICAgICAgLy8gSGlkZSBwcm9maWxlIGltYWdlXG4gICAgICAgIFRyYW5zZm9ybS5nZXRNdXRhYmxlKHJvdy5wcm9maWxlRW50aXR5KS5zY2FsZSA9IFZlY3RvcjMuWmVybygpXG4gICAgICAgIFxuICAgICAgICAvLyBIaWRlIHJlbWFpbmluZyByb3dzXG4gICAgICAgIGZvciAobGV0IGkgPSAxOyBpIDwgbGVhZGVyYm9hcmRSb3dzLmxlbmd0aDsgaSsrKSB7XG4gICAgICAgICAgY29uc3QgcmVtYWluaW5nUm93ID0gbGVhZGVyYm9hcmRSb3dzW2ldXG4gICAgICAgICAgaWYgKFRyYW5zZm9ybS5oYXMocmVtYWluaW5nUm93LnJvd0VudGl0eSkpIHtcbiAgICAgICAgICAgIFRyYW5zZm9ybS5nZXRNdXRhYmxlKHJlbWFpbmluZ1Jvdy5yb3dFbnRpdHkpLnNjYWxlID0gVmVjdG9yMy5aZXJvKClcbiAgICAgICAgICAgIGlmIChzaG93QmFja2dyb3VuZCkge1xuICAgICAgICAgICAgICBUcmFuc2Zvcm0uZ2V0TXV0YWJsZShyZW1haW5pbmdSb3cuYmFja2dyb3VuZEVudGl0eSkuc2NhbGUgPSBWZWN0b3IzLlplcm8oKVxuICAgICAgICAgICAgfVxuICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgfVxuICAgIH1cbiAgfVxuXG4gIGVuZ2luZS5hZGRTeXN0ZW0obGVhZGVyYm9hcmRVcGRhdGUpXG5cbiAgLy8gUmVhY3RFY3NSZW5kZXJlci5zZXRVaVJlbmRlcmVyKHVpQ29tcG9uZW50KVxufSJdfQ==