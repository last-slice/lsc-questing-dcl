import { engine, Material, MeshRenderer } from "@dcl/sdk/ecs";
import { TextShape, Transform } from "@dcl/sdk/ecs";
import { Color4, Vector3 } from "@dcl/sdk/math";
import { getPlayer } from "@dcl/sdk/players";
import { DEBUG } from "./definitions";
export function LSCQuestLeaderboard(questId, transform, updateInterval, limit, order = 'asc', sortBy = 'elapsedTime', completed = true, showBackground = true, title = "Leaderboard") {
    let leaderboard = engine.addEntity();
    Transform.create(leaderboard, transform);
    const rowWidth = 3;
    const rowHeight = 0.4;
    function formatScoreType(type) {
        if (type === 'elapsedTime')
            return 'Time';
        if (type === 'progress')
            return 'Progress';
        return type.charAt(0).toUpperCase() + type.slice(1);
    }
    const titleEntity = engine.addEntity();
    Transform.create(titleEntity, {
        parent: leaderboard,
        position: Vector3.create(0, 0.6, 0)
    });
    TextShape.create(titleEntity, {
        text: title,
        fontSize: 2.5,
        textAlign: 4
    });
    const leftPos = -1.3;
    const centerPos = 0;
    const rightPos = 1;
    const headerEntity = engine.addEntity();
    Transform.create(headerEntity, {
        parent: leaderboard,
        position: Vector3.create(0, 0.2, 0)
    });
    const headerBgEntity = engine.addEntity();
    Transform.create(headerBgEntity, {
        parent: headerEntity,
        position: Vector3.create(0, 0, 0.03),
        scale: Vector3.create(rowWidth, rowHeight, 1)
    });
    MeshRenderer.setPlane(headerBgEntity);
    Material.setPbrMaterial(headerBgEntity, {
        albedoColor: Color4.create(0 / 255, 255 / 255, 213 / 255, 1)
    });
    const rankHeaderEntity = engine.addEntity();
    Transform.create(rankHeaderEntity, {
        parent: headerEntity,
        position: Vector3.create(leftPos, 0, 0.02)
    });
    TextShape.create(rankHeaderEntity, {
        text: "Rank",
        fontSize: 1.5,
        textAlign: 4
    });
    const nameHeaderEntity = engine.addEntity();
    Transform.create(nameHeaderEntity, {
        parent: headerEntity,
        position: Vector3.create(centerPos - 0.4, 0, 0.02)
    });
    TextShape.create(nameHeaderEntity, {
        text: "Player",
        fontSize: 1.5,
        textAlign: 3
    });
    const scoreHeaderEntity = engine.addEntity();
    Transform.create(scoreHeaderEntity, {
        parent: headerEntity,
        position: Vector3.create(rightPos, 0, 0.02)
    });
    TextShape.create(scoreHeaderEntity, {
        text: formatScoreType(sortBy),
        fontSize: 1.5,
        textAlign: 4
    });
    const leaderboardRows = [];
    for (let i = 0; i < limit; i++) {
        const rowEntity = engine.addEntity();
        Transform.create(rowEntity, {
            parent: leaderboard,
            position: Vector3.create(0, -i * 0.5 - 0.2, 0)
        });
        const backgroundEntity = engine.addEntity();
        if (showBackground) {
            Transform.create(backgroundEntity, {
                parent: rowEntity,
                position: Vector3.create(0, 0, 0.01),
                scale: Vector3.create(rowWidth, rowHeight, 1)
            });
            MeshRenderer.setPlane(backgroundEntity);
            Material.setPbrMaterial(backgroundEntity, {
                albedoColor: i % 2 === 0 ?
                    Color4.create(18 / 255, 23 / 255, 37 / 255, 1) :
                    Color4.create(26 / 255, 34 / 255, 53 / 255, 1)
            });
        }
        else {
            Transform.create(backgroundEntity, {
                parent: rowEntity,
                scale: Vector3.Zero()
            });
        }
        const rankEntity = engine.addEntity();
        Transform.create(rankEntity, {
            parent: rowEntity,
            position: Vector3.create(leftPos, 0, 0)
        });
        TextShape.create(rankEntity, { text: `#${i + 1}`, fontSize: 1.5 });
        const profileEntity = engine.addEntity();
        Transform.create(profileEntity, {
            parent: rowEntity,
            position: Vector3.create(centerPos - 0.8, 0, 0),
            scale: Vector3.create(0.3, 0.3, 0.3)
        });
        MeshRenderer.setPlane(profileEntity);
        Material.setPbrMaterial(profileEntity, {
            texture: Material.Texture.Avatar({
                userId: '',
            }),
        });
        const nameEntity = engine.addEntity();
        Transform.create(nameEntity, {
            parent: rowEntity,
            position: Vector3.create(centerPos - 0.4, 0, 0)
        });
        TextShape.create(nameEntity, { text: `Name`, fontSize: 1.5, textAlign: 3 });
        const scoreEntity = engine.addEntity();
        Transform.create(scoreEntity, {
            parent: rowEntity,
            position: Vector3.create(rightPos, 0, 0)
        });
        TextShape.create(scoreEntity, { text: `Score`, fontSize: 1.5 });
        leaderboardRows.push({
            rank: i + 1,
            rowEntity,
            backgroundEntity,
            rankEntity,
            profileEntity,
            nameEntity,
            scoreEntity
        });
    }
    let time = 0;
    function leaderboardUpdate(dt) {
        if (time > 0) {
            time -= dt;
        }
        else {
            time = updateInterval;
            updateLSCQuestLeaderboard();
        }
    }
    async function updateLSCQuestLeaderboard() {
        try {
            const playerData = getPlayer();
            const playerID = playerData ? playerData.userId : '';
            const playerName = playerData?.name || 'You';
            let params = [`completed=${completed}`, `orderBy=${order}`, `limit=${limit}`, `sortBy=${sortBy}`];
            let response = await fetch(DEBUG ? `http://localhost:5353/api/quests/${questId}/users?` + params.join('&') : `https://angzaar-plaza.dcl-iwb.co/ws/api/quests/${questId}/users?` + params.join('&'));
            let data = await response.json();
            console.log('leaderboard data:', data);
            if (!data || data.length === 0) {
                const row = leaderboardRows[0];
                if (Transform.has(row.rowEntity)) {
                    Transform.getMutable(row.rowEntity).scale = Vector3.create(1, 1, 1);
                    if (showBackground) {
                        Transform.getMutable(row.backgroundEntity).scale = Vector3.create(rowWidth, rowHeight, 1);
                    }
                    TextShape.getMutable(row.rankEntity).text = "";
                    TextShape.getMutable(row.nameEntity).text = "No data available";
                    TextShape.getMutable(row.scoreEntity).text = "";
                    Transform.getMutable(row.profileEntity).scale = Vector3.Zero();
                    for (let i = 1; i < leaderboardRows.length; i++) {
                        const remainingRow = leaderboardRows[i];
                        if (Transform.has(remainingRow.rowEntity)) {
                            Transform.getMutable(remainingRow.rowEntity).scale = Vector3.Zero();
                            if (showBackground) {
                                Transform.getMutable(remainingRow.backgroundEntity).scale = Vector3.Zero();
                            }
                        }
                    }
                    return;
                }
            }
            for (let i = 0; i < leaderboardRows.length; i++) {
                const row = leaderboardRows[i];
                const rowData = data[i];
                if (rowData) {
                    if (!Transform.has(row.rowEntity))
                        continue;
                    Transform.getMutable(row.rowEntity).scale = Vector3.create(1, 1, 1);
                    if (showBackground) {
                        Transform.getMutable(row.backgroundEntity).scale = Vector3.create(rowWidth, rowHeight, 1);
                    }
                    const rankText = `#${i + 1}`;
                    TextShape.getMutable(row.rankEntity).text = rankText;
                    Material.setPbrMaterial(row.profileEntity, {
                        texture: Material.Texture.Avatar({
                            userId: rowData.userId,
                        }),
                    });
                    const name = rowData.name || 'Anonymous';
                    TextShape.getMutable(row.nameEntity).text = name.length > 10 ? name.slice(0, 10) : name;
                    let scoreText = '';
                    if (sortBy === 'elapsedTime') {
                        const ms = rowData.elapsedTime * 1000;
                        const seconds = Math.floor(ms / 1000);
                        const minutes = Math.floor(seconds / 60);
                        const hours = Math.floor(minutes / 60);
                        if (hours > 0) {
                            scoreText = `${hours}h ${minutes % 60}m`;
                        }
                        else if (minutes > 0) {
                            scoreText = `${minutes}m ${seconds % 60}s`;
                        }
                        else {
                            scoreText = `${seconds}s`;
                        }
                    }
                    else if (sortBy === 'progress') {
                        scoreText = `${rowData.progress || 0}%`;
                    }
                    else {
                        scoreText = rowData[sortBy]?.toString() || '0';
                    }
                    TextShape.getMutable(row.scoreEntity).text = scoreText;
                }
                else {
                    if (Transform.has(row.rowEntity)) {
                        Transform.getMutable(row.rowEntity).scale = Vector3.Zero();
                        if (showBackground) {
                            Transform.getMutable(row.backgroundEntity).scale = Vector3.Zero();
                        }
                    }
                }
            }
        }
        catch (e) {
            console.log('error updating quest leaderboard', e);
            const row = leaderboardRows[0];
            if (Transform.has(row.rowEntity)) {
                Transform.getMutable(row.rowEntity).scale = Vector3.create(1, 1, 1);
                if (showBackground) {
                    Transform.getMutable(row.backgroundEntity).scale = Vector3.create(rowWidth, rowHeight, 1);
                }
                TextShape.getMutable(row.rankEntity).text = "";
                TextShape.getMutable(row.nameEntity).text = "Error loading data";
                TextShape.getMutable(row.scoreEntity).text = "";
                Transform.getMutable(row.profileEntity).scale = Vector3.Zero();
                for (let i = 1; i < leaderboardRows.length; i++) {
                    const remainingRow = leaderboardRows[i];
                    if (Transform.has(remainingRow.rowEntity)) {
                        Transform.getMutable(remainingRow.rowEntity).scale = Vector3.Zero();
                        if (showBackground) {
                            Transform.getMutable(remainingRow.backgroundEntity).scale = Vector3.Zero();
                        }
                    }
                }
            }
        }
    }
    engine.addSystem(leaderboardUpdate);
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibGVhZGVyYm9hcmQuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi9zcmMvbGVhZGVyYm9hcmQudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUFFLE1BQU0sRUFBVSxRQUFRLEVBQUUsWUFBWSxFQUFnQyxNQUFNLGNBQWMsQ0FBQztBQUNwRyxPQUFPLEVBQUUsU0FBUyxFQUFFLFNBQVMsRUFBRSxNQUFNLGNBQWMsQ0FBQztBQUNwRCxPQUFPLEVBQUUsTUFBTSxFQUFFLE9BQU8sRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUNoRCxPQUFPLEVBQUUsU0FBUyxFQUFFLE1BQU0sa0JBQWtCLENBQUM7QUFDN0MsT0FBTyxFQUFFLEtBQUssRUFBRSxNQUFNLGVBQWUsQ0FBQztBQWV0QyxNQUFNLFVBQVUsbUJBQW1CLENBQ2pDLE9BQWMsRUFDZCxTQUF1QixFQUN2QixjQUFxQixFQUNyQixLQUFZLEVBQ1osUUFBd0IsS0FBSyxFQUM3QixTQUFnQixhQUFhLEVBQzdCLFlBQW9CLElBQUksRUFDeEIsaUJBQXlCLElBQUksRUFDN0IsUUFBZSxhQUFhO0lBRzVCLElBQUksV0FBVyxHQUFHLE1BQU0sQ0FBQyxTQUFTLEVBQUUsQ0FBQTtJQUNwQyxTQUFTLENBQUMsTUFBTSxDQUFDLFdBQVcsRUFBRSxTQUFTLENBQUMsQ0FBQTtJQUd4QyxNQUFNLFFBQVEsR0FBRyxDQUFDLENBQUE7SUFDbEIsTUFBTSxTQUFTLEdBQUcsR0FBRyxDQUFBO0lBR3JCLFNBQVMsZUFBZSxDQUFDLElBQVk7UUFDbkMsSUFBSSxJQUFJLEtBQUssYUFBYTtZQUFFLE9BQU8sTUFBTSxDQUFDO1FBQzFDLElBQUksSUFBSSxLQUFLLFVBQVU7WUFBRSxPQUFPLFVBQVUsQ0FBQztRQUMzQyxPQUFPLElBQUksQ0FBQyxNQUFNLENBQUMsQ0FBQyxDQUFDLENBQUMsV0FBVyxFQUFFLEdBQUcsSUFBSSxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUMsQ0FBQztJQUN0RCxDQUFDO0lBR0Qs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QUksRUFBRSxDQUFBO3dCQUM1RSxDQUFDO29CQUNILENBQUM7Z0JBQ0gsQ0FBQztZQUNILENBQUM7UUFDSCxDQUFDO0lBQ0gsQ0FBQztJQUVELE1BQU0sQ0FBQyxTQUFTLENBQUMsaUJBQWlCLENBQUMsQ0FBQTtBQUdyQyxDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgZW5naW5lLCBFbnRpdHksIE1hdGVyaWFsLCBNZXNoUmVuZGVyZXIsIFRleHRBbGlnbk1vZGUsIFRyYW5zZm9ybVR5cGUgfSBmcm9tIFwiQGRjbC9zZGsvZWNzXCI7XG5pbXBvcnQgeyBUZXh0U2hhcGUsIFRyYW5zZm9ybSB9IGZyb20gXCJAZGNsL3Nkay9lY3NcIjtcbmltcG9ydCB7IENvbG9yNCwgVmVjdG9yMyB9IGZyb20gXCJAZGNsL3Nkay9tYXRoXCI7XG5pbXBvcnQgeyBnZXRQbGF5ZXIgfSBmcm9tIFwiQGRjbC9zZGsvcGxheWVyc1wiO1xuaW1wb3J0IHsgREVCVUcgfSBmcm9tIFwiLi9kZWZpbml0aW9uc1wiO1xuXG5cbi8qKlxuICogXG4gKiBAcGFyYW0gcXVlc3RJZCBcbiAqIEBwYXJhbSBwb3NpdGlvbiBcbiAqIEBwYXJhbSB1cGRhdGVJbnRlcnZhbCBcbiAqIEBwYXJhbSBsaW1pdCBcbiAqIEBwYXJhbSBvcmRlciBcbiAqIEBwYXJhbSBzb3J0QnkgXG4gKiBAcGFyYW0gY29tcGxldGVkIFxuICogQHBhcmFtIHNob3dCYWNrZ3JvdW5kXG4gKiBAcGFyYW0gdGl0bGVcbiAqL1xuZXhwb3J0IGZ1bmN0aW9uIExTQ1F1ZXN0TGVhZGVyYm9hcmQoXG4gIHF1ZXN0SWQ6c3RyaW5nLCBcbiAgdHJhbnNmb3JtOlRyYW5zZm9ybVR5cGUsIFxuICB1cGRhdGVJbnRlcnZhbDpudW1iZXIsXG4gIGxpbWl0Om51bWJlcixcbiAgb3JkZXI6ICdhc2MnIHwgJ2Rlc2MnID0gJ2FzYycsXG4gIHNvcnRCeTpzdHJpbmcgPSAnZWxhcHNlZFRpbWUnLFxuICBjb21wbGV0ZWQ6Ym9vbGVhbiA9IHRydWUsXG4gIHNob3dCYWNrZ3JvdW5kOmJvb2xlYW4gPSB0cnVlLFxuICB0aXRsZTpzdHJpbmcgPSBcIkxlYWRlcmJvYXJkXCJcbiAgKXtcbiAgICBcbiAgbGV0IGxlYWRlcmJvYXJkID0gZW5naW5lLmFkZEVudGl0eSgpXG4gIFRyYW5zZm9ybS5jcmVhdGUobGVhZGVyYm9hcmQsIHRyYW5zZm9ybSlcbiAgXG4gIC8vIFJvdyBkaW1lbnNpb25zXG4gIGNvbnN0IHJvd1dpZHRoID0gM1xuICBjb25zdCByb3dIZWlnaHQgPSAwLjRcbiAgXG4gIC8vIEhlbHBlciBmdW5jdGlvbiB0byBmb3JtYXQgdGhlIHNjb3JlIHR5cGUgZm9yIGRpc3BsYXlcbiAgZnVuY3Rpb24gZm9ybWF0U2NvcmVUeXBlKHR5cGU6IHN0cmluZyk6IHN0cmluZyB7XG4gICAgaWYgKHR5cGUgPT09ICdlbGFwc2VkVGltZScpIHJldHVybiAnVGltZSc7XG4gICAgaWYgKHR5cGUgPT09ICdwcm9ncmVzcycpIHJldHVybiAnUHJvZ3Jlc3MnO1xuICAgIHJldHVybiB0eXBlLmNoYXJBdCgwKS50b1VwcGVyQ2FzZSgpICsgdHlwZS5zbGljZSgxKTsgLy8gQ2FwaXRhbGl6ZSBmaXJzdCBsZXR0ZXJcbiAgfVxuICBcbiAgLy8gQ3JlYXRlIHRpdGxlXG4gIGNvbnN0IHRpdGxlRW50aXR5ID0gZW5naW5lLmFkZEVudGl0eSgpXG4gIFRyYW5zZm9ybS5jcmVhdGUodGl0bGVFbnRpdHksIHtcbiAgICBwYXJlbnQ6IGxlYWRlcmJvYXJkLFxuICAgIHBvc2l0aW9uOiBWZWN0b3IzLmNyZWF0ZSgwLCAwLjYsIDApXG4gIH0pXG4gIFRleHRTaGFwZS5jcmVhdGUodGl0bGVFbnRpdHksIHtcbiAgICB0ZXh0OiB0aXRsZSxcbiAgICBmb250U2l6ZTogMi41LFxuICAgIHRleHRBbGlnbjogVGV4dEFsaWduTW9kZS5UQU1fTUlERExFX0NFTlRFUlxuICB9KVxuICBcbiAgLy8gUm93IHBvc2l0aW9ucyAoY2VudGVyZWQpXG4gIGNvbnN0IGxlZnRQb3MgPSAtMS4zXG4gIGNvbnN0IGNlbnRlclBvcyA9IDBcbiAgY29uc3QgcmlnaHRQb3MgPSAxXG4gIFxuICAvLyBDcmVhdGUgaGVhZGVyIHJvd1xuICBjb25zdCBoZWFkZXJFbnRpdHkgPSBlbmdpbmUuYWRkRW50aXR5KClcbiAgVHJhbnNmb3JtLmNyZWF0ZShoZWFkZXJFbnRpdHksIHtcbiAgICBwYXJlbnQ6IGxlYWRlcmJvYXJkLFxuICAgIHBvc2l0aW9uOiBWZWN0b3IzLmNyZWF0ZSgwLCAwLjIsIDApXG4gIH0pXG4gIFxuICAvLyBIZWFkZXIgYmFja2dyb3VuZFxuICBjb25zdCBoZWFkZXJCZ0VudGl0eSA9IGVuZ2luZS5hZGRFbnRpdHkoKVxuICBUcmFuc2Zvcm0uY3JlYXRlKGhlYWRlckJnRW50aXR5LCB7XG4gICAgcGFyZW50OiBoZWFkZXJFbnRpdHksXG4gICAgcG9zaXRpb246IFZlY3RvcjMuY3JlYXRlKDAsIDAsIDAuMDMpLFxuICAgIHNjYWxlOiBWZWN0b3IzLmNyZWF0ZShyb3dXaWR0aCwgcm93SGVpZ2h0LCAxKVxuICB9KVxuICBNZXNoUmVuZGVyZXIuc2V0UGxhbmUoaGVhZGVyQmdFbnRpdHkpXG4gIE1hdGVyaWFsLnNldFBick1hdGVyaWFsKGhlYWRlckJnRW50aXR5LCB7XG4gICAgYWxiZWRvQ29sb3I6IENvbG9yNC5jcmVhdGUoMC8yNTUsIDI1NS8yNTUsIDIxMy8yNTUsMSlcbiAgfSlcbiAgXG4gIC8vIEhlYWRlciBsYWJlbHNcbiAgY29uc3QgcmFua0hlYWRlckVudGl0eSA9IGVuZ2luZS5hZGRFbnRpdHkoKVxuICBUcmFuc2Zvcm0uY3JlYXRlKHJhbmtIZWFkZXJFbnRpdHksIHtcbiAgICBwYXJlbnQ6IGhlYWRlckVudGl0eSxcbiAgICBwb3NpdGlvbjogVmVjdG9yMy5jcmVhdGUobGVmdFBvcywgMCwgMC4wMilcbiAgfSlcbiAgVGV4dFNoYXBlLmNyZWF0ZShyYW5rSGVhZGVyRW50aXR5LCB7XG4gICAgdGV4dDogXCJSYW5rXCIsXG4gICAgZm9udFNpemU6IDEuNSxcbiAgICB0ZXh0QWxpZ246IFRleHRBbGlnbk1vZGUuVEFNX01JRERMRV9DRU5URVJcbiAgfSlcbiAgXG4gIGNvbnN0IG5hbWVIZWFkZXJFbnRpdHkgPSBlbmdpbmUuYWRkRW50aXR5KClcbiAgVHJhbnNmb3JtLmNyZWF0ZShuYW1lSGVhZGVyRW50aXR5LCB7XG4gICAgcGFyZW50OiBoZWFkZXJFbnRpdHksXG4gICAgcG9zaXRpb246IFZlY3RvcjMuY3JlYXRlKGNlbnRlclBvcyAtIDAuNCwgMCwgMC4wMilcbiAgfSlcbiAgVGV4dFNoYXBlLmNyZWF0ZShuYW1lSGVhZGVyRW50aXR5LCB7XG4gICAgdGV4dDogXCJQbGF5ZXJcIixcbiAgICBmb250U2l6ZTogMS41LFxuICAgIHRleHRBbGlnbjogVGV4dEFsaWduTW9kZS5UQU1fTUlERExFX0xFRlRcbiAgfSlcbiAgXG4gIGNvbnN0IHNjb3JlSGVhZGVyRW50aXR5ID0gZW5naW5lLmFkZEVudGl0eSgpXG4gIFRyYW5zZm9ybS5jcmVhdGUoc2NvcmVIZWFkZXJFbnRpdHksIHtcbiAgICBwYXJlbnQ6IGhlYWRlckVudGl0eSxcbiAgICBwb3NpdGlvbjogVmVjdG9yMy5jcmVhdGUocmlnaHRQb3MsIDAsIDAuMDIpXG4gIH0pXG4gIFRleHRTaGFwZS5jcmVhdGUoc2NvcmVIZWFkZXJFbnRpdHksIHtcbiAgICB0ZXh0OiBmb3JtYXRTY29yZVR5cGUoc29ydEJ5KSxcbiAgICBmb250U2l6ZTogMS41LFxuICAgIHRleHRBbGlnbjogVGV4dEFsaWduTW9kZS5UQU1fTUlERExFX0NFTlRFUlxuICB9KVxuICBcbiAgLy8gQXJyYXkgdG8gc3RvcmUgcmVmZXJlbmNlcyB0byBhbGwgbGVhZGVyYm9hcmQgZW50aXRpZXNcbiAgY29uc3QgbGVhZGVyYm9hcmRSb3dzOiBBcnJheTx7XG4gICAgcmFuazogbnVtYmVyLFxuICAgIHJvd0VudGl0eTogRW50aXR5LFxuICAgIGJhY2tncm91bmRFbnRpdHk6IEVudGl0eSxcbiAgICByYW5rRW50aXR5OiBFbnRpdHksXG4gICAgcHJvZmlsZUVudGl0eTogRW50aXR5LFxuICAgIG5hbWVFbnRpdHk6IEVudGl0eSxcbiAgICBzY29yZUVudGl0eTogRW50aXR5XG4gIH0+ID0gW11cblxuICAvLyBDcmVhdGUgcGxhY2Vob2xkZXIgcm93c1xuICBmb3IobGV0IGkgPSAwOyBpIDwgbGltaXQ7IGkrKyl7XG4gICAgLy8gQ3JlYXRlIHJvdyBjb250YWluZXIgZW50aXR5XG4gICAgY29uc3Qgcm93RW50aXR5ID0gZW5naW5lLmFkZEVudGl0eSgpXG4gICAgVHJhbnNmb3JtLmNyZWF0ZShyb3dFbnRpdHksIHtcbiAgICAgIHBhcmVudDogbGVhZGVyYm9hcmQsXG4gICAgICBwb3NpdGlvbjogVmVjdG9yMy5jcmVhdGUoMCwgLWkgKiAwLjUgLSAwLjIsIDApXG4gICAgfSlcbiAgXG4gICAgLy8gQ3JlYXRlIGJhY2tncm91bmQgZW50aXR5XG4gICAgY29uc3QgYmFja2dyb3VuZEVudGl0eSA9IGVuZ2luZS5hZGRFbnRpdHkoKVxuICAgIGlmIChzaG93QmFja2dyb3VuZCkge1xuICAgICAgVHJhbnNmb3JtLmNyZWF0ZShiYWNrZ3JvdW5kRW50aXR5LCB7XG4gICAgICAgIHBhcmVudDogcm93RW50aXR5LFxuICAgICAgICBwb3NpdGlvbjogVmVjdG9yMy5jcmVhdGUoMCwgMCwgMC4wMSksXG4gICAgICAgIHNjYWxlOiBWZWN0b3IzLmNyZWF0ZShyb3dXaWR0aCwgcm93SGVpZ2h0LCAxKVxuICAgICAgfSlcbiAgICAgIE1lc2hSZW5kZXJlci5zZXRQbGFuZShiYWNrZ3JvdW5kRW50aXR5KVxuICAgICAgTWF0ZXJpYWwuc2V0UGJyTWF0ZXJpYWwoYmFja2dyb3VuZEVudGl0eSwge1xuICAgICAgICBhbGJlZG9Db2xvcjogaSAlIDIgPT09IDAgPyBcbiAgICAgICAgICBDb2xvcjQuY3JlYXRlKDE4LzI1NSwgMjMvMjU1LDM3LzI1NSwxKSA6XG4gICAgICAgICAgQ29sb3I0LmNyZWF0ZSgyNi8yNTUsMzQvMjU1LCA1My8yNTUsIDEpXG4gICAgICB9KVxuICAgIH0gZWxzZSB7XG4gICAgICBUcmFuc2Zvcm0uY3JlYXRlKGJhY2tncm91bmRFbnRpdHksIHtcbiAgICAgICAgcGFyZW50OiByb3dFbnRpdHksXG4gICAgICAgIHNjYWxlOiBWZWN0b3IzLlplcm8oKVxuICAgICAgfSlcbiAgICB9XG5cbiAgICAvLyBDcmVhdGUgcmFuayBlbnRpdHkgKCMxLCAjMiwgZXRjLilcbiAgICBjb25zdCByYW5rRW50aXR5ID0gZW5naW5lLmFkZEVudGl0eSgpXG4gICAgVHJhbnNmb3JtLmNyZWF0ZShyYW5rRW50aXR5LCB7XG4gICAgICBwYXJlbnQ6IHJvd0VudGl0eSxcbiAgICAgIHBvc2l0aW9uOiBWZWN0b3IzLmNyZWF0ZShsZWZ0UG9zLCAwLCAwKVxuICAgIH0pXG4gICAgVGV4dFNoYXBlLmNyZWF0ZShyYW5rRW50aXR5LCB7dGV4dDpgIyR7aSArIDF9YCwgZm9udFNpemU6MS41fSlcblxuICAgIC8vIENyZWF0ZSBwcm9maWxlIGltYWdlIGVudGl0eVxuICAgIGNvbnN0IHByb2ZpbGVFbnRpdHkgPSBlbmdpbmUuYWRkRW50aXR5KClcbiAgICBUcmFuc2Zvcm0uY3JlYXRlKHByb2ZpbGVFbnRpdHksIHtcbiAgICAgIHBhcmVudDogcm93RW50aXR5LFxuICAgICAgcG9zaXRpb246IFZlY3RvcjMuY3JlYXRlKGNlbnRlclBvcyAtIDAuOCwgMCwgMCksXG4gICAgICBzY2FsZTogVmVjdG9yMy5jcmVhdGUoMC4zLDAuMywwLjMpXG4gICAgfSlcbiAgICBNZXNoUmVuZGVyZXIuc2V0UGxhbmUocHJvZmlsZUVudGl0eSlcbiAgICBNYXRlcmlhbC5zZXRQYnJNYXRlcmlhbChwcm9maWxlRW50aXR5LCB7XG4gICAgICB0ZXh0dXJlOiBNYXRlcmlhbC5UZXh0dXJlLkF2YXRhcih7XG4gICAgICAgIHVzZXJJZDogJycsXG4gICAgICB9KSxcbiAgICB9KVxuXG4gICAgLy8gQ3JlYXRlIG5hbWUgZW50aXR5XG4gICAgY29uc3QgbmFtZUVudGl0eSA9IGVuZ2luZS5hZGRFbnRpdHkoKVxuICAgIFRyYW5zZm9ybS5jcmVhdGUobmFtZUVudGl0eSwge1xuICAgICAgcGFyZW50OiByb3dFbnRpdHksXG4gICAgICBwb3NpdGlvbjogVmVjdG9yMy5jcmVhdGUoY2VudGVyUG9zIC0gMC40LCAwLCAwKVxuICAgIH0pXG4gICAgVGV4dFNoYXBlLmNyZWF0ZShuYW1lRW50aXR5LCB7dGV4dDpgTmFtZWAsIGZvbnRTaXplOjEuNSwgIHRleHRBbGlnbjogVGV4dEFsaWduTW9kZS5UQU1fTUlERExFX0xFRlR9KVxuXG4gICAgLy8gQ3JlYXRlIHNjb3JlIGVudGl0eVxuICAgIGNvbnN0IHNjb3JlRW50aXR5ID0gZW5naW5lLmFkZEVudGl0eSgpXG4gICAgVHJhbnNmb3JtLmNyZWF0ZShzY29yZUVudGl0eSwge1xuICAgICAgcGFyZW50OiByb3dFbnRpdHksXG4gICAgICBwb3NpdGlvbjogVmVjdG9yMy5jcmVhdGUocmlnaHRQb3MsIDAsIDApXG4gICAgfSlcbiAgICBUZXh0U2hhcGUuY3JlYXRlKHNjb3JlRW50aXR5LCB7dGV4dDpgU2NvcmVgLCBmb250U2l6ZToxLjV9KVxuXG4gICAgLy8gU3RvcmUgcmVmZXJlbmNlcyB0byBhbGwgZW50aXRpZXNcbiAgICBsZWFkZXJib2FyZFJvd3MucHVzaCh7XG4gICAgICByYW5rOiBpICsgMSxcbiAgICAgIHJvd0VudGl0eSxcbiAgICAgIGJhY2tncm91bmRFbnRpdHksXG4gICAgICByYW5rRW50aXR5LFxuICAgICAgcHJvZmlsZUVudGl0eSxcbiAgICAgIG5hbWVFbnRpdHksXG4gICAgICBzY29yZUVudGl0eVxuICAgIH0pXG4gIH1cblxuICBsZXQgdGltZSA9IDBcbiAgZnVuY3Rpb24gbGVhZGVyYm9hcmRVcGRhdGUoZHQ6bnVtYmVyKXtcbiAgICBpZih0aW1lID4gMCl7XG4gICAgICB0aW1lIC09IGR0XG4gICAgfWVsc2V7XG4gICAgICB0aW1lID0gdXBkYXRlSW50ZXJ2YWxcbiAgICAgIHVwZGF0ZUxTQ1F1ZXN0TGVhZGVyYm9hcmQoKVxuICAgIH1cbiAgfVxuXG4gIGFzeW5jIGZ1bmN0aW9uIHVwZGF0ZUxTQ1F1ZXN0TGVhZGVyYm9hcmQoKXtcbiAgICB0cnl7XG4gICAgICAvLyBHZXQgY3VycmVudCBwbGF5ZXIgaW5mb3JtYXRpb24gZmlyc3RcbiAgICAgIGNvbnN0IHBsYXllckRhdGEgPSBnZXRQbGF5ZXIoKTtcbiAgICAgIGNvbnN0IHBsYXllcklEID0gcGxheWVyRGF0YSA/IHBsYXllckRhdGEudXNlcklkIDogJyc7XG4gICAgICBjb25zdCBwbGF5ZXJOYW1lID0gcGxheWVyRGF0YT8ubmFtZSB8fCAnWW91JztcbiAgICAgIFxuICAgICAgLy8gRGVmaW5lIHRoZSB1c2VyIGRhdGEgaW50ZXJmYWNlXG4gICAgICBpbnRlcmZhY2UgVXNlckRhdGEge1xuICAgICAgICB1c2VySWQ6IHN0cmluZztcbiAgICAgICAgbmFtZTogc3RyaW5nO1xuICAgICAgICBlbGFwc2VkVGltZTogbnVtYmVyO1xuICAgICAgICBjb21wbGV0ZWQ6IGJvb2xlYW47XG4gICAgICAgIFtrZXk6IHN0cmluZ106IGFueTsgLy8gQWxsb3cgZm9yIGR5bmFtaWMgcHJvcGVydGllcyAvL1xuICAgICAgfVxuICAgICAgXG4gICAgICAvLyBHZXQgbGVhZGVyYm9hcmQgZGF0YSBmcm9tIEFQSVxuICAgICAgbGV0IHBhcmFtcyA9IFtgY29tcGxldGVkPSR7Y29tcGxldGVkfWAsIGBvcmRlckJ5PSR7b3JkZXJ9YCwgYGxpbWl0PSR7bGltaXR9YCwgYHNvcnRCeT0ke3NvcnRCeX1gXVxuICAgICAgbGV0IHJlc3BvbnNlID0gYXdhaXQgZmV0Y2goIERFQlVHID8gYGh0dHA6Ly9sb2NhbGhvc3Q6NTM1My9hcGkvcXVlc3RzLyR7cXVlc3RJZH0vdXNlcnM/YCArIHBhcmFtcy5qb2luKCcmJykgOiBgaHR0cHM6Ly9hbmd6YWFyLXBsYXphLmRjbC1pd2IuY28vd3MvYXBpL3F1ZXN0cy8ke3F1ZXN0SWR9L3VzZXJzP2AgKyBwYXJhbXMuam9pbignJicpKSBcbiAgICAgIGxldCBkYXRhID0gYXdhaXQgcmVzcG9uc2UuanNvbigpXG4gICAgICBjb25zb2xlLmxvZygnbGVhZGVyYm9hcmQgZGF0YTonLCBkYXRhKTtcbiAgICAgIFxuICAgICAgLy8gQ2hlY2sgaWYgZGF0YSBpcyBlbXB0eVxuICAgICAgaWYgKCFkYXRhIHx8IGRhdGEubGVuZ3RoID09PSAwKSB7XG4gICAgICAgIC8vIFNob3cgXCJubyBkYXRhXCIgbWVzc2FnZSBpbiB0aGUgZmlyc3Qgcm93XG4gICAgICAgIGNvbnN0IHJvdyA9IGxlYWRlcmJvYXJkUm93c1swXVxuICAgICAgICBpZiAoVHJhbnNmb3JtLmhhcyhyb3cucm93RW50aXR5KSkge1xuICAgICAgICAgIFRyYW5zZm9ybS5nZXRNdXRhYmxlKHJvdy5yb3dFbnRpdHkpLnNjYWxlID0gVmVjdG9yMy5jcmVhdGUoMSwgMSwgMSlcbiAgICAgICAgICBcbiAgICAgICAgICBpZiAoc2hvd0JhY2tncm91bmQpIHtcbiAgICAgICAgICAgIFRyYW5zZm9ybS5nZXRNdXRhYmxlKHJvdy5iYWNrZ3JvdW5kRW50aXR5KS5zY2FsZSA9IFZlY3RvcjMuY3JlYXRlKHJvd1dpZHRoLCByb3dIZWlnaHQsIDEpXG4gICAgICAgICAgfVxuICAgICAgICAgIFxuICAgICAgICAgIFRleHRTaGFwZS5nZXRNdXRhYmxlKHJvdy5yYW5rRW50aXR5KS50ZXh0ID0gXCJcIlxuICAgICAgICAgIFRleHRTaGFwZS5nZXRNdXRhYmxlKHJvdy5uYW1lRW50aXR5KS50ZXh0ID0gXCJObyBkYXRhIGF2YWlsYWJsZVwiXG4gICAgICAgICAgVGV4dFNoYXBlLmdldE11dGFibGUocm93LnNjb3JlRW50aXR5KS50ZXh0ID0gXCJcIlxuICAgICAgICAgIFxuICAgICAgICAgIC8vIEhpZGUgcHJvZmlsZSBpbWFnZVxuICAgICAgICAgIFRyYW5zZm9ybS5nZXRNdXRhYmxlKHJvdy5wcm9maWxlRW50aXR5KS5zY2FsZSA9IFZlY3RvcjMuWmVybygpXG4gICAgICAgICAgXG4gICAgICAgICAgLy8gSGlkZSByZW1haW5pbmcgcm93c1xuICAgICAgICAgIGZvciAobGV0IGkgPSAxOyBpIDwgbGVhZGVyYm9hcmRSb3dzLmxlbmd0aDsgaSsrKSB7XG4gICAgICAgICAgICBjb25zdCByZW1haW5pbmdSb3cgPSBsZWFkZXJib2FyZFJvd3NbaV1cbiAgICAgICAgICAgIGlmIChUcmFuc2Zvcm0uaGFzKHJlbWFpbmluZ1Jvdy5yb3dFbnRpdHkpKSB7XG4gICAgICAgICAgICAgIFRyYW5zZm9ybS5nZXRNdXRhYmxlKHJlbWFpbmluZ1Jvdy5yb3dFbnRpdHkpLnNjYWxlID0gVmVjdG9yMy5aZXJvKClcbiAgICAgICAgICAgICAgaWYgKHNob3dCYWNrZ3JvdW5kKSB7XG4gICAgICAgICAgICAgICAgVHJhbnNmb3JtLmdldE11dGFibGUocmVtYWluaW5nUm93LmJhY2tncm91bmRFbnRpdHkpLnNjYWxlID0gVmVjdG9yMy5aZXJvKClcbiAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICAgIH1cbiAgICAgICAgICByZXR1cm5cbiAgICAgICAgfVxuICAgICAgfVxuICAgICAgXG4gICAgICAvLyBVcGRhdGUgbGVhZGVyYm9hcmQgd2l0aCBkYXRhXG4gICAgICBmb3IobGV0IGkgPSAwOyBpIDwgbGVhZGVyYm9hcmRSb3dzLmxlbmd0aDsgaSsrKSB7XG4gICAgICAgIGNvbnN0IHJvdyA9IGxlYWRlcmJvYXJkUm93c1tpXVxuICAgICAgICBjb25zdCByb3dEYXRhID0gZGF0YVtpXVxuICAgICAgICBcbiAgICAgICAgaWYgKHJvd0RhdGEpIHtcbiAgICAgICAgICAvLyBTaG93IHRoaXMgcm93IGFuZCB1cGRhdGUgd2l0aCB1c2VyIGRhdGFcbiAgICAgICAgICBpZiAoIVRyYW5zZm9ybS5oYXMocm93LnJvd0VudGl0eSkpIGNvbnRpbnVlXG4gICAgICAgICAgXG4gICAgICAgICAgLy8gTWFrZSByb3cgdmlzaWJsZVxuICAgICAgICAgIFRyYW5zZm9ybS5nZXRNdXRhYmxlKHJvdy5yb3dFbnRpdHkpLnNjYWxlID0gVmVjdG9yMy5jcmVhdGUoMSwgMSwgMSlcbiAgICAgICAgICBcbiAgICAgICAgICAvLyBPbmx5IHVwZGF0ZSBiYWNrZ3JvdW5kIGlmIGl0J3MgZW5hYmxlZFxuICAgICAgICAgIGlmIChzaG93QmFja2dyb3VuZCkge1xuICAgICAgICAgICAgVHJhbnNmb3JtLmdldE11dGFibGUocm93LmJhY2tncm91bmRFbnRpdHkpLnNjYWxlID0gVmVjdG9yMy5jcmVhdGUocm93V2lkdGgsIHJvd0hlaWdodCwgMSlcbiAgICAgICAgICB9XG4gICAgICAgICAgXG4gICAgICAgICAgLy8gU2V0IHVzZXIgcmFuayAoIzEsICMyLCBldGMuKVxuICAgICAgICAgIGNvbnN0IHJhbmtUZXh0ID0gYCMke2kgKyAxfWBcbiAgICAgICAgICBUZXh0U2hhcGUuZ2V0TXV0YWJsZShyb3cucmFua0VudGl0eSkudGV4dCA9IHJhbmtUZXh0XG5cbiAgICAgICAgICBNYXRlcmlhbC5zZXRQYnJNYXRlcmlhbChyb3cucHJvZmlsZUVudGl0eSwge1xuICAgICAgICAgICAgdGV4dHVyZTogTWF0ZXJpYWwuVGV4dHVyZS5BdmF0YXIoe1xuICAgICAgICAgICAgICB1c2VySWQ6IHJvd0RhdGEudXNlcklkLFxuICAgICAgICAgICAgfSksXG4gICAgICAgICAgfSlcbiAgICAgICAgICBcbiAgICAgICAgICAvLyBTZXQgdXNlciBuYW1lXG4gICAgICAgICAgY29uc3QgbmFtZSA9IHJvd0RhdGEubmFtZSB8fCAnQW5vbnltb3VzJ1xuICAgICAgICAgIFRleHRTaGFwZS5nZXRNdXRhYmxlKHJvdy5uYW1lRW50aXR5KS50ZXh0ID0gbmFtZS5sZW5ndGggPiAxMCA/IG5hbWUuc2xpY2UoMCwgMTApIDogbmFtZVxuICAgICAgICAgIFxuICAgICAgICAgIC8vIFNldCB1c2VyIHNjb3JlICh0aW1lLCBwcm9ncmVzcywgZXRjLilcbiAgICAgICAgICBsZXQgc2NvcmVUZXh0ID0gJydcbiAgICAgICAgICBpZiAoc29ydEJ5ID09PSAnZWxhcHNlZFRpbWUnKSB7XG4gICAgICAgICAgICAvLyBGb3JtYXQgdGltZSBkaXNwbGF5XG4gICAgICAgICAgICBjb25zdCBtcyA9IHJvd0RhdGEuZWxhcHNlZFRpbWUgKiAxMDAwXG4gICAgICAgICAgICBjb25zdCBzZWNvbmRzID0gTWF0aC5mbG9vcihtcyAvIDEwMDApXG4gICAgICAgICAgICBjb25zdCBtaW51dGVzID0gTWF0aC5mbG9vcihzZWNvbmRzIC8gNjApXG4gICAgICAgICAgICBjb25zdCBob3VycyA9IE1hdGguZmxvb3IobWludXRlcyAvIDYwKVxuICAgICAgICAgICAgXG4gICAgICAgICAgICBpZiAoaG91cnMgPiAwKSB7XG4gICAgICAgICAgICAgIHNjb3JlVGV4dCA9IGAke2hvdXJzfWggJHttaW51dGVzICUgNjB9bWBcbiAgICAgICAgICAgIH0gZWxzZSBpZiAobWludXRlcyA+IDApIHtcbiAgICAgICAgICAgICAgc2NvcmVUZXh0ID0gYCR7bWludXRlc31tICR7c2Vjb25kcyAlIDYwfXNgXG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICBzY29yZVRleHQgPSBgJHtzZWNvbmRzfXNgXG4gICAgICAgICAgICB9XG4gICAgICAgICAgfSBlbHNlIGlmIChzb3J0QnkgPT09ICdwcm9ncmVzcycpIHtcbiAgICAgICAgICAgIC8vIEZvcm1hdCBwcm9ncmVzcyB3aXRoICUgc2lnblxuICAgICAgICAgICAgc2NvcmVUZXh0ID0gYCR7cm93RGF0YS5wcm9ncmVzcyB8fCAwfSVgXG4gICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIC8vIEZvciBvdGhlciBzY29yZSB0eXBlc1xuICAgICAgICAgICAgc2NvcmVUZXh0ID0gcm93RGF0YVtzb3J0QnldPy50b1N0cmluZygpIHx8ICcwJ1xuICAgICAgICAgIH1cblxuICAgICAgICAgIFRleHRTaGFwZS5nZXRNdXRhYmxlKHJvdy5zY29yZUVudGl0eSkudGV4dCA9IHNjb3JlVGV4dFxuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgIC8vIEhpZGUgdGhpcyByb3cgYXMgdGhlcmUncyBubyBkYXRhXG4gICAgICAgICAgaWYgKFRyYW5zZm9ybS5oYXMocm93LnJvd0VudGl0eSkpIHtcbiAgICAgICAgICAgIFRyYW5zZm9ybS5nZXRNdXRhYmxlKHJvdy5yb3dFbnRpdHkpLnNjYWxlID0gVmVjdG9yMy5aZXJvKClcbiAgICAgICAgICAgIFxuICAgICAgICAgICAgLy8gT25seSB1cGRhdGUgYmFja2dyb3VuZCBpZiBpdCdzIGVuYWJsZWRcbiAgICAgICAgICAgIGlmIChzaG93QmFja2dyb3VuZCkge1xuICAgICAgICAgICAgICBUcmFuc2Zvcm0uZ2V0TXV0YWJsZShyb3cuYmFja2dyb3VuZEVudGl0eSkuc2NhbGUgPSBWZWN0b3IzLlplcm8oKVxuICAgICAgICAgICAgfVxuICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgfVxuICAgIH0gY2F0Y2goZTphbnkpIHtcbiAgICAgIGNvbnNvbGUubG9nKCdlcnJvciB1cGRhdGluZyBxdWVzdCBsZWFkZXJib2FyZCcsIGUpXG4gICAgICAvLyBTaG93IGVycm9yIG1lc3NhZ2UgaW4gdGhlIGZpcnN0IHJvd1xuICAgICAgY29uc3Qgcm93ID0gbGVhZGVyYm9hcmRSb3dzWzBdXG4gICAgICBpZiAoVHJhbnNmb3JtLmhhcyhyb3cucm93RW50aXR5KSkge1xuICAgICAgICBUcmFuc2Zvcm0uZ2V0TXV0YWJsZShyb3cucm93RW50aXR5KS5zY2FsZSA9IFZlY3RvcjMuY3JlYXRlKDEsIDEsIDEpXG4gICAgICAgIFxuICAgICAgICBpZiAoc2hvd0JhY2tncm91bmQpIHtcbiAgICAgICAgICBUcmFuc2Zvcm0uZ2V0TXV0YWJsZShyb3cuYmFja2dyb3VuZEVudGl0eSkuc2NhbGUgPSBWZWN0b3IzLmNyZWF0ZShyb3dXaWR0aCwgcm93SGVpZ2h0LCAxKVxuICAgICAgICB9XG4gICAgICAgIFxuICAgICAgICBUZXh0U2hhcGUuZ2V0TXV0YWJsZShyb3cucmFua0VudGl0eSkudGV4dCA9IFwiXCJcbiAgICAgICAgVGV4dFNoYXBlLmdldE11dGFibGUocm93Lm5hbWVFbnRpdHkpLnRleHQgPSBcIkVycm9yIGxvYWRpbmcgZGF0YVwiXG4gICAgICAgIFRleHRTaGFwZS5nZXRNdXRhYmxlKHJvdy5zY29yZUVudGl0eSkudGV4dCA9IFwiXCJcbiAgICAgICAgXG4gICAgICAgIC8vIEhpZGUgcHJvZmlsZSBpbWFnZVxuICAgICAgICBUcmFuc2Zvcm0uZ2V0TXV0YWJsZShyb3cucHJvZmlsZUVudGl0eSkuc2NhbGUgPSBWZWN0b3IzLlplcm8oKVxuICAgICAgICBcbiAgICAgICAgLy8gSGlkZSByZW1haW5pbmcgcm93c1xuICAgICAgICBmb3IgKGxldCBpID0gMTsgaSA8IGxlYWRlcmJvYXJkUm93cy5sZW5ndGg7IGkrKykge1xuICAgICAgICAgIGNvbnN0IHJlbWFpbmluZ1JvdyA9IGxlYWRlcmJvYXJkUm93c1tpXVxuICAgICAgICAgIGlmIChUcmFuc2Zvcm0uaGFzKHJlbWFpbmluZ1Jvdy5yb3dFbnRpdHkpKSB7XG4gICAgICAgICAgICBUcmFuc2Zvcm0uZ2V0TXV0YWJsZShyZW1haW5pbmdSb3cucm93RW50aXR5KS5zY2FsZSA9IFZlY3RvcjMuWmVybygpXG4gICAgICAgICAgICBpZiAoc2hvd0JhY2tncm91bmQpIHtcbiAgICAgICAgICAgICAgVHJhbnNmb3JtLmdldE11dGFibGUocmVtYWluaW5nUm93LmJhY2tncm91bmRFbnRpdHkpLnNjYWxlID0gVmVjdG9yMy5aZXJvKClcbiAgICAgICAgICAgIH1cbiAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9XG4gIH1cblxuICBlbmdpbmUuYWRkU3lzdGVtKGxlYWRlcmJvYXJkVXBkYXRlKVxuXG4gIC8vIFJlYWN0RWNzUmVuZGVyZXIuc2V0VWlSZW5kZXJlcih1aUNvbXBvbmVudClcbn0iXX0=