import { LOCAL_CREATOR, lscQuestConnections } from "./quest";
import { Client } from "colyseus.js";
import { DEBUG, LSCQUEST_EVENTS } from "./definitions";
import { lscQuestEvent, lscQuestUserData, pendingQuestConnections } from "./quest";
import { getPlayer } from "@dcl/sdk/players";
import { getRealm } from "~system/Runtime";
import { engine } from "@dcl/sdk/ecs";
let player;
function setLSCQuestListeners(room, userId) {
    room.onMessage(LSCQUEST_EVENTS.QUEST_CONNECTION, (info) => {
        console.log('quest connection ', info);
        lscQuestEvent.emit(LSCQUEST_EVENTS.QUEST_CONNECTION, info);
    });
    room.onMessage(LSCQUEST_EVENTS.QUEST_ERROR, (info) => {
        console.log('quest error ', info);
        lscQuestEvent.emit(LSCQUEST_EVENTS.QUEST_ERROR, info);
    });
    room.onMessage(LSCQUEST_EVENTS.QUEST_DATA, (info) => {
        console.log('user quest data ', info);
        if (info.userQuestInfo) {
            lscQuestUserData.set(info.questId, info.userQuestInfo);
        }
        lscQuestEvent.emit(LSCQUEST_EVENTS.QUEST_DATA, info);
    });
    room.onMessage(LSCQUEST_EVENTS.QUEST_STARTED, (info) => {
        console.log('started quest ', info);
        lscQuestEvent.emit(LSCQUEST_EVENTS.QUEST_STARTED, info);
    });
    room.onMessage(LSCQUEST_EVENTS.QUEST_COMPLETE, (info) => {
        console.log('complete quest ', info);
        if (info.userQuestInfo) {
            lscQuestUserData.set(info.questId, info.userQuestInfo);
        }
        else {
            let userQuestData = lscQuestUserData.get(info.questId);
            if (userQuestData) {
                userQuestData.completed = true;
            }
        }
        lscQuestEvent.emit(LSCQUEST_EVENTS.QUEST_COMPLETE, info);
    });
    room.onMessage(LSCQUEST_EVENTS.QUEST_END, (info) => {
        console.log('ended quest ', info);
        lscQuestEvent.emit(LSCQUEST_EVENTS.QUEST_END, info);
    });
    room.onMessage(LSCQUEST_EVENTS.QUEST_UPDATE, (info) => {
        console.log('update quest ', info);
        lscQuestUserData.set(userId, info);
        lscQuestEvent.emit(LSCQUEST_EVENTS.QUEST_UPDATE, info);
    });
    room.onMessage(LSCQUEST_EVENTS.QUEST_STEP_COMPLETE, (info) => {
        console.log('step complete quest ', info);
        if (info.userQuestInfo) {
            lscQuestUserData.set(info.questId, info.userQuestInfo);
        }
        else {
            let userQuestData = lscQuestUserData.get(info.questId);
            if (userQuestData) {
                let step = userQuestData.steps.find((step) => step.stepId === info.stepId);
                if (step) {
                    step.completed = true;
                }
            }
        }
        lscQuestEvent.emit(LSCQUEST_EVENTS.QUEST_STEP_COMPLETE, info);
    });
    room.onMessage(LSCQUEST_EVENTS.QUEST_TASK_COMPLETE, (info) => {
        console.log('task complete quest ', info);
        if (info.userQuestInfo) {
            lscQuestUserData.set(info.questId, info.userQuestInfo);
        }
        else {
            let userQuestData = lscQuestUserData.get(info.questId);
            if (userQuestData) {
                let step = userQuestData.steps.find((step) => step.stepId === info.stepId);
                if (step) {
                    let task = step.tasks.find((task) => task.taskId === info.taskId);
                    if (task) {
                        task.count++;
                        task.completed = true;
                    }
                }
            }
        }
        lscQuestEvent.emit(LSCQUEST_EVENTS.QUEST_TASK_COMPLETE, info);
    });
}
let time = 0;
export function CheckPlayerSystem(dt) {
    if (time > 0) {
        time -= dt;
    }
    else {
        player = getPlayer();
        if (!player) {
            time = 1;
        }
        else {
            engine.removeSystem(CheckPlayerSystem);
        }
    }
}
export function ConnectQuestSystem() {
    if (!player)
        return;
    if (pendingQuestConnections.length > 0) {
        let pendingQuestId = "" + pendingQuestConnections.shift();
        makeQuestConnection(pendingQuestId);
    }
}
async function makeQuestConnection(questId) {
    const realm = await getRealm({});
    const options = {
        userId: player.userId,
        name: player.name,
        realm: LOCAL_CREATOR ? "local-testing" : realm.realmInfo?.baseUrl,
        questId: questId,
    };
    let client = new Client(DEBUG ?
        { hostname: 'localhost', secure: false, port: 5353 } :
        { hostname: 'angzaar-plaza.dcl-iwb.co', pathname: '/ws', secure: true });
    try {
        const room = await client.joinOrCreate('angzaar_questing', options);
        lscQuestConnections.set(questId, room);
        setLSCQuestListeners(room, player.userId);
        room.onLeave((code, reason) => {
            console.log('left quest room', questId, code, reason);
            lscQuestEvent.emit(LSCQUEST_EVENTS.QUEST_DISCONNECT, { questId, code, reason });
        });
        return room;
    }
    catch (error) {
        console.error('Error connecting to LSC Quest System', error);
        throw error;
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY29ubmVjdGlvbi5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uL3NyYy9jb25uZWN0aW9uLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sRUFBRSxhQUFhLEVBQUUsbUJBQW1CLEVBQUUsTUFBTSxTQUFTLENBQUE7QUFDNUQsT0FBTyxFQUFFLE1BQU0sRUFBRSxNQUFNLGFBQWEsQ0FBQTtBQUVwQyxPQUFPLEVBQUUsS0FBSyxFQUFFLGVBQWUsRUFBRSxNQUFNLGVBQWUsQ0FBQTtBQUN0RCxPQUFPLEVBQUUsYUFBYSxFQUFFLGdCQUFnQixFQUFFLHVCQUF1QixFQUFFLE1BQU0sU0FBUyxDQUFBO0FBQ2xGLE9BQU8sRUFBRSxTQUFTLEVBQUUsTUFBTSxrQkFBa0IsQ0FBQTtBQUM1QyxPQUFPLEVBQUUsUUFBUSxFQUFFLE1BQU0saUJBQWlCLENBQUE7QUFDMUMsT0FBTyxFQUFFLE1BQU0sRUFBRSxNQUFNLGNBQWMsQ0FBQTtBQUdyQyxJQUFJLE1BQVUsQ0FBQTtBQUVkLFNBQVMsb0JBQW9CLENBQUMsSUFBUyxFQUFFLE1BQWE7SUFDcEQsSUFBSSxDQUFDLFNBQVMsQ0FBQyxlQUFlLENBQUMsZ0JBQWdCLEVBQUUsQ0FBQyxJQUFRLEVBQUMsRUFBRTtRQUMzRCxPQUFPLENBQUMsR0FBRyxDQUFDLG1CQUFtQixFQUFFLElBQUksQ0FBQyxDQUFBO1FBQ3RDLGFBQWEsQ0FBQyxJQUFJLENBQUMsZUFBZSxDQUFDLGdCQUFnQixFQUFFLElBQUksQ0FBQyxDQUFBO0lBQzVELENBQUMsQ0FBQyxDQUFBO0lBRUYsSUFBSSxDQUFDLFNBQVMsQ0FBQyxlQUFlLENBQUMsV0FBVyxFQUFFLENBQUMsSUFBUSxFQUFDLEVBQUU7UUFDdEQsT0FBTyxDQUFDLEdBQUcsQ0FBQyxjQUFjLEVBQUUsSUFBSSxDQUFDLENBQUE7UUFDakMsYUFBYSxDQUFDLElBQUksQ0FBQyxlQUFlLENBQUMsV0FBVyxFQUFFLElBQUksQ0FBQyxDQUFBO0lBQ3ZELENBQUMsQ0FBQyxDQUFBO0lBRUYsSUFBSSxDQUFDLFNBQVMsQ0FBQyxlQUFlLENBQUMsVUFBVSxFQUFFLENBQUMsSUFBUSxFQUFDLEVBQUU7UUFDckQsT0FBTyxDQUFDLEdBQUcsQ0FBQyxrQkFBa0IsRUFBRSxJQUFJLENBQUMsQ0FBQTtRQUNyQyxJQUFHLElBQUksQ0FBQyxhQUFhLEVBQUMsQ0FBQztZQUNyQixnQkFBZ0IsQ0FBQyxHQUFHLENBQUMsSUFBSSxDQUFDLE9BQU8sRUFBRSxJQUFJLENBQUMsYUFBYSxDQUFDLENBQUE7UUFDeEQsQ0FBQztRQUNELGFBQWEsQ0FBQyxJQUFJLENBQUMsZUFBZSxDQUFDLFVBQVUsRUFBRSxJQUFJLENBQUMsQ0FBQTtJQUN0RCxDQUFDLENBQUMsQ0FBQTtJQUVGLElBQUksQ0FBQyxTQUFTLENBQUMsZUFBZSxDQUFDLGFBQWEsRUFBRSxDQUFDLElBQVEsRUFBQyxFQUFFO1FBQ3hELE9BQU8sQ0FBQyxHQUFHLENBQUMsZ0JBQWdCLEVBQUUsSUFBSSxDQUFDLENBQUE7UUFDbkMsYUFBYSxDQUFDLElBQUksQ0FBQyxlQUFlLENBQUMsYUFBYSxFQUFFLElBQUksQ0FBQyxDQUFBO0lBQ3pELENBQUMsQ0FBQyxDQUFBO0lBRUYsSUFBSSxDQUFDLFNBQVMsQ0FBQyxlQUFlLENBQUMsY0FBYyxFQUFFLENBQUMsSUFBUSxFQUFDLEVBQUU7UUFDekQsT0FBTyxDQUFDLEdBQUcsQ0FBQyxpQkFBaUIsRUFBRSxJQUFJLENBQUMsQ0FBQTtRQUdwQyxJQUFJLElBQUksQ0FBQyxhQUFhLEVBQUUsQ0FBQztZQUN2QixnQkFBZ0IsQ0FBQyxHQUFHLENBQUMsSUFBSSxDQUFDLE9BQU8sRUFBRSxJQUFJLENBQUMsYUFBYSxDQUFDLENBQUE7UUFDeEQsQ0FBQzthQUVJLENBQUM7WUFDSixJQUFJLGFBQWEsR0FBRyxnQkFBZ0IsQ0FBQyxHQUFHLENBQUMsSUFBSSxDQUFDLE9BQU8sQ0FBQyxDQUFBO1lBQ3RELElBQUcsYUFBYSxFQUFDLENBQUM7Z0JBQ2hCLGFBQWEsQ0FBQyxTQUFTLEdBQUcsSUFBSSxDQUFBO1lBQ2hDLENBQUM7UUFDSCxDQUFDO1FBRUQsYUFBYSxDQUFDLElBQUksQ0FBQyxlQUFlLENBQUMsY0FBYyxFQUFFLElBQUksQ0FBQyxDQUFBO0lBQzFELENBQUMsQ0FBQyxDQUFBO0lBRUYsSUFBSSxDQUFDLFNBQVMsQ0FBQyxlQUFlLENBQUMsU0FBUyxFQUFFLENBQUMsSUFBUSxFQUFDLEVBQUU7UUFDcEQsT0FBTyxDQUFDLEdBQUcsQ0FBQyxjQUFjLEVBQUUsSUFBSSxDQUFDLENBQUE7UUFDakMsYUFBYSxDQUFDLElBQUksQ0FBQyxlQUFlLENBQUMsU0FBUyxFQUFFLElBQUksQ0FBQyxDQUFBO0lBQ3JELENBQUMsQ0FBQyxDQUFBO0lBRUYsSUFBSSxDQUFDLFNBQVMsQ0FBQyxlQUFlLENBQUMsWUFBWSxFQUFFLENBQUMsSUFBUSxFQUFDLEVBQUU7UUFDdkQsT0FBTyxDQUFDLEdBQUcsQ0FBQyxlQUFlLEVBQUUsSUFBSSxDQUFDLENBQUE7UUFDbEMsZ0JBQWdCLENBQUMsR0FBRyxDQUFDLE1BQU0sRUFBRSxJQUFJLENBQUMsQ0FBQTtRQUNsQyxhQUFhLENBQUMsSUFBSSxDQUFDLGVBQWUsQ0FBQyxZQUFZLEVBQUUsSUFBSSxDQUFDLENBQUE7SUFDeEQsQ0FBQyxDQUFDLENBQUE7SUFFRixJQUFJLENBQUMsU0FBUyxDQUFDLGVBQWUsQ0FBQyxtQkFBbUIsRUFBRSxDQUFDLElBQVEsRUFBQyxFQUFFO1FBQzlELE9BQU8sQ0FBQyxHQUFHLENBQUMsc0JBQXNCLEVBQUUsSUFBSSxDQUFDLENBQUE7UUFHekMsSUFBSSxJQUFJLENBQUMsYUFBYSxFQUFFLENBQUM7WUFDdkIsZ0JBQWdCLENBQUMsR0FBRyxDQUFDLElBQUksQ0FBQyxPQUFPLEVBQUUsSUFBSSxDQUFDLGFBQWEsQ0FBQyxDQUFBO1FBQ3hELENBQUM7YUFFSSxDQUFDO1lBQ0osSUFBSSxhQUFhLEdBQUcsZ0JBQWdCLENBQUMsR0FBRyxDQUFDLElBQUksQ0FBQyxPQUFPLENBQUMsQ0FBQTtZQUN0RCxJQUFHLGFBQWEsRUFBQyxDQUFDO2dCQUNoQixJQUFJLElBQUksR0FBRyxhQUFhLENBQUMsS0FBSyxDQUFDLElBQUksQ0FBQyxDQUFDLElBQVEsRUFBQyxFQUFFLENBQUEsSUFBSSxDQUFDLE1BQU0sS0FBSyxJQUFJLENBQUMsTUFBTSxDQUFDLENBQUE7Z0JBQzVFLElBQUcsSUFBSSxFQUFDLENBQUM7b0JBQ1AsSUFBSSxDQUFDLFNBQVMsR0FBRyxJQUFJLENBQUE7Z0JBQ3ZCLENBQUM7WUFDSCxDQUFDO1FBQ0gsQ0FBQztRQUVELGFBQWEsQ0FBQyxJQUFJLENBQUMsZUFBZSxDQUFDLG1CQUFtQixFQUFFLElBQUksQ0FBQyxDQUFBO0lBQy9ELENBQUMsQ0FBQyxDQUFBO0lBRUYsSUFBSSxDQUFDLFNBQVMsQ0FBQyxlQUFlLENBQUMsbUJBQW1CLEVBQUUsQ0FBQyxJQUFRLEVBQUMsRUFBRTtRQUM5RCxPQUFPLENBQUMsR0FBRyxDQUFDLHNCQUFzQixFQUFFLElBQUksQ0FBQyxDQUFBO1FBR3pDLElBQUksSUFBSSxDQUFDLGFBQWEsRUFBRSxDQUFDO1lBQ3ZCLGdCQUFnQixDQUFDLEdBQUcsQ0FBQyxJQUFJLENBQUMsT0FBTyxFQUFFLElBQUksQ0FBQyxhQUFhLENBQUMsQ0FBQTtRQUN4RCxDQUFDO2FBRUksQ0FBQztZQUNKLElBQUksYUFBYSxHQUFHLGdCQUFnQixDQUFDLEdBQUcsQ0FBQyxJQUFJLENBQUMsT0FBTyxDQUFDLENBQUE7WUFDdEQsSUFBRyxhQUFhLEVBQUMsQ0FBQztnQkFDaEIsSUFBSSxJQUFJLEdBQUcsYUFBYSxDQUFDLEtBQUssQ0FBQyxJQUFJLENBQUMsQ0FBQyxJQUFRLEVBQUMsRUFBRSxDQUFBLElBQUksQ0FBQyxNQUFNLEtBQUssSUFBSSxDQUFDLE1BQU0sQ0FBQyxDQUFBO2dCQUM1RSxJQUFHLElBQUksRUFBQyxDQUFDO29CQUNQLElBQUksSUFBSSxHQUFHLElBQUksQ0FBQyxLQUFLLENBQUMsSUFBSSxDQUFDLENBQUMsSUFBUSxFQUFDLEVBQUUsQ0FBQSxJQUFJLENBQUMsTUFBTSxLQUFLLElBQUksQ0FBQyxNQUFNLENBQUMsQ0FBQTtvQkFDbkUsSUFBRyxJQUFJLEVBQUMsQ0FBQzt3QkFDUCxJQUFJLENBQUMsS0FBSyxFQUFFLENBQUE7d0JBQ1osSUFBSSxDQUFDLFNBQVMsR0FBRyxJQUFJLENBQUE7b0JBQ3ZCLENBQUM7Z0JBQ0gsQ0FBQztZQUNILENBQUM7UUFDSCxDQUFDO1FBRUQsYUFBYSxDQUFDLElBQUksQ0FBQyxlQUFlLENBQUMsbUJBQW1CLEVBQUUsSUFBSSxDQUFDLENBQUE7SUFDL0QsQ0FBQyxDQUFDLENBQUE7QUFDSixDQUFDO0FBRUQsSUFBSSxJQUFJLEdBQVUsQ0FBQyxDQUFBO0FBQ25CLE1BQU0sVUFBVSxpQkFBaUIsQ0FBQyxFQUFTO0lBQ3pDLElBQUcsSUFBSSxHQUFHLENBQUMsRUFBQyxDQUFDO1FBQ1gsSUFBSSxJQUFJLEVBQUUsQ0FBQTtJQUNaLENBQUM7U0FBSSxDQUFDO1FBQ0osTUFBTSxHQUFHLFNBQVMsRUFBRSxDQUFBO1FBQ3BCLElBQUcsQ0FBQyxNQUFNLEVBQUMsQ0FBQztZQUNWLElBQUksR0FBRyxDQUFDLENBQUE7UUFDVixDQUFDO2FBQUksQ0FBQztZQUNKLE1BQU0sQ0FBQyxZQUFZLENBQUMsaUJBQWlCLENBQUMsQ0FBQTtRQUN4QyxDQUFDO0lBQ0gsQ0FBQztBQUNILENBQUM7QUFFRCxNQUFNLFVBQVUsa0JBQWtCO0lBQ2hDLElBQUcsQ0FBQyxNQUFNO1FBQUUsT0FBTTtJQUVsQixJQUFHLHVCQUF1QixDQUFDLE1BQU0sR0FBRyxDQUFDLEVBQUMsQ0FBQztRQUNyQyxJQUFJLGNBQWMsR0FBVSxFQUFFLEdBQUcsdUJBQXVCLENBQUMsS0FBSyxFQUFFLENBQUE7UUFDaEUsbUJBQW1CLENBQUMsY0FBYyxDQUFDLENBQUE7SUFDckMsQ0FBQztBQUNILENBQUM7QUFFRCxLQUFLLFVBQVUsbUJBQW1CLENBQUMsT0FBYztJQUMvQyxNQUFNLEtBQUssR0FBRyxNQUFNLFFBQVEsQ0FBQyxFQUFFLENBQUMsQ0FBQTtJQUVoQyxNQUFNLE9BQU8sR0FBTztRQUNsQixNQUFNLEVBQUUsTUFBTSxDQUFDLE1BQU07UUFDckIsSUFBSSxFQUFFLE1BQU0sQ0FBQyxJQUFJO1FBQ2pCLEtBQUssRUFBRSxhQUFhLENBQUMsQ0FBQyxDQUFDLGVBQWUsQ0FBQyxDQUFDLENBQUMsS0FBSyxDQUFDLFNBQVMsRUFBRSxPQUFPO1FBQ2pFLE9BQU8sRUFBRSxPQUFPO0tBQ2pCLENBQUE7SUFFRCxJQUFJLE1BQU0sR0FBRyxJQUFJLE1BQU0sQ0FBQyxLQUFLLENBQUMsQ0FBQztRQUM3QixFQUFDLFFBQVEsRUFBQyxXQUFXLEVBQUUsTUFBTSxFQUFDLEtBQUssRUFBRSxJQUFJLEVBQUMsSUFBSSxFQUFDLENBQUMsQ0FBQztRQUNqRCxFQUFDLFFBQVEsRUFBQywwQkFBMEIsRUFBRSxRQUFRLEVBQUMsS0FBSyxFQUFFLE1BQU0sRUFBQyxJQUFJLEVBQUMsQ0FDbkUsQ0FBQTtJQUVELElBQUksQ0FBQztRQUNILE1BQU0sSUFBSSxHQUFTLE1BQU0sTUFBTSxDQUFDLFlBQVksQ0FBQyxrQkFBa0IsRUFBRSxPQUFPLENBQUMsQ0FBQTtRQUN6RSxtQkFBbUIsQ0FBQyxHQUFHLENBQUMsT0FBTyxFQUFFLElBQUksQ0FBQyxDQUFBO1FBQ3RDLG9CQUFvQixDQUFDLElBQUksRUFBRSxNQUFNLENBQUMsTUFBTSxDQUFDLENBQUE7UUFFekMsSUFBSSxDQUFDLE9BQU8sQ0FBQyxDQUFDLElBQVcsRUFBRSxNQUFjLEVBQUMsRUFBRTtZQUMxQyxPQUFPLENBQUMsR0FBRyxDQUFDLGlCQUFpQixFQUFFLE9BQU8sRUFBRSxJQUFJLEVBQUUsTUFBTSxDQUFDLENBQUE7WUFDbkQsYUFBYSxDQUFDLElBQUksQ0FBQyxlQUFlLENBQUMsZ0JBQWdCLEVBQUUsRUFBQyxPQUFPLEVBQUUsSUFBSSxFQUFFLE1BQU0sRUFBQyxDQUFDLENBQUE7UUFDakYsQ0FBQyxDQUFDLENBQUE7UUFDRixPQUFPLElBQUksQ0FBQTtJQUNiLENBQUM7SUFBQyxPQUFPLEtBQVUsRUFBRSxDQUFDO1FBQ3BCLE9BQU8sQ0FBQyxLQUFLLENBQUMsc0NBQXNDLEVBQUUsS0FBSyxDQUFDLENBQUE7UUFDNUQsTUFBTSxLQUFLLENBQUE7SUFDYixDQUFDO0FBQ0gsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IExPQ0FMX0NSRUFUT1IsIGxzY1F1ZXN0Q29ubmVjdGlvbnMgfSBmcm9tIFwiLi9xdWVzdFwiXG5pbXBvcnQgeyBDbGllbnQgfSBmcm9tIFwiY29seXNldXMuanNcIlxuaW1wb3J0IHsgUm9vbSB9IGZyb20gXCJjb2x5c2V1cy5qc1wiXG5pbXBvcnQgeyBERUJVRywgTFNDUVVFU1RfRVZFTlRTIH0gZnJvbSBcIi4vZGVmaW5pdGlvbnNcIlxuaW1wb3J0IHsgbHNjUXVlc3RFdmVudCwgbHNjUXVlc3RVc2VyRGF0YSwgcGVuZGluZ1F1ZXN0Q29ubmVjdGlvbnMgfSBmcm9tIFwiLi9xdWVzdFwiXG5pbXBvcnQgeyBnZXRQbGF5ZXIgfSBmcm9tIFwiQGRjbC9zZGsvcGxheWVyc1wiXG5pbXBvcnQgeyBnZXRSZWFsbSB9IGZyb20gXCJ+c3lzdGVtL1J1bnRpbWVcIlxuaW1wb3J0IHsgZW5naW5lIH0gZnJvbSBcIkBkY2wvc2RrL2Vjc1wiXG5cblxubGV0IHBsYXllcjphbnlcblxuZnVuY3Rpb24gc2V0TFNDUXVlc3RMaXN0ZW5lcnMocm9vbTpSb29tLCB1c2VySWQ6c3RyaW5nKXtcbiAgcm9vbS5vbk1lc3NhZ2UoTFNDUVVFU1RfRVZFTlRTLlFVRVNUX0NPTk5FQ1RJT04sIChpbmZvOmFueSk9PntcbiAgICBjb25zb2xlLmxvZygncXVlc3QgY29ubmVjdGlvbiAnLCBpbmZvKVxuICAgIGxzY1F1ZXN0RXZlbnQuZW1pdChMU0NRVUVTVF9FVkVOVFMuUVVFU1RfQ09OTkVDVElPTiwgaW5mbylcbiAgfSlcblxuICByb29tLm9uTWVzc2FnZShMU0NRVUVTVF9FVkVOVFMuUVVFU1RfRVJST1IsIChpbmZvOmFueSk9PntcbiAgICBjb25zb2xlLmxvZygncXVlc3QgZXJyb3IgJywgaW5mbylcbiAgICBsc2NRdWVzdEV2ZW50LmVtaXQoTFNDUVVFU1RfRVZFTlRTLlFVRVNUX0VSUk9SLCBpbmZvKVxuICB9KVxuXG4gIHJvb20ub25NZXNzYWdlKExTQ1FVRVNUX0VWRU5UUy5RVUVTVF9EQVRBLCAoaW5mbzphbnkpPT57XG4gICAgY29uc29sZS5sb2coJ3VzZXIgcXVlc3QgZGF0YSAnLCBpbmZvKVxuICAgIGlmKGluZm8udXNlclF1ZXN0SW5mbyl7XG4gICAgICBsc2NRdWVzdFVzZXJEYXRhLnNldChpbmZvLnF1ZXN0SWQsIGluZm8udXNlclF1ZXN0SW5mbylcbiAgICB9XG4gICAgbHNjUXVlc3RFdmVudC5lbWl0KExTQ1FVRVNUX0VWRU5UUy5RVUVTVF9EQVRBLCBpbmZvKVxuICB9KVxuXG4gIHJvb20ub25NZXNzYWdlKExTQ1FVRVNUX0VWRU5UUy5RVUVTVF9TVEFSVEVELCAoaW5mbzphbnkpPT57XG4gICAgY29uc29sZS5sb2coJ3N0YXJ0ZWQgcXVlc3QgJywgaW5mbylcbiAgICBsc2NRdWVzdEV2ZW50LmVtaXQoTFNDUVVFU1RfRVZFTlRTLlFVRVNUX1NUQVJURUQsIGluZm8pXG4gIH0pXG5cbiAgcm9vbS5vbk1lc3NhZ2UoTFNDUVVFU1RfRVZFTlRTLlFVRVNUX0NPTVBMRVRFLCAoaW5mbzphbnkpPT57XG4gICAgY29uc29sZS5sb2coJ2NvbXBsZXRlIHF1ZXN0ICcsIGluZm8pXG4gICAgXG4gICAgLy8gSWYgdGhlIHNlcnZlciBzZW50IGNvbXBsZXRlIHVzZXIgcXVlc3QgaW5mbywgdXNlIGl0IGRpcmVjdGx5XG4gICAgaWYgKGluZm8udXNlclF1ZXN0SW5mbykge1xuICAgICAgbHNjUXVlc3RVc2VyRGF0YS5zZXQoaW5mby5xdWVzdElkLCBpbmZvLnVzZXJRdWVzdEluZm8pXG4gICAgfSBcbiAgICAvLyBGYWxsYmFjayB0byBvbGQgYmVoYXZpb3IgaWYgc2VydmVyIGRvZXNuJ3Qgc2VuZCBjb21wbGV0ZSBkYXRhXG4gICAgZWxzZSB7XG4gICAgICBsZXQgdXNlclF1ZXN0RGF0YSA9IGxzY1F1ZXN0VXNlckRhdGEuZ2V0KGluZm8ucXVlc3RJZClcbiAgICAgIGlmKHVzZXJRdWVzdERhdGEpe1xuICAgICAgICB1c2VyUXVlc3REYXRhLmNvbXBsZXRlZCA9IHRydWVcbiAgICAgIH1cbiAgICB9XG4gICAgXG4gICAgbHNjUXVlc3RFdmVudC5lbWl0KExTQ1FVRVNUX0VWRU5UUy5RVUVTVF9DT01QTEVURSwgaW5mbylcbiAgfSlcblxuICByb29tLm9uTWVzc2FnZShMU0NRVUVTVF9FVkVOVFMuUVVFU1RfRU5ELCAoaW5mbzphbnkpPT57XG4gICAgY29uc29sZS5sb2coJ2VuZGVkIHF1ZXN0ICcsIGluZm8pXG4gICAgbHNjUXVlc3RFdmVudC5lbWl0KExTQ1FVRVNUX0VWRU5UUy5RVUVTVF9FTkQsIGluZm8pXG4gIH0pXG5cbiAgcm9vbS5vbk1lc3NhZ2UoTFNDUVVFU1RfRVZFTlRTLlFVRVNUX1VQREFURSwgKGluZm86YW55KT0+e1xuICAgIGNvbnNvbGUubG9nKCd1cGRhdGUgcXVlc3QgJywgaW5mbylcbiAgICBsc2NRdWVzdFVzZXJEYXRhLnNldCh1c2VySWQsIGluZm8pXG4gICAgbHNjUXVlc3RFdmVudC5lbWl0KExTQ1FVRVNUX0VWRU5UUy5RVUVTVF9VUERBVEUsIGluZm8pXG4gIH0pXG5cbiAgcm9vbS5vbk1lc3NhZ2UoTFNDUVVFU1RfRVZFTlRTLlFVRVNUX1NURVBfQ09NUExFVEUsIChpbmZvOmFueSk9PntcbiAgICBjb25zb2xlLmxvZygnc3RlcCBjb21wbGV0ZSBxdWVzdCAnLCBpbmZvKVxuICAgIFxuICAgIC8vIElmIHRoZSBzZXJ2ZXIgc2VudCBjb21wbGV0ZSB1c2VyIHF1ZXN0IGluZm8sIHVzZSBpdCBkaXJlY3RseVxuICAgIGlmIChpbmZvLnVzZXJRdWVzdEluZm8pIHtcbiAgICAgIGxzY1F1ZXN0VXNlckRhdGEuc2V0KGluZm8ucXVlc3RJZCwgaW5mby51c2VyUXVlc3RJbmZvKVxuICAgIH1cbiAgICAvLyBGYWxsYmFjayB0byBvbGQgYmVoYXZpb3IgaWYgc2VydmVyIGRvZXNuJ3Qgc2VuZCBjb21wbGV0ZSBkYXRhXG4gICAgZWxzZSB7XG4gICAgICBsZXQgdXNlclF1ZXN0RGF0YSA9IGxzY1F1ZXN0VXNlckRhdGEuZ2V0KGluZm8ucXVlc3RJZClcbiAgICAgIGlmKHVzZXJRdWVzdERhdGEpe1xuICAgICAgICBsZXQgc3RlcCA9IHVzZXJRdWVzdERhdGEuc3RlcHMuZmluZCgoc3RlcDphbnkpPT5zdGVwLnN0ZXBJZCA9PT0gaW5mby5zdGVwSWQpXG4gICAgICAgIGlmKHN0ZXApe1xuICAgICAgICAgIHN0ZXAuY29tcGxldGVkID0gdHJ1ZVxuICAgICAgICB9XG4gICAgICB9XG4gICAgfVxuICAgIFxuICAgIGxzY1F1ZXN0RXZlbnQuZW1pdChMU0NRVUVTVF9FVkVOVFMuUVVFU1RfU1RFUF9DT01QTEVURSwgaW5mbylcbiAgfSlcblxuICByb29tLm9uTWVzc2FnZShMU0NRVUVTVF9FVkVOVFMuUVVFU1RfVEFTS19DT01QTEVURSwgKGluZm86YW55KT0+e1xuICAgIGNvbnNvbGUubG9nKCd0YXNrIGNvbXBsZXRlIHF1ZXN0ICcsIGluZm8pXG4gICAgXG4gICAgLy8gSWYgdGhlIHNlcnZlciBzZW50IGNvbXBsZXRlIHVzZXIgcXVlc3QgaW5mbywgdXNlIGl0IGRpcmVjdGx5XG4gICAgaWYgKGluZm8udXNlclF1ZXN0SW5mbykge1xuICAgICAgbHNjUXVlc3RVc2VyRGF0YS5zZXQoaW5mby5xdWVzdElkLCBpbmZvLnVzZXJRdWVzdEluZm8pXG4gICAgfSBcbiAgICAvLyBGYWxsYmFjayB0byBvbGQgYmVoYXZpb3IgaWYgc2VydmVyIGRvZXNuJ3Qgc2VuZCBjb21wbGV0ZSBkYXRhXG4gICAgZWxzZSB7XG4gICAgICBsZXQgdXNlclF1ZXN0RGF0YSA9IGxzY1F1ZXN0VXNlckRhdGEuZ2V0KGluZm8ucXVlc3RJZClcbiAgICAgIGlmKHVzZXJRdWVzdERhdGEpe1xuICAgICAgICBsZXQgc3RlcCA9IHVzZXJRdWVzdERhdGEuc3RlcHMuZmluZCgoc3RlcDphbnkpPT5zdGVwLnN0ZXBJZCA9PT0gaW5mby5zdGVwSWQpXG4gICAgICAgIGlmKHN0ZXApe1xuICAgICAgICAgIGxldCB0YXNrID0gc3RlcC50YXNrcy5maW5kKCh0YXNrOmFueSk9PnRhc2sudGFza0lkID09PSBpbmZvLnRhc2tJZClcbiAgICAgICAgICBpZih0YXNrKXtcbiAgICAgICAgICAgIHRhc2suY291bnQrK1xuICAgICAgICAgICAgdGFzay5jb21wbGV0ZWQgPSB0cnVlXG4gICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICB9XG4gICAgfVxuICAgIFxuICAgIGxzY1F1ZXN0RXZlbnQuZW1pdChMU0NRVUVTVF9FVkVOVFMuUVVFU1RfVEFTS19DT01QTEVURSwgaW5mbylcbiAgfSlcbn1cblxubGV0IHRpbWU6bnVtYmVyID0gMFxuZXhwb3J0IGZ1bmN0aW9uIENoZWNrUGxheWVyU3lzdGVtKGR0Om51bWJlcil7XG4gIGlmKHRpbWUgPiAwKXtcbiAgICB0aW1lIC09IGR0XG4gIH1lbHNle1xuICAgIHBsYXllciA9IGdldFBsYXllcigpXG4gICAgaWYoIXBsYXllcil7XG4gICAgICB0aW1lID0gMVxuICAgIH1lbHNle1xuICAgICAgZW5naW5lLnJlbW92ZVN5c3RlbShDaGVja1BsYXllclN5c3RlbSlcbiAgICB9XG4gIH1cbn1cblxuZXhwb3J0IGZ1bmN0aW9uIENvbm5lY3RRdWVzdFN5c3RlbSgpe1xuICBpZighcGxheWVyKSByZXR1cm5cblxuICBpZihwZW5kaW5nUXVlc3RDb25uZWN0aW9ucy5sZW5ndGggPiAwKXtcbiAgICBsZXQgcGVuZGluZ1F1ZXN0SWQ6c3RyaW5nID0gXCJcIiArIHBlbmRpbmdRdWVzdENvbm5lY3Rpb25zLnNoaWZ0KClcbiAgICBtYWtlUXVlc3RDb25uZWN0aW9uKHBlbmRpbmdRdWVzdElkKVxuICB9XG59XG5cbmFzeW5jIGZ1bmN0aW9uIG1ha2VRdWVzdENvbm5lY3Rpb24ocXVlc3RJZDpzdHJpbmcpe1xuICBjb25zdCByZWFsbSA9IGF3YWl0IGdldFJlYWxtKHt9KVxuXG4gIGNvbnN0IG9wdGlvbnM6YW55ID0ge1xuICAgIHVzZXJJZDogcGxheWVyLnVzZXJJZCxcbiAgICBuYW1lOiBwbGF5ZXIubmFtZSxcbiAgICByZWFsbTogTE9DQUxfQ1JFQVRPUiA/IFwibG9jYWwtdGVzdGluZ1wiIDogcmVhbG0ucmVhbG1JbmZvPy5iYXNlVXJsLFxuICAgIHF1ZXN0SWQ6IHF1ZXN0SWQsXG4gIH1cblxuICBsZXQgY2xpZW50ID0gbmV3IENsaWVudChERUJVRyA/IFxuICAgIHtob3N0bmFtZTonbG9jYWxob3N0Jywgc2VjdXJlOmZhbHNlLCBwb3J0OjUzNTN9IDogXG4gICAge2hvc3RuYW1lOidhbmd6YWFyLXBsYXphLmRjbC1pd2IuY28nLCBwYXRobmFtZTonL3dzJywgc2VjdXJlOnRydWV9XG4gIClcblxuICB0cnkge1xuICAgIGNvbnN0IHJvb206IFJvb20gPSBhd2FpdCBjbGllbnQuam9pbk9yQ3JlYXRlKCdhbmd6YWFyX3F1ZXN0aW5nJywgb3B0aW9ucylcbiAgICBsc2NRdWVzdENvbm5lY3Rpb25zLnNldChxdWVzdElkLCByb29tKVxuICAgIHNldExTQ1F1ZXN0TGlzdGVuZXJzKHJvb20sIHBsYXllci51c2VySWQpXG5cbiAgICByb29tLm9uTGVhdmUoKGNvZGU6bnVtYmVyLCByZWFzb24/OnN0cmluZyk9PntcbiAgICAgIGNvbnNvbGUubG9nKCdsZWZ0IHF1ZXN0IHJvb20nLCBxdWVzdElkLCBjb2RlLCByZWFzb24pXG4gICAgICAgIGxzY1F1ZXN0RXZlbnQuZW1pdChMU0NRVUVTVF9FVkVOVFMuUVVFU1RfRElTQ09OTkVDVCwge3F1ZXN0SWQsIGNvZGUsIHJlYXNvbn0pXG4gICAgfSlcbiAgICByZXR1cm4gcm9vbVxuICB9IGNhdGNoIChlcnJvcjogYW55KSB7XG4gICAgY29uc29sZS5lcnJvcignRXJyb3IgY29ubmVjdGluZyB0byBMU0MgUXVlc3QgU3lzdGVtJywgZXJyb3IpXG4gICAgdGhyb3cgZXJyb3JcbiAgfVxufSJdfQ==