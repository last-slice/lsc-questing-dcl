import { LOCAL_CREATOR, lscQuestConnections } from "./quest";
import { Client } from "colyseus.js";
import { LSCQUEST_EVENTS } from "./definitions";
import { lscQuestEvent, lscQuestUserData, pendingQuestConnections } from "./quest";
import { getPlayer } from "@dcl/sdk/players";
import { getRealm } from "~system/Runtime";
import { engine } from "@dcl/sdk/ecs";
let player;
function setLSCQuestListeners(room, userId) {
    room.onMessage(LSCQUEST_EVENTS.QUEST_CONNECTION, (info) => {
        console.log('quest connection ', info);
        lscQuestEvent.emit(LSCQUEST_EVENTS.QUEST_CONNECTION, info);
    });
    room.onMessage(LSCQUEST_EVENTS.QUEST_ERROR, (info) => {
        console.log('quest error ', info);
        lscQuestEvent.emit(LSCQUEST_EVENTS.QUEST_ERROR, info);
    });
    room.onMessage(LSCQUEST_EVENTS.QUEST_DATA, (info) => {
        console.log('user quest data ', info);
        if (info.userQuestInfo) {
            lscQuestUserData.set(info.questId, info.userQuestInfo);
        }
        lscQuestEvent.emit(LSCQUEST_EVENTS.QUEST_DATA, info);
    });
    room.onMessage(LSCQUEST_EVENTS.QUEST_STARTED, (info) => {
        console.log('started quest ', info);
        lscQuestEvent.emit(LSCQUEST_EVENTS.QUEST_STARTED, info);
    });
    room.onMessage(LSCQUEST_EVENTS.QUEST_COMPLETE, (info) => {
        console.log('complete quest ', info);
        if (info.userQuestInfo) {
            lscQuestUserData.set(info.questId, info.userQuestInfo);
        }
        else {
            let userQuestData = lscQuestUserData.get(info.questId);
            if (userQuestData) {
                userQuestData.completed = true;
            }
        }
        lscQuestEvent.emit(LSCQUEST_EVENTS.QUEST_COMPLETE, info);
    });
    room.onMessage(LSCQUEST_EVENTS.QUEST_END, (info) => {
        console.log('ended quest ', info);
        lscQuestEvent.emit(LSCQUEST_EVENTS.QUEST_END, info);
    });
    room.onMessage(LSCQUEST_EVENTS.QUEST_UPDATE, (info) => {
        console.log('update quest ', info);
        lscQuestUserData.set(userId, info);
        lscQuestEvent.emit(LSCQUEST_EVENTS.QUEST_UPDATE, info);
    });
    room.onMessage(LSCQUEST_EVENTS.QUEST_STEP_COMPLETE, (info) => {
        console.log('step complete quest ', info);
        if (info.userQuestInfo) {
            lscQuestUserData.set(info.questId, info.userQuestInfo);
        }
        else {
            let userQuestData = lscQuestUserData.get(info.questId);
            if (userQuestData) {
                let step = userQuestData.steps.find((step) => step.stepId === info.stepId);
                if (step) {
                    step.completed = true;
                }
            }
        }
        lscQuestEvent.emit(LSCQUEST_EVENTS.QUEST_STEP_COMPLETE, info);
    });
    room.onMessage(LSCQUEST_EVENTS.QUEST_TASK_COMPLETE, (info) => {
        console.log('task complete quest ', info);
        if (info.userQuestInfo) {
            lscQuestUserData.set(info.questId, info.userQuestInfo);
        }
        else {
            let userQuestData = lscQuestUserData.get(info.questId);
            if (userQuestData) {
                let step = userQuestData.steps.find((step) => step.stepId === info.stepId);
                if (step) {
                    let task = step.tasks.find((task) => task.taskId === info.taskId);
                    if (task) {
                        task.count++;
                        task.completed = true;
                    }
                }
            }
        }
        lscQuestEvent.emit(LSCQUEST_EVENTS.QUEST_TASK_COMPLETE, info);
    });
}
let time = 0;
export function CheckPlayerSystem(dt) {
    if (time > 0) {
        time -= dt;
    }
    else {
        player = getPlayer();
        if (!player) {
            time = 1;
        }
        else {
            engine.removeSystem(CheckPlayerSystem);
        }
    }
}
export function ConnectQuestSystem() {
    if (!player)
        return;
    if (pendingQuestConnections.length > 0) {
        let pendingQuestId = "" + pendingQuestConnections.shift();
        makeQuestConnection(pendingQuestId);
    }
}
async function makeQuestConnection(questId) {
    const realm = await getRealm({});
    const options = {
        userId: player.userId,
        name: player.name,
        realm: LOCAL_CREATOR ? "local-testing" : realm.realmInfo?.baseUrl,
        questId: questId,
    };
    let client = new Client(DEBUG ?
        { hostname: 'localhost', secure: false, port: 5353 } :
        { hostname: 'angzaar-plaza.dcl-iwb.co', pathname: '/ws', secure: true });
    try {
        const room = await client.joinOrCreate('angzaar_questing', options);
        lscQuestConnections.set(questId, room);
        setLSCQuestListeners(room, player.userId);
        room.onLeave((code, reason) => {
            console.log('left quest room', questId, code, reason);
            lscQuestEvent.emit(LSCQUEST_EVENTS.QUEST_DISCONNECT, { questId, code, reason });
        });
        return room;
    }
    catch (error) {
        console.error('Error connecting to LSC Quest System', error);
        throw error;
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY29ubmVjdGlvbi5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uL3NyYy9jb25uZWN0aW9uLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sRUFBRSxhQUFhLEVBQUUsbUJBQW1CLEVBQUUsTUFBTSxTQUFTLENBQUE7QUFDNUQsT0FBTyxFQUFFLE1BQU0sRUFBRSxNQUFNLGFBQWEsQ0FBQTtBQUVwQyxPQUFPLEVBQUUsZUFBZSxFQUFFLE1BQU0sZUFBZSxDQUFBO0FBQy9DLE9BQU8sRUFBRSxhQUFhLEVBQUUsZ0JBQWdCLEVBQUUsdUJBQXVCLEVBQUUsTUFBTSxTQUFTLENBQUE7QUFDbEYsT0FBTyxFQUFFLFNBQVMsRUFBRSxNQUFNLGtCQUFrQixDQUFBO0FBQzVDLE9BQU8sRUFBRSxRQUFRLEVBQUUsTUFBTSxpQkFBaUIsQ0FBQTtBQUMxQyxPQUFPLEVBQUUsTUFBTSxFQUFFLE1BQU0sY0FBYyxDQUFBO0FBR3JDLElBQUksTUFBVSxDQUFBO0FBRWQsU0FBUyxvQkFBb0IsQ0FBQyxJQUFTLEVBQUUsTUFBYTtJQUNwRCxJQUFJLENBQUMsU0FBUyxDQUFDLGVBQWUsQ0FBQyxnQkFBZ0IsRUFBRSxDQUFDLElBQVEsRUFBQyxFQUFFO1FBQzNELE9BQU8sQ0FBQyxHQUFHLENBQUMsbUJBQW1CLEVBQUUsSUFBSSxDQUFDLENBQUE7UUFDdEMsYUFBYSxDQUFDLElBQUksQ0FBQyxlQUFlLENBQUMsZ0JBQWdCLEVBQUUsSUFBSSxDQUFDLENBQUE7SUFDNUQsQ0FBQyxDQUFDLENBQUE7SUFFRixJQUFJLENBQUMsU0FBUyxDQUFDLGVBQWUsQ0FBQyxXQUFXLEVBQUUsQ0FBQyxJQUFRLEVBQUMsRUFBRTtRQUN0RCxPQUFPLENBQUMsR0FBRyxDQUFDLGNBQWMsRUFBRSxJQUFJLENBQUMsQ0FBQTtRQUNqQyxhQUFhLENBQUMsSUFBSSxDQUFDLGVBQWUsQ0FBQyxXQUFXLEVBQUUsSUFBSSxDQUFDLENBQUE7SUFDdkQsQ0FBQyxDQUFDLENBQUE7SUFF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Q0FBQTtRQUM1RCxNQUFNLEtBQUssQ0FBQTtJQUNiLENBQUM7QUFDSCxDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgTE9DQUxfQ1JFQVRPUiwgbHNjUXVlc3RDb25uZWN0aW9ucyB9IGZyb20gXCIuL3F1ZXN0XCJcbmltcG9ydCB7IENsaWVudCB9IGZyb20gXCJjb2x5c2V1cy5qc1wiXG5pbXBvcnQgeyBSb29tIH0gZnJvbSBcImNvbHlzZXVzLmpzXCJcbmltcG9ydCB7IExTQ1FVRVNUX0VWRU5UUyB9IGZyb20gXCIuL2RlZmluaXRpb25zXCJcbmltcG9ydCB7IGxzY1F1ZXN0RXZlbnQsIGxzY1F1ZXN0VXNlckRhdGEsIHBlbmRpbmdRdWVzdENvbm5lY3Rpb25zIH0gZnJvbSBcIi4vcXVlc3RcIlxuaW1wb3J0IHsgZ2V0UGxheWVyIH0gZnJvbSBcIkBkY2wvc2RrL3BsYXllcnNcIlxuaW1wb3J0IHsgZ2V0UmVhbG0gfSBmcm9tIFwifnN5c3RlbS9SdW50aW1lXCJcbmltcG9ydCB7IGVuZ2luZSB9IGZyb20gXCJAZGNsL3Nkay9lY3NcIlxuXG5cbmxldCBwbGF5ZXI6YW55XG5cbmZ1bmN0aW9uIHNldExTQ1F1ZXN0TGlzdGVuZXJzKHJvb206Um9vbSwgdXNlcklkOnN0cmluZyl7XG4gIHJvb20ub25NZXNzYWdlKExTQ1FVRVNUX0VWRU5UUy5RVUVTVF9DT05ORUNUSU9OLCAoaW5mbzphbnkpPT57XG4gICAgY29uc29sZS5sb2coJ3F1ZXN0IGNvbm5lY3Rpb24gJywgaW5mbylcbiAgICBsc2NRdWVzdEV2ZW50LmVtaXQoTFNDUVVFU1RfRVZFTlRTLlFVRVNUX0NPTk5FQ1RJT04sIGluZm8pXG4gIH0pXG5cbiAgcm9vbS5vbk1lc3NhZ2UoTFNDUVVFU1RfRVZFTlRTLlFVRVNUX0VSUk9SLCAoaW5mbzphbnkpPT57XG4gICAgY29uc29sZS5sb2coJ3F1ZXN0IGVycm9yICcsIGluZm8pXG4gICAgbHNjUXVlc3RFdmVudC5lbWl0KExTQ1FVRVNUX0VWRU5UUy5RVUVTVF9FUlJPUiwgaW5mbylcbiAgfSlcblxuICByb29tLm9uTWVzc2FnZShMU0NRVUVTVF9FVkVOVFMuUVVFU1RfREFUQSwgKGluZm86YW55KT0+e1xuICAgIGNvbnNvbGUubG9nKCd1c2VyIHF1ZXN0IGRhdGEgJywgaW5mbylcbiAgICBpZihpbmZvLnVzZXJRdWVzdEluZm8pe1xuICAgICAgbHNjUXVlc3RVc2VyRGF0YS5zZXQoaW5mby5xdWVzdElkLCBpbmZvLnVzZXJRdWVzdEluZm8pXG4gICAgfVxuICAgIGxzY1F1ZXN0RXZlbnQuZW1pdChMU0NRVUVTVF9FVkVOVFMuUVVFU1RfREFUQSwgaW5mbylcbiAgfSlcblxuICByb29tLm9uTWVzc2FnZShMU0NRVUVTVF9FVkVOVFMuUVVFU1RfU1RBUlRFRCwgKGluZm86YW55KT0+e1xuICAgIGNvbnNvbGUubG9nKCdzdGFydGVkIHF1ZXN0ICcsIGluZm8pXG4gICAgbHNjUXVlc3RFdmVudC5lbWl0KExTQ1FVRVNUX0VWRU5UUy5RVUVTVF9TVEFSVEVELCBpbmZvKVxuICB9KVxuXG4gIHJvb20ub25NZXNzYWdlKExTQ1FVRVNUX0VWRU5UUy5RVUVTVF9DT01QTEVURSwgKGluZm86YW55KT0+e1xuICAgIGNvbnNvbGUubG9nKCdjb21wbGV0ZSBxdWVzdCAnLCBpbmZvKVxuICAgIFxuICAgIC8vIElmIHRoZSBzZXJ2ZXIgc2VudCBjb21wbGV0ZSB1c2VyIHF1ZXN0IGluZm8sIHVzZSBpdCBkaXJlY3RseVxuICAgIGlmIChpbmZvLnVzZXJRdWVzdEluZm8pIHtcbiAgICAgIGxzY1F1ZXN0VXNlckRhdGEuc2V0KGluZm8ucXVlc3RJZCwgaW5mby51c2VyUXVlc3RJbmZvKVxuICAgIH0gXG4gICAgLy8gRmFsbGJhY2sgdG8gb2xkIGJlaGF2aW9yIGlmIHNlcnZlciBkb2Vzbid0IHNlbmQgY29tcGxldGUgZGF0YVxuICAgIGVsc2Uge1xuICAgICAgbGV0IHVzZXJRdWVzdERhdGEgPSBsc2NRdWVzdFVzZXJEYXRhLmdldChpbmZvLnF1ZXN0SWQpXG4gICAgICBpZih1c2VyUXVlc3REYXRhKXtcbiAgICAgICAgdXNlclF1ZXN0RGF0YS5jb21wbGV0ZWQgPSB0cnVlXG4gICAgICB9XG4gICAgfVxuICAgIFxuICAgIGxzY1F1ZXN0RXZlbnQuZW1pdChMU0NRVUVTVF9FVkVOVFMuUVVFU1RfQ09NUExFVEUsIGluZm8pXG4gIH0pXG5cbiAgcm9vbS5vbk1lc3NhZ2UoTFNDUVVFU1RfRVZFTlRTLlFVRVNUX0VORCwgKGluZm86YW55KT0+e1xuICAgIGNvbnNvbGUubG9nKCdlbmRlZCBxdWVzdCAnLCBpbmZvKVxuICAgIGxzY1F1ZXN0RXZlbnQuZW1pdChMU0NRVUVTVF9FVkVOVFMuUVVFU1RfRU5ELCBpbmZvKVxuICB9KVxuXG4gIHJvb20ub25NZXNzYWdlKExTQ1FVRVNUX0VWRU5UUy5RVUVTVF9VUERBVEUsIChpbmZvOmFueSk9PntcbiAgICBjb25zb2xlLmxvZygndXBkYXRlIHF1ZXN0ICcsIGluZm8pXG4gICAgbHNjUXVlc3RVc2VyRGF0YS5zZXQodXNlcklkLCBpbmZvKVxuICAgIGxzY1F1ZXN0RXZlbnQuZW1pdChMU0NRVUVTVF9FVkVOVFMuUVVFU1RfVVBEQVRFLCBpbmZvKVxuICB9KVxuXG4gIHJvb20ub25NZXNzYWdlKExTQ1FVRVNUX0VWRU5UUy5RVUVTVF9TVEVQX0NPTVBMRVRFLCAoaW5mbzphbnkpPT57XG4gICAgY29uc29sZS5sb2coJ3N0ZXAgY29tcGxldGUgcXVlc3QgJywgaW5mbylcbiAgICBcbiAgICAvLyBJZiB0aGUgc2VydmVyIHNlbnQgY29tcGxldGUgdXNlciBxdWVzdCBpbmZvLCB1c2UgaXQgZGlyZWN0bHlcbiAgICBpZiAoaW5mby51c2VyUXVlc3RJbmZvKSB7XG4gICAgICBsc2NRdWVzdFVzZXJEYXRhLnNldChpbmZvLnF1ZXN0SWQsIGluZm8udXNlclF1ZXN0SW5mbylcbiAgICB9XG4gICAgLy8gRmFsbGJhY2sgdG8gb2xkIGJlaGF2aW9yIGlmIHNlcnZlciBkb2Vzbid0IHNlbmQgY29tcGxldGUgZGF0YVxuICAgIGVsc2Uge1xuICAgICAgbGV0IHVzZXJRdWVzdERhdGEgPSBsc2NRdWVzdFVzZXJEYXRhLmdldChpbmZvLnF1ZXN0SWQpXG4gICAgICBpZih1c2VyUXVlc3REYXRhKXtcbiAgICAgICAgbGV0IHN0ZXAgPSB1c2VyUXVlc3REYXRhLnN0ZXBzLmZpbmQoKHN0ZXA6YW55KT0+c3RlcC5zdGVwSWQgPT09IGluZm8uc3RlcElkKVxuICAgICAgICBpZihzdGVwKXtcbiAgICAgICAgICBzdGVwLmNvbXBsZXRlZCA9IHRydWVcbiAgICAgICAgfVxuICAgICAgfVxuICAgIH1cbiAgICBcbiAgICBsc2NRdWVzdEV2ZW50LmVtaXQoTFNDUVVFU1RfRVZFTlRTLlFVRVNUX1NURVBfQ09NUExFVEUsIGluZm8pXG4gIH0pXG5cbiAgcm9vbS5vbk1lc3NhZ2UoTFNDUVVFU1RfRVZFTlRTLlFVRVNUX1RBU0tfQ09NUExFVEUsIChpbmZvOmFueSk9PntcbiAgICBjb25zb2xlLmxvZygndGFzayBjb21wbGV0ZSBxdWVzdCAnLCBpbmZvKVxuICAgIFxuICAgIC8vIElmIHRoZSBzZXJ2ZXIgc2VudCBjb21wbGV0ZSB1c2VyIHF1ZXN0IGluZm8sIHVzZSBpdCBkaXJlY3RseVxuICAgIGlmIChpbmZvLnVzZXJRdWVzdEluZm8pIHtcbiAgICAgIGxzY1F1ZXN0VXNlckRhdGEuc2V0KGluZm8ucXVlc3RJZCwgaW5mby51c2VyUXVlc3RJbmZvKVxuICAgIH0gXG4gICAgLy8gRmFsbGJhY2sgdG8gb2xkIGJlaGF2aW9yIGlmIHNlcnZlciBkb2Vzbid0IHNlbmQgY29tcGxldGUgZGF0YVxuICAgIGVsc2Uge1xuICAgICAgbGV0IHVzZXJRdWVzdERhdGEgPSBsc2NRdWVzdFVzZXJEYXRhLmdldChpbmZvLnF1ZXN0SWQpXG4gICAgICBpZih1c2VyUXVlc3REYXRhKXtcbiAgICAgICAgbGV0IHN0ZXAgPSB1c2VyUXVlc3REYXRhLnN0ZXBzLmZpbmQoKHN0ZXA6YW55KT0+c3RlcC5zdGVwSWQgPT09IGluZm8uc3RlcElkKVxuICAgICAgICBpZihzdGVwKXtcbiAgICAgICAgICBsZXQgdGFzayA9IHN0ZXAudGFza3MuZmluZCgodGFzazphbnkpPT50YXNrLnRhc2tJZCA9PT0gaW5mby50YXNrSWQpXG4gICAgICAgICAgaWYodGFzayl7XG4gICAgICAgICAgICB0YXNrLmNvdW50KytcbiAgICAgICAgICAgIHRhc2suY29tcGxldGVkID0gdHJ1ZVxuICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgfVxuICAgIH1cbiAgICBcbiAgICBsc2NRdWVzdEV2ZW50LmVtaXQoTFNDUVVFU1RfRVZFTlRTLlFVRVNUX1RBU0tfQ09NUExFVEUsIGluZm8pXG4gIH0pXG59XG5cbmxldCB0aW1lOm51bWJlciA9IDBcbmV4cG9ydCBmdW5jdGlvbiBDaGVja1BsYXllclN5c3RlbShkdDpudW1iZXIpe1xuICBpZih0aW1lID4gMCl7XG4gICAgdGltZSAtPSBkdFxuICB9ZWxzZXtcbiAgICBwbGF5ZXIgPSBnZXRQbGF5ZXIoKVxuICAgIGlmKCFwbGF5ZXIpe1xuICAgICAgdGltZSA9IDFcbiAgICB9ZWxzZXtcbiAgICAgIGVuZ2luZS5yZW1vdmVTeXN0ZW0oQ2hlY2tQbGF5ZXJTeXN0ZW0pXG4gICAgfVxuICB9XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBDb25uZWN0UXVlc3RTeXN0ZW0oKXtcbiAgaWYoIXBsYXllcikgcmV0dXJuXG5cbiAgaWYocGVuZGluZ1F1ZXN0Q29ubmVjdGlvbnMubGVuZ3RoID4gMCl7XG4gICAgbGV0IHBlbmRpbmdRdWVzdElkOnN0cmluZyA9IFwiXCIgKyBwZW5kaW5nUXVlc3RDb25uZWN0aW9ucy5zaGlmdCgpXG4gICAgbWFrZVF1ZXN0Q29ubmVjdGlvbihwZW5kaW5nUXVlc3RJZClcbiAgfVxufVxuXG5hc3luYyBmdW5jdGlvbiBtYWtlUXVlc3RDb25uZWN0aW9uKHF1ZXN0SWQ6c3RyaW5nKXtcbiAgY29uc3QgcmVhbG0gPSBhd2FpdCBnZXRSZWFsbSh7fSlcblxuICBjb25zdCBvcHRpb25zOmFueSA9IHtcbiAgICB1c2VySWQ6IHBsYXllci51c2VySWQsXG4gICAgbmFtZTogcGxheWVyLm5hbWUsXG4gICAgcmVhbG06IExPQ0FMX0NSRUFUT1IgPyBcImxvY2FsLXRlc3RpbmdcIiA6IHJlYWxtLnJlYWxtSW5mbz8uYmFzZVVybCxcbiAgICBxdWVzdElkOiBxdWVzdElkLFxuICB9XG5cbiAgbGV0IGNsaWVudCA9IG5ldyBDbGllbnQoREVCVUcgPyBcbiAgICB7aG9zdG5hbWU6J2xvY2FsaG9zdCcsIHNlY3VyZTpmYWxzZSwgcG9ydDo1MzUzfSA6IFxuICAgIHtob3N0bmFtZTonYW5nemFhci1wbGF6YS5kY2wtaXdiLmNvJywgcGF0aG5hbWU6Jy93cycsIHNlY3VyZTp0cnVlfVxuICApXG5cbiAgdHJ5IHtcbiAgICBjb25zdCByb29tOiBSb29tID0gYXdhaXQgY2xpZW50LmpvaW5PckNyZWF0ZSgnYW5nemFhcl9xdWVzdGluZycsIG9wdGlvbnMpXG4gICAgbHNjUXVlc3RDb25uZWN0aW9ucy5zZXQocXVlc3RJZCwgcm9vbSlcbiAgICBzZXRMU0NRdWVzdExpc3RlbmVycyhyb29tLCBwbGF5ZXIudXNlcklkKVxuXG4gICAgcm9vbS5vbkxlYXZlKChjb2RlOm51bWJlciwgcmVhc29uPzpzdHJpbmcpPT57XG4gICAgICBjb25zb2xlLmxvZygnbGVmdCBxdWVzdCByb29tJywgcXVlc3RJZCwgY29kZSwgcmVhc29uKVxuICAgICAgICBsc2NRdWVzdEV2ZW50LmVtaXQoTFNDUVVFU1RfRVZFTlRTLlFVRVNUX0RJU0NPTk5FQ1QsIHtxdWVzdElkLCBjb2RlLCByZWFzb259KVxuICAgIH0pXG4gICAgcmV0dXJuIHJvb21cbiAgfSBjYXRjaCAoZXJyb3I6IGFueSkge1xuICAgIGNvbnNvbGUuZXJyb3IoJ0Vycm9yIGNvbm5lY3RpbmcgdG8gTFNDIFF1ZXN0IFN5c3RlbScsIGVycm9yKVxuICAgIHRocm93IGVycm9yXG4gIH1cbn0iXX0=