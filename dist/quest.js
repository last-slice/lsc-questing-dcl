import { engine, Material, MeshRenderer, TextShape, Transform } from '@dcl/sdk/ecs';
import { Color4, Vector3 } from '@dcl/sdk/math';
import { getPlayer } from "@dcl/sdk/players";
import { getRealm } from '~system/Runtime';
import { Client } from 'colyseus.js';
import mitt from 'mitt';
import './polyfill';
const DEBUG = true;
let player;
let pendingQuestConnections = [];
export const lscQuestEvent = mitt();
export var LSCQUEST_EVENTS;
(function (LSCQUEST_EVENTS) {
    LSCQUEST_EVENTS["QUEST_CONNECTION"] = "QUEST_CONNECTION";
    LSCQUEST_EVENTS["QUEST_ERROR"] = "QUEST_ERROR";
    LSCQUEST_EVENTS["QUEST_DATA"] = "QUEST_DATA";
    LSCQUEST_EVENTS["QUEST_STARTED"] = "QUEST_STARTED";
    LSCQUEST_EVENTS["QUEST_COMPLETE"] = "QUEST_COMPLETE";
    LSCQUEST_EVENTS["QUEST_END"] = "QUEST_END";
    LSCQUEST_EVENTS["QUEST_UPDATE"] = "QUEST_UPDATE";
    LSCQUEST_EVENTS["QUEST_DISCONNECT"] = "QUEST_DISCONNECT";
    LSCQUEST_EVENTS["QUEST_ACTION"] = "QUEST_ACTION";
    LSCQUEST_EVENTS["QUEST_START"] = "QUEST_START";
    LSCQUEST_EVENTS["QUEST_STEP_COMPLETE"] = "STEP_COMPLETE";
    LSCQUEST_EVENTS["QUEST_TASK_COMPLETE"] = "TASK_COMPLETE";
})(LSCQUEST_EVENTS || (LSCQUEST_EVENTS = {}));
export const lscQuestConnections = new Map();
export const lscQuestUserData = new Map();
export async function LSCQuestConnect(questId) {
    console.log('connecting to quest', questId);
    engine.addSystem(CheckPlayerSystem);
    engine.addSystem(ConnectQuestSystem);
    if (lscQuestConnections.has(questId))
        return;
    pendingQuestConnections.push(questId);
}
export function LSCQuestStart(questId) {
    let questConnection = lscQuestConnections.get(questId);
    if (!questConnection)
        return;
    try {
        questConnection.send(LSCQUEST_EVENTS.QUEST_START, { questId });
    }
    catch (e) {
        console.log('error sending quest action', e);
    }
}
export function LSCQuestAction(questId, stepId, taskId) {
    let questConnection = lscQuestConnections.get(questId);
    if (!questConnection)
        return;
    try {
        questConnection.send(LSCQUEST_EVENTS.QUEST_ACTION, { questId, stepId, taskId, metaverse: "DECENTRALAND" });
    }
    catch (e) {
        console.log('error sending quest action', e);
    }
}
function setLSCQuestListeners(room, userId) {
    room.onMessage(LSCQUEST_EVENTS.QUEST_CONNECTION, (info) => {
        console.log('quest connection ', info);
        lscQuestEvent.emit(LSCQUEST_EVENTS.QUEST_CONNECTION, info);
    });
    room.onMessage(LSCQUEST_EVENTS.QUEST_ERROR, (info) => {
        console.log('quest error ', info);
        lscQuestEvent.emit(LSCQUEST_EVENTS.QUEST_ERROR, info);
    });
    room.onMessage(LSCQUEST_EVENTS.QUEST_DATA, (info) => {
        console.log('user quest data ', info);
        if (info.userQuestInfo) {
            lscQuestUserData.set(info.questId, info.userQuestInfo);
        }
        lscQuestEvent.emit(LSCQUEST_EVENTS.QUEST_DATA, info);
    });
    room.onMessage(LSCQUEST_EVENTS.QUEST_STARTED, (info) => {
        console.log('started quest ', info);
        lscQuestEvent.emit(LSCQUEST_EVENTS.QUEST_STARTED, info);
    });
    room.onMessage(LSCQUEST_EVENTS.QUEST_COMPLETE, (info) => {
        console.log('complete quest ', info);
        if (info.userQuestInfo) {
            lscQuestUserData.set(info.questId, info.userQuestInfo);
        }
        else {
            let userQuestData = lscQuestUserData.get(info.questId);
            if (userQuestData) {
                userQuestData.completed = true;
            }
        }
        lscQuestEvent.emit(LSCQUEST_EVENTS.QUEST_COMPLETE, info);
    });
    room.onMessage(LSCQUEST_EVENTS.QUEST_END, (info) => {
        console.log('ended quest ', info);
        lscQuestEvent.emit(LSCQUEST_EVENTS.QUEST_END, info);
    });
    room.onMessage(LSCQUEST_EVENTS.QUEST_UPDATE, (info) => {
        console.log('update quest ', info);
        lscQuestUserData.set(userId, info);
        lscQuestEvent.emit(LSCQUEST_EVENTS.QUEST_UPDATE, info);
    });
    room.onMessage(LSCQUEST_EVENTS.QUEST_STEP_COMPLETE, (info) => {
        console.log('step complete quest ', info);
        if (info.userQuestInfo) {
            lscQuestUserData.set(info.questId, info.userQuestInfo);
        }
        else {
            let userQuestData = lscQuestUserData.get(info.questId);
            if (userQuestData) {
                let step = userQuestData.steps.find((step) => step.stepId === info.stepId);
                if (step) {
                    step.completed = true;
                }
            }
        }
        lscQuestEvent.emit(LSCQUEST_EVENTS.QUEST_STEP_COMPLETE, info);
    });
    room.onMessage(LSCQUEST_EVENTS.QUEST_TASK_COMPLETE, (info) => {
        console.log('task complete quest ', info);
        if (info.userQuestInfo) {
            lscQuestUserData.set(info.questId, info.userQuestInfo);
        }
        else {
            let userQuestData = lscQuestUserData.get(info.questId);
            if (userQuestData) {
                let step = userQuestData.steps.find((step) => step.stepId === info.stepId);
                if (step) {
                    let task = step.tasks.find((task) => task.taskId === info.taskId);
                    if (task) {
                        task.count++;
                        task.completed = true;
                    }
                }
            }
        }
        lscQuestEvent.emit(LSCQUEST_EVENTS.QUEST_TASK_COMPLETE, info);
    });
}
let time = 0;
function CheckPlayerSystem(dt) {
    if (time > 0) {
        time -= dt;
    }
    else {
        player = getPlayer();
        if (!player) {
            time = 1;
        }
        else {
            engine.removeSystem(CheckPlayerSystem);
        }
    }
}
function ConnectQuestSystem() {
    if (!player)
        return;
    console.log('connecting quest system');
    if (pendingQuestConnections.length > 0) {
        let pendingQuestId = "" + pendingQuestConnections.shift();
        makeQuestConnection(pendingQuestId);
    }
}
async function makeQuestConnection(questId) {
    const realm = await getRealm({});
    const options = {
        userId: player.userId,
        name: player.name,
        realm: realm.realmInfo?.baseUrl,
        questId: questId,
    };
    let client = new Client(DEBUG ?
        { hostname: 'localhost', secure: false, port: 5353 } :
        { hostname: 'angzaar-plaza.dcl-iwb.co', pathname: '/ws', secure: true });
    try {
        const room = await client.joinOrCreate('angzaar_questing', options);
        lscQuestConnections.set(questId, room);
        setLSCQuestListeners(room, player.userId);
        room.onLeave((code, reason) => {
            console.log('left quest room', questId, code, reason);
            lscQuestEvent.emit(LSCQUEST_EVENTS.QUEST_DISCONNECT, { questId, code, reason });
        });
        return room;
    }
    catch (error) {
        console.error('Error connecting to LSC Quest System', error);
        throw error;
    }
}
export function LSCQuestLeaderboard(questId, position, updateInterval, limit, order = 'asc', sortBy = 'elapsedTime', completed = true, showBackground = true, title = "Leaderboard") {
    let leaderboard = engine.addEntity();
    Transform.create(leaderboard, { position });
    const rowWidth = 3;
    const rowHeight = 0.4;
    function formatScoreType(type) {
        if (type === 'elapsedTime')
            return 'Time';
        return type.charAt(0).toUpperCase() + type.slice(1);
    }
    const titleEntity = engine.addEntity();
    Transform.create(titleEntity, {
        parent: leaderboard,
        position: Vector3.create(0, 0.6, 0)
    });
    TextShape.create(titleEntity, {
        text: title,
        fontSize: 2.5,
        textAlign: 4
    });
    const leftPos = -1.2;
    const centerPos = 0;
    const rightPos = 1.2;
    const headerEntity = engine.addEntity();
    Transform.create(headerEntity, {
        parent: leaderboard,
        position: Vector3.create(0, 0.2, 0)
    });
    const headerBgEntity = engine.addEntity();
    Transform.create(headerBgEntity, {
        parent: headerEntity,
        position: Vector3.create(0, 0, 0.03),
        scale: Vector3.create(rowWidth, rowHeight, 1)
    });
    MeshRenderer.setPlane(headerBgEntity);
    Material.setPbrMaterial(headerBgEntity, {
        albedoColor: Color4.create(0 / 255, 255 / 255, 213 / 255, 1)
    });
    const rankHeaderEntity = engine.addEntity();
    Transform.create(rankHeaderEntity, {
        parent: headerEntity,
        position: Vector3.create(leftPos, 0, 0.02)
    });
    TextShape.create(rankHeaderEntity, {
        text: "Rank",
        fontSize: 1.5,
        textAlign: 4
    });
    const nameHeaderEntity = engine.addEntity();
    Transform.create(nameHeaderEntity, {
        parent: headerEntity,
        position: Vector3.create(centerPos - 0.4, 0, 0.02)
    });
    TextShape.create(nameHeaderEntity, {
        text: "Player",
        fontSize: 1.5,
        textAlign: 3
    });
    const scoreHeaderEntity = engine.addEntity();
    Transform.create(scoreHeaderEntity, {
        parent: headerEntity,
        position: Vector3.create(rightPos, 0, 0.02)
    });
    TextShape.create(scoreHeaderEntity, {
        text: formatScoreType(sortBy),
        fontSize: 1.5,
        textAlign: 4
    });
    const leaderboardRows = [];
    for (let i = 0; i < limit; i++) {
        const rowEntity = engine.addEntity();
        Transform.create(rowEntity, {
            parent: leaderboard,
            position: Vector3.create(0, -i * 0.5 - 0.2, 0)
        });
        const backgroundEntity = engine.addEntity();
        if (showBackground) {
            Transform.create(backgroundEntity, {
                parent: rowEntity,
                position: Vector3.create(0, 0, 0.01),
                scale: Vector3.create(rowWidth, rowHeight, 1)
            });
            MeshRenderer.setPlane(backgroundEntity);
            Material.setPbrMaterial(backgroundEntity, {
                albedoColor: i % 2 === 0 ?
                    Color4.create(18 / 255, 23 / 255, 37 / 255, 1) :
                    Color4.create(26 / 255, 34 / 255, 53 / 255, 1)
            });
        }
        else {
            Transform.create(backgroundEntity, {
                parent: rowEntity,
                scale: Vector3.Zero()
            });
        }
        const rankEntity = engine.addEntity();
        Transform.create(rankEntity, {
            parent: rowEntity,
            position: Vector3.create(leftPos, 0, 0)
        });
        TextShape.create(rankEntity, { text: `#${i + 1}`, fontSize: 1.5 });
        const profileEntity = engine.addEntity();
        Transform.create(profileEntity, {
            parent: rowEntity,
            position: Vector3.create(centerPos - 0.8, 0, 0),
            scale: Vector3.create(0.3, 0.3, 0.3)
        });
        MeshRenderer.setPlane(profileEntity);
        Material.setPbrMaterial(profileEntity, {
            texture: Material.Texture.Avatar({
                userId: '',
            }),
        });
        const nameEntity = engine.addEntity();
        Transform.create(nameEntity, {
            parent: rowEntity,
            position: Vector3.create(centerPos - 0.4, 0, 0)
        });
        TextShape.create(nameEntity, { text: `Name`, fontSize: 1.5, textAlign: 3 });
        const scoreEntity = engine.addEntity();
        Transform.create(scoreEntity, {
            parent: rowEntity,
            position: Vector3.create(rightPos, 0, 0)
        });
        TextShape.create(scoreEntity, { text: `Score`, fontSize: 1.5 });
        leaderboardRows.push({
            rank: i + 1,
            rowEntity,
            backgroundEntity,
            rankEntity,
            profileEntity,
            nameEntity,
            scoreEntity
        });
    }
    let time = 0;
    function leaderboardUpdate(dt) {
        if (time > 0) {
            time -= dt;
        }
        else {
            time = updateInterval;
            updateLSCQuestLeaderboard();
        }
    }
    async function updateLSCQuestLeaderboard() {
        try {
            const playerData = getPlayer();
            const playerID = playerData ? playerData.userId : '';
            const playerName = playerData?.name || 'You';
            let params = [`completed=${completed}`, `order=${order}`, `limit=${limit}`, `sortBy=${sortBy}`];
            let response = await fetch(`http://localhost:5353/api/quests/${questId}/users?` + params.join('&'));
            let data = await response.json();
            console.log('leaderboard data:', data);
            for (let i = 0; i < leaderboardRows.length; i++) {
                const row = leaderboardRows[i];
                const rowData = data[i];
                if (rowData) {
                    if (!Transform.has(row.rowEntity))
                        continue;
                    Transform.getMutable(row.rowEntity).scale = Vector3.create(1, 1, 1);
                    if (showBackground) {
                        Transform.getMutable(row.backgroundEntity).scale = Vector3.create(rowWidth, rowHeight, 1);
                    }
                    const rankText = `#${i + 1}`;
                    TextShape.getMutable(row.rankEntity).text = rankText;
                    Material.setPbrMaterial(row.profileEntity, {
                        texture: Material.Texture.Avatar({
                            userId: rowData.userId,
                        }),
                    });
                    const name = rowData.name || 'Anonymous';
                    TextShape.getMutable(row.nameEntity).text = name;
                    let scoreText = '';
                    if (sortBy === 'elapsedTime') {
                        const ms = rowData.elapsedTime * 1000;
                        const seconds = Math.floor(ms / 1000);
                        const minutes = Math.floor(seconds / 60);
                        const hours = Math.floor(minutes / 60);
                        if (hours > 0) {
                            scoreText = `${hours}h ${minutes % 60}m`;
                        }
                        else if (minutes > 0) {
                            scoreText = `${minutes}m ${seconds % 60}s`;
                        }
                        else {
                            scoreText = `${seconds}s`;
                        }
                    }
                    else {
                        scoreText = rowData[sortBy]?.toString() || '0';
                    }
                    TextShape.getMutable(row.scoreEntity).text = scoreText;
                }
                else {
                    if (Transform.has(row.rowEntity)) {
                        Transform.getMutable(row.rowEntity).scale = Vector3.Zero();
                        if (showBackground) {
                            Transform.getMutable(row.backgroundEntity).scale = Vector3.Zero();
                        }
                    }
                }
            }
        }
        catch (e) {
            console.log('error updating quest leaderboard', e);
        }
    }
    engine.addSystem(leaderboardUpdate);
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicXVlc3QuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi9zcmMvcXVlc3QudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUFFLE1BQU0sRUFBVSxRQUFRLEVBQUUsWUFBWSxFQUFpQixTQUFTLEVBQUUsU0FBUyxFQUFFLE1BQU0sY0FBYyxDQUFBO0FBRTFHLE9BQU8sRUFBRSxNQUFNLEVBQUUsT0FBTyxFQUFFLE1BQU0sZUFBZSxDQUFBO0FBQy9DLE9BQU8sRUFBQyxTQUFTLEVBQUMsTUFBTSxrQkFBa0IsQ0FBQztBQUMzQyxPQUFPLEVBQUUsUUFBUSxFQUFFLE1BQU0saUJBQWlCLENBQUE7QUFDMUMsT0FBTyxFQUFFLE1BQU0sRUFBUSxNQUFNLGFBQWEsQ0FBQTtBQUMxQyxPQUFPLElBQUksTUFBTSxNQUFNLENBQUE7QUFDdkIsT0FBTyxZQUFZLENBQUE7QUFFbkIsTUFBTSxLQUFLLEdBQUcsSUFBSSxDQUFBO0FBRWxCLElBQUksTUFBVSxDQUFBO0FBQ2QsSUFBSSx1QkFBdUIsR0FBWSxFQUFFLENBQUE7QUFFekMsTUFBTSxDQUFDLE1BQU0sYUFBYSxHQUFHLElBQUksRUFBRSxDQUFBO0FBRW5DLE1BQU0sQ0FBTixJQUFZLGVBYVg7QUFiRCxXQUFZLGVBQWU7SUFDekIsd0RBQXFDLENBQUE7SUFDckMsOENBQTJCLENBQUE7SUFDM0IsNENBQXlCLENBQUE7SUFDekIsa0RBQStCLENBQUE7SUFDL0Isb0RBQWlDLENBQUE7SUFDakMsMENBQXVCLENBQUE7SUFDdkIsZ0RBQTZCLENBQUE7SUFDN0Isd0RBQXFDLENBQUE7SUFDckMsZ0RBQTZCLENBQUE7SUFDN0IsOENBQTJCLENBQUE7SUFDM0Isd0RBQXFDLENBQUE7SUFDckMsd0RBQXFDLENBQUE7QUFDdkMsQ0FBQyxFQWJXLGVBQWUsS0FBZixlQUFlLFFBYTFCO0FBa0NELE1BQU0sQ0FBQyxNQUFNLG1CQUFtQixHQUFHLElBQUksR0FBRyxFQUFnQixDQUFBO0FBQzFELE1BQU0s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QUNqQyxTQUFTLENBQUMsVUFBVSxDQUFDLEdBQUcsQ0FBQyxTQUFTLENBQUMsQ0FBQyxLQUFLLEdBQUcsT0FBTyxDQUFDLElBQUksRUFBRSxDQUFBO3dCQUcxRCxJQUFJLGNBQWMsRUFBRSxDQUFDOzRCQUNuQixTQUFTLENBQUMsVUFBVSxDQUFDLEdBQUcsQ0FBQyxnQkFBZ0IsQ0FBQyxDQUFDLEtBQUssR0FBRyxPQUFPLENBQUMsSUFBSSxFQUFFLENBQUE7d0JBQ25FLENBQUM7b0JBQ0gsQ0FBQztnQkFDSCxDQUFDO1lBQ0gsQ0FBQztRQUNILENBQUM7UUFBQyxPQUFNLENBQUssRUFBRSxDQUFDO1lBQ2QsT0FBTyxDQUFDLEdBQUcsQ0FBQyxrQ0FBa0MsRUFBRSxDQUFDLENBQUMsQ0FBQTtRQUNwRCxDQUFDO0lBQ0gsQ0FBQztJQUVELE1BQU0sQ0FBQyxTQUFTLENBQUMsaUJBQWlCLENBQUMsQ0FBQTtBQUdyQyxDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgZW5naW5lLCBFbnRpdHksIE1hdGVyaWFsLCBNZXNoUmVuZGVyZXIsIFRleHRBbGlnbk1vZGUsIFRleHRTaGFwZSwgVHJhbnNmb3JtIH0gZnJvbSAnQGRjbC9zZGsvZWNzJ1xuaW1wb3J0IHsgUmVhY3RFY3NSZW5kZXJlcn0gZnJvbSAnQGRjbC9zZGsvcmVhY3QtZWNzJ1xuaW1wb3J0IHsgQ29sb3I0LCBWZWN0b3IzIH0gZnJvbSAnQGRjbC9zZGsvbWF0aCdcbmltcG9ydCB7Z2V0UGxheWVyfSBmcm9tIFwiQGRjbC9zZGsvcGxheWVyc1wiO1xuaW1wb3J0IHsgZ2V0UmVhbG0gfSBmcm9tICd+c3lzdGVtL1J1bnRpbWUnXG5pbXBvcnQgeyBDbGllbnQsIFJvb20gfSBmcm9tICdjb2x5c2V1cy5qcydcbmltcG9ydCBtaXR0IGZyb20gJ21pdHQnXG5pbXBvcnQgJy4vcG9seWZpbGwnXG5cbmNvbnN0IERFQlVHID0gdHJ1ZVxuXG5sZXQgcGxheWVyOmFueVxubGV0IHBlbmRpbmdRdWVzdENvbm5lY3Rpb25zOnN0cmluZ1tdID0gW11cblxuZXhwb3J0IGNvbnN0IGxzY1F1ZXN0RXZlbnQgPSBtaXR0KClcblxuZXhwb3J0IGVudW0gTFNDUVVFU1RfRVZFTlRTIHtcbiAgUVVFU1RfQ09OTkVDVElPTiA9ICdRVUVTVF9DT05ORUNUSU9OJyxcbiAgUVVFU1RfRVJST1IgPSAnUVVFU1RfRVJST1InLFxuICBRVUVTVF9EQVRBID0gJ1FVRVNUX0RBVEEnLFxuICBRVUVTVF9TVEFSVEVEID0gJ1FVRVNUX1NUQVJURUQnLFxuICBRVUVTVF9DT01QTEVURSA9ICdRVUVTVF9DT01QTEVURScsXG4gIFFVRVNUX0VORCA9ICdRVUVTVF9FTkQnLFxuICBRVUVTVF9VUERBVEUgPSAnUVVFU1RfVVBEQVRFJyxcbiAgUVVFU1RfRElTQ09OTkVDVCA9ICdRVUVTVF9ESVNDT05ORUNUJyxcbiAgUVVFU1RfQUNUSU9OID0gJ1FVRVNUX0FDVElPTicsXG4gIFFVRVNUX1NUQVJUID0gJ1FVRVNUX1NUQVJUJyxcbiAgUVVFU1RfU1RFUF9DT01QTEVURSA9ICdTVEVQX0NPTVBMRVRFJyxcbiAgUVVFU1RfVEFTS19DT01QTEVURSA9ICdUQVNLX0NPTVBMRVRFJ1xufVxuXG5pbnRlcmZhY2UgVGFza0RlZmluaXRpb24ge1xuICB0YXNrSWQ6IHN0cmluZztcbiAgcmVxdWlyZWRDb3VudDogbnVtYmVyO1xuICBjb3VudDogbnVtYmVyO1xuICBjb21wbGV0ZWQ6IGJvb2xlYW47XG4gIGRlc2NyaXB0aW9uOiBzdHJpbmc7XG4gIG1ldGF2ZXJzZTogJ0RFQ0VOVFJBTEFORCcgfCAnSFlQRVJGWSc7XG4gIHByZXJlcXVpc2l0ZVRhc2tJZHM6IHN0cmluZ1tdO1xufVxuaW50ZXJmYWNlIFN0ZXBEZWZpbml0aW9uIHtcbiAgc3RlcElkOiBzdHJpbmc7XG4gIG5hbWU/OiBzdHJpbmc7XG4gIGNvbXBsZXRlZDogYm9vbGVhbjtcbiAgdGFza3M6IFRhc2tEZWZpbml0aW9uW107XG4gIHByZXJlcXVpc2l0ZVN0ZXBJZHM/OiBzdHJpbmdbXTtcbn1cblxuaW50ZXJmYWNlIFF1ZXN0RGVmaW5pdGlvbiB7XG4gICAgcXVlc3RJZDogc3RyaW5nO1xuICAgIHZlcnNpb246IG51bWJlcjtcbiAgICBlbmFibGVkOmJvb2xlYW4sXG4gICAgcXVlc3RUeXBlOiAnTElORUFSJyB8ICdPUEVOX0VOREVEJyB8ICdPTkVfU0hPVCc7IFxuICAgIHN0YXJ0VHJpZ2dlcj86ICdFWFBMSUNJVCcgfCAnRklSU1RfVEFTSyc7XG4gICAgdGl0bGU/OiBzdHJpbmc7XG4gICAgc3RhcnRUaW1lPzogbnVtYmVyO1xuICAgIGVuZFRpbWU/OiBudW1iZXI7XG4gICAgYWxsb3dSZXBsYXk6IGJvb2xlYW47XG4gICAgY29tcGxldGVkOiBib29sZWFuO1xuICAgIGNyZWF0b3I6IHN0cmluZztcbiAgICBzdGVwczogU3RlcERlZmluaXRpb25bXTtcbn1cblxuZXhwb3J0IGNvbnN0IGxzY1F1ZXN0Q29ubmVjdGlvbnMgPSBuZXcgTWFwPHN0cmluZywgUm9vbT4oKVxuZXhwb3J0IGNvbnN0IGxzY1F1ZXN0VXNlckRhdGEgPSBuZXcgTWFwPHN0cmluZywgUXVlc3REZWZpbml0aW9uPigpXG5cbi8qKlxuICogQ29ubmVjdCB0byBhIFF1ZXN0IHdpdGhpbiB0aGUgTFNDIFF1ZXN0IFN5c3RlbVxuICpcbiAqIEBwYXJhbSBxdWVzdElkXG4gKi9cbmV4cG9ydCBhc3luYyBmdW5jdGlvbiBMU0NRdWVzdENvbm5lY3QocXVlc3RJZDpzdHJpbmcpIHtcbiAgY29uc29sZS5sb2coJ2Nvbm5lY3RpbmcgdG8gcXVlc3QnLCBxdWVzdElkKVxuICBlbmdpbmUuYWRkU3lzdGVtKENoZWNrUGxheWVyU3lzdGVtKVxuICBlbmdpbmUuYWRkU3lzdGVtKENvbm5lY3RRdWVzdFN5c3RlbSlcblxuICBpZihsc2NRdWVzdENvbm5lY3Rpb25zLmhhcyhxdWVzdElkKSkgIHJldHVyblxuICBwZW5kaW5nUXVlc3RDb25uZWN0aW9ucy5wdXNoKHF1ZXN0SWQpXG59XG5cbi8qKlxuICogU3RhcnQgYSBzcGVjaWZpYyBRdWVzdCBpbiB0aGUgTFNDIFF1ZXN0IFN5c3RlbVxuICpcbiAqIEBwYXJhbSBxdWVzdElkXG4gKi9cbmV4cG9ydCBmdW5jdGlvbiBMU0NRdWVzdFN0YXJ0KHF1ZXN0SWQ6c3RyaW5nKXtcbiAgbGV0IHF1ZXN0Q29ubmVjdGlvbiA9IGxzY1F1ZXN0Q29ubmVjdGlvbnMuZ2V0KHF1ZXN0SWQpXG4gIGlmKCFxdWVzdENvbm5lY3Rpb24pICByZXR1cm5cblxuICB0cnl7XG4gICAgcXVlc3RDb25uZWN0aW9uLnNlbmQoTFNDUVVFU1RfRVZFTlRTLlFVRVNUX1NUQVJULCB7cXVlc3RJZH0pXG4gIH1cbiAgY2F0Y2goZTphbnkpe1xuICAgIGNvbnNvbGUubG9nKCdlcnJvciBzZW5kaW5nIHF1ZXN0IGFjdGlvbicsIGUpXG4gIH1cbn1cblxuLyoqXG4gKiBSdW4gYSBRdWVzdCBBY3Rpb24gd2l0aGluIHRoZSBMU0MgUXVlc3QgU3lzdGVtXG4gKlxuICogQHBhcmFtIHF1ZXN0SWRcbiAqIEBwYXJhbSBzdGVwSWRcbiAqIEBwYXJhbSB0YXNrSWRcbiAqL1xuZXhwb3J0IGZ1bmN0aW9uIExTQ1F1ZXN0QWN0aW9uKHF1ZXN0SWQ6c3RyaW5nLCBzdGVwSWQ6c3RyaW5nLCB0YXNrSWQ6c3RyaW5nKXtcbiAgbGV0IHF1ZXN0Q29ubmVjdGlvbiA9IGxzY1F1ZXN0Q29ubmVjdGlvbnMuZ2V0KHF1ZXN0SWQpXG4gIGlmKCFxdWVzdENvbm5lY3Rpb24pICByZXR1cm5cblxuICB0cnl7XG4gICAgcXVlc3RDb25uZWN0aW9uLnNlbmQoTFNDUVVFU1RfRVZFTlRTLlFVRVNUX0FDVElPTiwge3F1ZXN0SWQsIHN0ZXBJZCwgdGFza0lkLCBtZXRhdmVyc2U6XCJERUNFTlRSQUxBTkRcIn0pXG4gIH1cbiAgY2F0Y2goZTphbnkpe1xuICAgIGNvbnNvbGUubG9nKCdlcnJvciBzZW5kaW5nIHF1ZXN0IGFjdGlvbicsIGUpXG4gIH1cbn1cblxuZnVuY3Rpb24gc2V0TFNDUXVlc3RMaXN0ZW5lcnMocm9vbTpSb29tLCB1c2VySWQ6c3RyaW5nKXtcbiAgcm9vbS5vbk1lc3NhZ2UoTFNDUVVFU1RfRVZFTlRTLlFVRVNUX0NPTk5FQ1RJT04sIChpbmZvOmFueSk9PntcbiAgICBjb25zb2xlLmxvZygncXVlc3QgY29ubmVjdGlvbiAnLCBpbmZvKVxuICAgIGxzY1F1ZXN0RXZlbnQuZW1pdChMU0NRVUVTVF9FVkVOVFMuUVVFU1RfQ09OTkVDVElPTiwgaW5mbylcbiAgfSlcblxuICByb29tLm9uTWVzc2FnZShMU0NRVUVTVF9FVkVOVFMuUVVFU1RfRVJST1IsIChpbmZvOmFueSk9PntcbiAgICBjb25zb2xlLmxvZygncXVlc3QgZXJyb3IgJywgaW5mbylcbiAgICBsc2NRdWVzdEV2ZW50LmVtaXQoTFNDUVVFU1RfRVZFTlRTLlFVRVNUX0VSUk9SLCBpbmZvKVxuICB9KVxuXG4gIHJvb20ub25NZXNzYWdlKExTQ1FVRVNUX0VWRU5UUy5RVUVTVF9EQVRBLCAoaW5mbzphbnkpPT57XG4gICAgY29uc29sZS5sb2coJ3VzZXIgcXVlc3QgZGF0YSAnLCBpbmZvKVxuICAgIGlmKGluZm8udXNlclF1ZXN0SW5mbyl7XG4gICAgICBsc2NRdWVzdFVzZXJEYXRhLnNldChpbmZvLnF1ZXN0SWQsIGluZm8udXNlclF1ZXN0SW5mbylcbiAgICB9XG4gICAgbHNjUXVlc3RFdmVudC5lbWl0KExTQ1FVRVNUX0VWRU5UUy5RVUVTVF9EQVRBLCBpbmZvKVxuICB9KVxuXG4gIHJvb20ub25NZXNzYWdlKExTQ1FVRVNUX0VWRU5UUy5RVUVTVF9TVEFSVEVELCAoaW5mbzphbnkpPT57XG4gICAgY29uc29sZS5sb2coJ3N0YXJ0ZWQgcXVlc3QgJywgaW5mbylcbiAgICBsc2NRdWVzdEV2ZW50LmVtaXQoTFNDUVVFU1RfRVZFTlRTLlFVRVNUX1NUQVJURUQsIGluZm8pXG4gIH0pXG5cbiAgcm9vbS5vbk1lc3NhZ2UoTFNDUVVFU1RfRVZFTlRTLlFVRVNUX0NPTVBMRVRFLCAoaW5mbzphbnkpPT57XG4gICAgY29uc29sZS5sb2coJ2NvbXBsZXRlIHF1ZXN0ICcsIGluZm8pXG4gICAgXG4gICAgLy8gSWYgdGhlIHNlcnZlciBzZW50IGNvbXBsZXRlIHVzZXIgcXVlc3QgaW5mbywgdXNlIGl0IGRpcmVjdGx5XG4gICAgaWYgKGluZm8udXNlclF1ZXN0SW5mbykge1xuICAgICAgbHNjUXVlc3RVc2VyRGF0YS5zZXQoaW5mby5xdWVzdElkLCBpbmZvLnVzZXJRdWVzdEluZm8pXG4gICAgfSBcbiAgICAvLyBGYWxsYmFjayB0byBvbGQgYmVoYXZpb3IgaWYgc2VydmVyIGRvZXNuJ3Qgc2VuZCBjb21wbGV0ZSBkYXRhXG4gICAgZWxzZSB7XG4gICAgICBsZXQgdXNlclF1ZXN0RGF0YSA9IGxzY1F1ZXN0VXNlckRhdGEuZ2V0KGluZm8ucXVlc3RJZClcbiAgICAgIGlmKHVzZXJRdWVzdERhdGEpe1xuICAgICAgICB1c2VyUXVlc3REYXRhLmNvbXBsZXRlZCA9IHRydWVcbiAgICAgIH1cbiAgICB9XG4gICAgXG4gICAgbHNjUXVlc3RFdmVudC5lbWl0KExTQ1FVRVNUX0VWRU5UUy5RVUVTVF9DT01QTEVURSwgaW5mbylcbiAgfSlcblxuICByb29tLm9uTWVzc2FnZShMU0NRVUVTVF9FVkVOVFMuUVVFU1RfRU5ELCAoaW5mbzphbnkpPT57XG4gICAgY29uc29sZS5sb2coJ2VuZGVkIHF1ZXN0ICcsIGluZm8pXG4gICAgbHNjUXVlc3RFdmVudC5lbWl0KExTQ1FVRVNUX0VWRU5UUy5RVUVTVF9FTkQsIGluZm8pXG4gIH0pXG5cbiAgcm9vbS5vbk1lc3NhZ2UoTFNDUVVFU1RfRVZFTlRTLlFVRVNUX1VQREFURSwgKGluZm86YW55KT0+e1xuICAgIGNvbnNvbGUubG9nKCd1cGRhdGUgcXVlc3QgJywgaW5mbylcbiAgICBsc2NRdWVzdFVzZXJEYXRhLnNldCh1c2VySWQsIGluZm8pXG4gICAgbHNjUXVlc3RFdmVudC5lbWl0KExTQ1FVRVNUX0VWRU5UUy5RVUVTVF9VUERBVEUsIGluZm8pXG4gIH0pXG5cbiAgcm9vbS5vbk1lc3NhZ2UoTFNDUVVFU1RfRVZFTlRTLlFVRVNUX1NURVBfQ09NUExFVEUsIChpbmZvOmFueSk9PntcbiAgICBjb25zb2xlLmxvZygnc3RlcCBjb21wbGV0ZSBxdWVzdCAnLCBpbmZvKVxuICAgIFxuICAgIC8vIElmIHRoZSBzZXJ2ZXIgc2VudCBjb21wbGV0ZSB1c2VyIHF1ZXN0IGluZm8sIHVzZSBpdCBkaXJlY3RseVxuICAgIGlmIChpbmZvLnVzZXJRdWVzdEluZm8pIHtcbiAgICAgIGxzY1F1ZXN0VXNlckRhdGEuc2V0KGluZm8ucXVlc3RJZCwgaW5mby51c2VyUXVlc3RJbmZvKVxuICAgIH1cbiAgICAvLyBGYWxsYmFjayB0byBvbGQgYmVoYXZpb3IgaWYgc2VydmVyIGRvZXNuJ3Qgc2VuZCBjb21wbGV0ZSBkYXRhXG4gICAgZWxzZSB7XG4gICAgICBsZXQgdXNlclF1ZXN0RGF0YSA9IGxzY1F1ZXN0VXNlckRhdGEuZ2V0KGluZm8ucXVlc3RJZClcbiAgICAgIGlmKHVzZXJRdWVzdERhdGEpe1xuICAgICAgICBsZXQgc3RlcCA9IHVzZXJRdWVzdERhdGEuc3RlcHMuZmluZCgoc3RlcDphbnkpPT5zdGVwLnN0ZXBJZCA9PT0gaW5mby5zdGVwSWQpXG4gICAgICAgIGlmKHN0ZXApe1xuICAgICAgICAgIHN0ZXAuY29tcGxldGVkID0gdHJ1ZVxuICAgICAgICB9XG4gICAgICB9XG4gICAgfVxuICAgIFxuICAgIGxzY1F1ZXN0RXZlbnQuZW1pdChMU0NRVUVTVF9FVkVOVFMuUVVFU1RfU1RFUF9DT01QTEVURSwgaW5mbylcbiAgfSlcblxuICByb29tLm9uTWVzc2FnZShMU0NRVUVTVF9FVkVOVFMuUVVFU1RfVEFTS19DT01QTEVURSwgKGluZm86YW55KT0+e1xuICAgIGNvbnNvbGUubG9nKCd0YXNrIGNvbXBsZXRlIHF1ZXN0ICcsIGluZm8pXG4gICAgXG4gICAgLy8gSWYgdGhlIHNlcnZlciBzZW50IGNvbXBsZXRlIHVzZXIgcXVlc3QgaW5mbywgdXNlIGl0IGRpcmVjdGx5XG4gICAgaWYgKGluZm8udXNlclF1ZXN0SW5mbykge1xuICAgICAgbHNjUXVlc3RVc2VyRGF0YS5zZXQoaW5mby5xdWVzdElkLCBpbmZvLnVzZXJRdWVzdEluZm8pXG4gICAgfSBcbiAgICAvLyBGYWxsYmFjayB0byBvbGQgYmVoYXZpb3IgaWYgc2VydmVyIGRvZXNuJ3Qgc2VuZCBjb21wbGV0ZSBkYXRhXG4gICAgZWxzZSB7XG4gICAgICBsZXQgdXNlclF1ZXN0RGF0YSA9IGxzY1F1ZXN0VXNlckRhdGEuZ2V0KGluZm8ucXVlc3RJZClcbiAgICAgIGlmKHVzZXJRdWVzdERhdGEpe1xuICAgICAgICBsZXQgc3RlcCA9IHVzZXJRdWVzdERhdGEuc3RlcHMuZmluZCgoc3RlcDphbnkpPT5zdGVwLnN0ZXBJZCA9PT0gaW5mby5zdGVwSWQpXG4gICAgICAgIGlmKHN0ZXApe1xuICAgICAgICAgIGxldCB0YXNrID0gc3RlcC50YXNrcy5maW5kKCh0YXNrOmFueSk9PnRhc2sudGFza0lkID09PSBpbmZvLnRhc2tJZClcbiAgICAgICAgICBpZih0YXNrKXtcbiAgICAgICAgICAgIHRhc2suY291bnQrK1xuICAgICAgICAgICAgdGFzay5jb21wbGV0ZWQgPSB0cnVlXG4gICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICB9XG4gICAgfVxuICAgIFxuICAgIGxzY1F1ZXN0RXZlbnQuZW1pdChMU0NRVUVTVF9FVkVOVFMuUVVFU1RfVEFTS19DT01QTEVURSwgaW5mbylcbiAgfSlcbn1cblxubGV0IHRpbWU6bnVtYmVyID0gMFxuZnVuY3Rpb24gQ2hlY2tQbGF5ZXJTeXN0ZW0oZHQ6bnVtYmVyKXtcbiAgaWYodGltZSA+IDApe1xuICAgIHRpbWUgLT0gZHRcbiAgfWVsc2V7XG4gICAgcGxheWVyID0gZ2V0UGxheWVyKClcbiAgICBpZighcGxheWVyKXtcbiAgICAgIHRpbWUgPSAxXG4gICAgfWVsc2V7XG4gICAgICBlbmdpbmUucmVtb3ZlU3lzdGVtKENoZWNrUGxheWVyU3lzdGVtKVxuICAgIH1cbiAgfVxufVxuXG5mdW5jdGlvbiBDb25uZWN0UXVlc3RTeXN0ZW0oKXtcbiAgaWYoIXBsYXllcikgcmV0dXJuXG4gIGNvbnNvbGUubG9nKCdjb25uZWN0aW5nIHF1ZXN0IHN5c3RlbScpXG5cbiAgaWYocGVuZGluZ1F1ZXN0Q29ubmVjdGlvbnMubGVuZ3RoID4gMCl7XG4gICAgbGV0IHBlbmRpbmdRdWVzdElkOnN0cmluZyA9IFwiXCIgKyBwZW5kaW5nUXVlc3RDb25uZWN0aW9ucy5zaGlmdCgpXG4gICAgbWFrZVF1ZXN0Q29ubmVjdGlvbihwZW5kaW5nUXVlc3RJZClcbiAgfVxufVxuXG5hc3luYyBmdW5jdGlvbiBtYWtlUXVlc3RDb25uZWN0aW9uKHF1ZXN0SWQ6c3RyaW5nKXtcbiAgY29uc3QgcmVhbG0gPSBhd2FpdCBnZXRSZWFsbSh7fSlcblxuICBjb25zdCBvcHRpb25zOmFueSA9IHtcbiAgICB1c2VySWQ6IHBsYXllci51c2VySWQsXG4gICAgbmFtZTogcGxheWVyLm5hbWUsXG4gICAgcmVhbG06IHJlYWxtLnJlYWxtSW5mbz8uYmFzZVVybCxcbiAgICBxdWVzdElkOiBxdWVzdElkLFxuICB9XG5cbiAgbGV0IGNsaWVudCA9IG5ldyBDbGllbnQoREVCVUcgPyBcbiAgICB7aG9zdG5hbWU6J2xvY2FsaG9zdCcsIHNlY3VyZTpmYWxzZSwgcG9ydDo1MzUzfSA6IFxuICAgIHtob3N0bmFtZTonYW5nemFhci1wbGF6YS5kY2wtaXdiLmNvJywgcGF0aG5hbWU6Jy93cycsIHNlY3VyZTp0cnVlfVxuICApXG5cbiAgdHJ5IHtcbiAgICBjb25zdCByb29tOiBSb29tID0gYXdhaXQgY2xpZW50LmpvaW5PckNyZWF0ZSgnYW5nemFhcl9xdWVzdGluZycsIG9wdGlvbnMpXG4gICAgbHNjUXVlc3RDb25uZWN0aW9ucy5zZXQocXVlc3RJZCwgcm9vbSlcbiAgICBzZXRMU0NRdWVzdExpc3RlbmVycyhyb29tLCBwbGF5ZXIudXNlcklkKVxuXG4gICAgcm9vbS5vbkxlYXZlKChjb2RlOm51bWJlciwgcmVhc29uPzpzdHJpbmcpPT57XG4gICAgICBjb25zb2xlLmxvZygnbGVmdCBxdWVzdCByb29tJywgcXVlc3RJZCwgY29kZSwgcmVhc29uKVxuICAgICAgICBsc2NRdWVzdEV2ZW50LmVtaXQoTFNDUVVFU1RfRVZFTlRTLlFVRVNUX0RJU0NPTk5FQ1QsIHtxdWVzdElkLCBjb2RlLCByZWFzb259KVxuICAgIH0pXG4gICAgcmV0dXJuIHJvb21cbiAgfSBjYXRjaCAoZXJyb3I6IGFueSkge1xuICAgIGNvbnNvbGUuZXJyb3IoJ0Vycm9yIGNvbm5lY3RpbmcgdG8gTFNDIFF1ZXN0IFN5c3RlbScsIGVycm9yKVxuICAgIHRocm93IGVycm9yXG4gIH1cbn1cblxuXG4vKipcbiAqIFxuICogQHBhcmFtIHF1ZXN0SWQgXG4gKiBAcGFyYW0gcG9zaXRpb24gXG4gKiBAcGFyYW0gdXBkYXRlSW50ZXJ2YWwgXG4gKiBAcGFyYW0gbGltaXQgXG4gKiBAcGFyYW0gb3JkZXIgXG4gKiBAcGFyYW0gc29ydEJ5IFxuICogQHBhcmFtIGNvbXBsZXRlZCBcbiAqIEBwYXJhbSBzaG93QmFja2dyb3VuZFxuICogQHBhcmFtIHRpdGxlXG4gKi9cbmV4cG9ydCBmdW5jdGlvbiBMU0NRdWVzdExlYWRlcmJvYXJkKFxuICBxdWVzdElkOnN0cmluZywgXG4gIHBvc2l0aW9uOlZlY3RvcjMsIFxuICB1cGRhdGVJbnRlcnZhbDpudW1iZXIsXG4gIGxpbWl0Om51bWJlcixcbiAgb3JkZXI6ICdhc2MnIHwgJ2FzYycgPSAnYXNjJyxcbiAgc29ydEJ5OnN0cmluZyA9ICdlbGFwc2VkVGltZScsXG4gIGNvbXBsZXRlZDpib29sZWFuID0gdHJ1ZSxcbiAgc2hvd0JhY2tncm91bmQ6Ym9vbGVhbiA9IHRydWUsXG4gIHRpdGxlOnN0cmluZyA9IFwiTGVhZGVyYm9hcmRcIlxuICApe1xuICAgIFxuICBsZXQgbGVhZGVyYm9hcmQgPSBlbmdpbmUuYWRkRW50aXR5KClcbiAgVHJhbnNmb3JtLmNyZWF0ZShsZWFkZXJib2FyZCwge3Bvc2l0aW9ufSlcbiAgXG4gIC8vIFJvdyBkaW1lbnNpb25zXG4gIGNvbnN0IHJvd1dpZHRoID0gM1xuICBjb25zdCByb3dIZWlnaHQgPSAwLjRcbiAgXG4gIC8vIEhlbHBlciBmdW5jdGlvbiB0byBmb3JtYXQgdGhlIHNjb3JlIHR5cGUgZm9yIGRpc3BsYXlcbiAgZnVuY3Rpb24gZm9ybWF0U2NvcmVUeXBlKHR5cGU6IHN0cmluZyk6IHN0cmluZyB7XG4gICAgaWYgKHR5cGUgPT09ICdlbGFwc2VkVGltZScpIHJldHVybiAnVGltZSc7XG4gICAgcmV0dXJuIHR5cGUuY2hhckF0KDApLnRvVXBwZXJDYXNlKCkgKyB0eXBlLnNsaWNlKDEpOyAvLyBDYXBpdGFsaXplIGZpcnN0IGxldHRlclxuICB9XG4gIFxuICAvLyBDcmVhdGUgdGl0bGVcbiAgY29uc3QgdGl0bGVFbnRpdHkgPSBlbmdpbmUuYWRkRW50aXR5KClcbiAgVHJhbnNmb3JtLmNyZWF0ZSh0aXRsZUVudGl0eSwge1xuICAgIHBhcmVudDogbGVhZGVyYm9hcmQsXG4gICAgcG9zaXRpb246IFZlY3RvcjMuY3JlYXRlKDAsIDAuNiwgMClcbiAgfSlcbiAgVGV4dFNoYXBlLmNyZWF0ZSh0aXRsZUVudGl0eSwge1xuICAgIHRleHQ6IHRpdGxlLFxuICAgIGZvbnRTaXplOiAyLjUsXG4gICAgdGV4dEFsaWduOiBUZXh0QWxpZ25Nb2RlLlRBTV9NSURETEVfQ0VOVEVSXG4gIH0pXG4gIFxuICAvLyBSb3cgcG9zaXRpb25zIChjZW50ZXJlZClcbiAgY29uc3QgbGVmdFBvcyA9IC0xLjJcbiAgY29uc3QgY2VudGVyUG9zID0gMFxuICBjb25zdCByaWdodFBvcyA9IDEuMlxuICBcbiAgLy8gQ3JlYXRlIGhlYWRlciByb3dcbiAgY29uc3QgaGVhZGVyRW50aXR5ID0gZW5naW5lLmFkZEVudGl0eSgpXG4gIFRyYW5zZm9ybS5jcmVhdGUoaGVhZGVyRW50aXR5LCB7XG4gICAgcGFyZW50OiBsZWFkZXJib2FyZCxcbiAgICBwb3NpdGlvbjogVmVjdG9yMy5jcmVhdGUoMCwgMC4yLCAwKVxuICB9KVxuICBcbiAgLy8gSGVhZGVyIGJhY2tncm91bmRcbiAgY29uc3QgaGVhZGVyQmdFbnRpdHkgPSBlbmdpbmUuYWRkRW50aXR5KClcbiAgVHJhbnNmb3JtLmNyZWF0ZShoZWFkZXJCZ0VudGl0eSwge1xuICAgIHBhcmVudDogaGVhZGVyRW50aXR5LFxuICAgIHBvc2l0aW9uOiBWZWN0b3IzLmNyZWF0ZSgwLCAwLCAwLjAzKSxcbiAgICBzY2FsZTogVmVjdG9yMy5jcmVhdGUocm93V2lkdGgsIHJvd0hlaWdodCwgMSlcbiAgfSlcbiAgTWVzaFJlbmRlcmVyLnNldFBsYW5lKGhlYWRlckJnRW50aXR5KVxuICBNYXRlcmlhbC5zZXRQYnJNYXRlcmlhbChoZWFkZXJCZ0VudGl0eSwge1xuICAgIGFsYmVkb0NvbG9yOiBDb2xvcjQuY3JlYXRlKDAvMjU1LCAyNTUvMjU1LCAyMTMvMjU1LDEpXG4gIH0pXG4gIFxuICAvLyBIZWFkZXIgbGFiZWxzXG4gIGNvbnN0IHJhbmtIZWFkZXJFbnRpdHkgPSBlbmdpbmUuYWRkRW50aXR5KClcbiAgVHJhbnNmb3JtLmNyZWF0ZShyYW5rSGVhZGVyRW50aXR5LCB7XG4gICAgcGFyZW50OiBoZWFkZXJFbnRpdHksXG4gICAgcG9zaXRpb246IFZlY3RvcjMuY3JlYXRlKGxlZnRQb3MsIDAsIDAuMDIpXG4gIH0pXG4gIFRleHRTaGFwZS5jcmVhdGUocmFua0hlYWRlckVudGl0eSwge1xuICAgIHRleHQ6IFwiUmFua1wiLFxuICAgIGZvbnRTaXplOiAxLjUsXG4gICAgdGV4dEFsaWduOiBUZXh0QWxpZ25Nb2RlLlRBTV9NSURETEVfQ0VOVEVSXG4gIH0pXG4gIFxuICBjb25zdCBuYW1lSGVhZGVyRW50aXR5ID0gZW5naW5lLmFkZEVudGl0eSgpXG4gIFRyYW5zZm9ybS5jcmVhdGUobmFtZUhlYWRlckVudGl0eSwge1xuICAgIHBhcmVudDogaGVhZGVyRW50aXR5LFxuICAgIHBvc2l0aW9uOiBWZWN0b3IzLmNyZWF0ZShjZW50ZXJQb3MgLSAwLjQsIDAsIDAuMDIpXG4gIH0pXG4gIFRleHRTaGFwZS5jcmVhdGUobmFtZUhlYWRlckVudGl0eSwge1xuICAgIHRleHQ6IFwiUGxheWVyXCIsXG4gICAgZm9udFNpemU6IDEuNSxcbiAgICB0ZXh0QWxpZ246IFRleHRBbGlnbk1vZGUuVEFNX01JRERMRV9MRUZUXG4gIH0pXG4gIFxuICBjb25zdCBzY29yZUhlYWRlckVudGl0eSA9IGVuZ2luZS5hZGRFbnRpdHkoKVxuICBUcmFuc2Zvcm0uY3JlYXRlKHNjb3JlSGVhZGVyRW50aXR5LCB7XG4gICAgcGFyZW50OiBoZWFkZXJFbnRpdHksXG4gICAgcG9zaXRpb246IFZlY3RvcjMuY3JlYXRlKHJpZ2h0UG9zLCAwLCAwLjAyKVxuICB9KVxuICBUZXh0U2hhcGUuY3JlYXRlKHNjb3JlSGVhZGVyRW50aXR5LCB7XG4gICAgdGV4dDogZm9ybWF0U2NvcmVUeXBlKHNvcnRCeSksXG4gICAgZm9udFNpemU6IDEuNSxcbiAgICB0ZXh0QWxpZ246IFRleHRBbGlnbk1vZGUuVEFNX01JRERMRV9DRU5URVJcbiAgfSlcbiAgXG4gIC8vIEFycmF5IHRvIHN0b3JlIHJlZmVyZW5jZXMgdG8gYWxsIGxlYWRlcmJvYXJkIGVudGl0aWVzXG4gIGNvbnN0IGxlYWRlcmJvYXJkUm93czogQXJyYXk8e1xuICAgIHJhbms6IG51bWJlcixcbiAgICByb3dFbnRpdHk6IEVudGl0eSxcbiAgICBiYWNrZ3JvdW5kRW50aXR5OiBFbnRpdHksXG4gICAgcmFua0VudGl0eTogRW50aXR5LFxuICAgIHByb2ZpbGVFbnRpdHk6IEVudGl0eSxcbiAgICBuYW1lRW50aXR5OiBFbnRpdHksXG4gICAgc2NvcmVFbnRpdHk6IEVudGl0eVxuICB9PiA9IFtdXG5cbiAgLy8gQ3JlYXRlIHBsYWNlaG9sZGVyIHJvd3NcbiAgZm9yKGxldCBpID0gMDsgaSA8IGxpbWl0OyBpKyspe1xuICAgIC8vIENyZWF0ZSByb3cgY29udGFpbmVyIGVudGl0eVxuICAgIGNvbnN0IHJvd0VudGl0eSA9IGVuZ2luZS5hZGRFbnRpdHkoKVxuICAgIFRyYW5zZm9ybS5jcmVhdGUocm93RW50aXR5LCB7XG4gICAgICBwYXJlbnQ6IGxlYWRlcmJvYXJkLFxuICAgICAgcG9zaXRpb246IFZlY3RvcjMuY3JlYXRlKDAsIC1pICogMC41IC0gMC4yLCAwKVxuICAgIH0pXG4gIFxuICAgIC8vIENyZWF0ZSBiYWNrZ3JvdW5kIGVudGl0eVxuICAgIGNvbnN0IGJhY2tncm91bmRFbnRpdHkgPSBlbmdpbmUuYWRkRW50aXR5KClcbiAgICBpZiAoc2hvd0JhY2tncm91bmQpIHtcbiAgICAgIFRyYW5zZm9ybS5jcmVhdGUoYmFja2dyb3VuZEVudGl0eSwge1xuICAgICAgICBwYXJlbnQ6IHJvd0VudGl0eSxcbiAgICAgICAgcG9zaXRpb246IFZlY3RvcjMuY3JlYXRlKDAsIDAsIDAuMDEpLFxuICAgICAgICBzY2FsZTogVmVjdG9yMy5jcmVhdGUocm93V2lkdGgsIHJvd0hlaWdodCwgMSlcbiAgICAgIH0pXG4gICAgICBNZXNoUmVuZGVyZXIuc2V0UGxhbmUoYmFja2dyb3VuZEVudGl0eSlcbiAgICAgIE1hdGVyaWFsLnNldFBick1hdGVyaWFsKGJhY2tncm91bmRFbnRpdHksIHtcbiAgICAgICAgYWxiZWRvQ29sb3I6IGkgJSAyID09PSAwID8gXG4gICAgICAgICAgQ29sb3I0LmNyZWF0ZSgxOC8yNTUsIDIzLzI1NSwzNy8yNTUsMSkgOlxuICAgICAgICAgIENvbG9yNC5jcmVhdGUoMjYvMjU1LDM0LzI1NSwgNTMvMjU1LCAxKVxuICAgICAgfSlcbiAgICB9IGVsc2Uge1xuICAgICAgVHJhbnNmb3JtLmNyZWF0ZShiYWNrZ3JvdW5kRW50aXR5LCB7XG4gICAgICAgIHBhcmVudDogcm93RW50aXR5LFxuICAgICAgICBzY2FsZTogVmVjdG9yMy5aZXJvKClcbiAgICAgIH0pXG4gICAgfVxuXG4gICAgLy8gQ3JlYXRlIHJhbmsgZW50aXR5ICgjMSwgIzIsIGV0Yy4pXG4gICAgY29uc3QgcmFua0VudGl0eSA9IGVuZ2luZS5hZGRFbnRpdHkoKVxuICAgIFRyYW5zZm9ybS5jcmVhdGUocmFua0VudGl0eSwge1xuICAgICAgcGFyZW50OiByb3dFbnRpdHksXG4gICAgICBwb3NpdGlvbjogVmVjdG9yMy5jcmVhdGUobGVmdFBvcywgMCwgMClcbiAgICB9KVxuICAgIFRleHRTaGFwZS5jcmVhdGUocmFua0VudGl0eSwge3RleHQ6YCMke2kgKyAxfWAsIGZvbnRTaXplOjEuNX0pXG5cbiAgICAvLyBDcmVhdGUgcHJvZmlsZSBpbWFnZSBlbnRpdHlcbiAgICBjb25zdCBwcm9maWxlRW50aXR5ID0gZW5naW5lLmFkZEVudGl0eSgpXG4gICAgVHJhbnNmb3JtLmNyZWF0ZShwcm9maWxlRW50aXR5LCB7XG4gICAgICBwYXJlbnQ6IHJvd0VudGl0eSxcbiAgICAgIHBvc2l0aW9uOiBWZWN0b3IzLmNyZWF0ZShjZW50ZXJQb3MgLSAwLjgsIDAsIDApLFxuICAgICAgc2NhbGU6IFZlY3RvcjMuY3JlYXRlKDAuMywwLjMsMC4zKVxuICAgIH0pXG4gICAgTWVzaFJlbmRlcmVyLnNldFBsYW5lKHByb2ZpbGVFbnRpdHkpXG4gICAgTWF0ZXJpYWwuc2V0UGJyTWF0ZXJpYWwocHJvZmlsZUVudGl0eSwge1xuICAgICAgdGV4dHVyZTogTWF0ZXJpYWwuVGV4dHVyZS5BdmF0YXIoe1xuICAgICAgICB1c2VySWQ6ICcnLFxuICAgICAgfSksXG4gICAgfSlcblxuICAgIC8vIENyZWF0ZSBuYW1lIGVudGl0eVxuICAgIGNvbnN0IG5hbWVFbnRpdHkgPSBlbmdpbmUuYWRkRW50aXR5KClcbiAgICBUcmFuc2Zvcm0uY3JlYXRlKG5hbWVFbnRpdHksIHtcbiAgICAgIHBhcmVudDogcm93RW50aXR5LFxuICAgICAgcG9zaXRpb246IFZlY3RvcjMuY3JlYXRlKGNlbnRlclBvcyAtIDAuNCwgMCwgMClcbiAgICB9KVxuICAgIFRleHRTaGFwZS5jcmVhdGUobmFtZUVudGl0eSwge3RleHQ6YE5hbWVgLCBmb250U2l6ZToxLjUsICB0ZXh0QWxpZ246IFRleHRBbGlnbk1vZGUuVEFNX01JRERMRV9MRUZUfSlcblxuICAgIC8vIENyZWF0ZSBzY29yZSBlbnRpdHlcbiAgICBjb25zdCBzY29yZUVudGl0eSA9IGVuZ2luZS5hZGRFbnRpdHkoKVxuICAgIFRyYW5zZm9ybS5jcmVhdGUoc2NvcmVFbnRpdHksIHtcbiAgICAgIHBhcmVudDogcm93RW50aXR5LFxuICAgICAgcG9zaXRpb246IFZlY3RvcjMuY3JlYXRlKHJpZ2h0UG9zLCAwLCAwKVxuICAgIH0pXG4gICAgVGV4dFNoYXBlLmNyZWF0ZShzY29yZUVudGl0eSwge3RleHQ6YFNjb3JlYCwgZm9udFNpemU6MS41fSlcblxuICAgIC8vIFN0b3JlIHJlZmVyZW5jZXMgdG8gYWxsIGVudGl0aWVzXG4gICAgbGVhZGVyYm9hcmRSb3dzLnB1c2goe1xuICAgICAgcmFuazogaSArIDEsXG4gICAgICByb3dFbnRpdHksXG4gICAgICBiYWNrZ3JvdW5kRW50aXR5LFxuICAgICAgcmFua0VudGl0eSxcbiAgICAgIHByb2ZpbGVFbnRpdHksXG4gICAgICBuYW1lRW50aXR5LFxuICAgICAgc2NvcmVFbnRpdHlcbiAgICB9KVxuICB9XG5cbiAgbGV0IHRpbWUgPSAwXG4gIGZ1bmN0aW9uIGxlYWRlcmJvYXJkVXBkYXRlKGR0Om51bWJlcil7XG4gICAgaWYodGltZSA+IDApe1xuICAgICAgdGltZSAtPSBkdFxuICAgIH1lbHNle1xuICAgICAgdGltZSA9IHVwZGF0ZUludGVydmFsXG4gICAgICB1cGRhdGVMU0NRdWVzdExlYWRlcmJvYXJkKClcbiAgICB9XG4gIH1cblxuICBhc3luYyBmdW5jdGlvbiB1cGRhdGVMU0NRdWVzdExlYWRlcmJvYXJkKCl7XG4gICAgdHJ5e1xuICAgICAgLy8gR2V0IGN1cnJlbnQgcGxheWVyIGluZm9ybWF0aW9uIGZpcnN0XG4gICAgICBjb25zdCBwbGF5ZXJEYXRhID0gZ2V0UGxheWVyKCk7XG4gICAgICBjb25zdCBwbGF5ZXJJRCA9IHBsYXllckRhdGEgPyBwbGF5ZXJEYXRhLnVzZXJJZCA6ICcnO1xuICAgICAgY29uc3QgcGxheWVyTmFtZSA9IHBsYXllckRhdGE/Lm5hbWUgfHwgJ1lvdSc7XG4gICAgICBcbiAgICAgIC8vIERlZmluZSB0aGUgdXNlciBkYXRhIGludGVyZmFjZVxuICAgICAgaW50ZXJmYWNlIFVzZXJEYXRhIHtcbiAgICAgICAgdXNlcklkOiBzdHJpbmc7XG4gICAgICAgIG5hbWU6IHN0cmluZztcbiAgICAgICAgZWxhcHNlZFRpbWU6IG51bWJlcjtcbiAgICAgICAgY29tcGxldGVkOiBib29sZWFuO1xuICAgICAgICBba2V5OiBzdHJpbmddOiBhbnk7IC8vIEFsbG93IGZvciBkeW5hbWljIHByb3BlcnRpZXMgLy9cbiAgICAgIH1cbiAgICAgIFxuICAgICAgLy8gR2V0IGxlYWRlcmJvYXJkIGRhdGEgZnJvbSBBUElcbiAgICAgIGxldCBwYXJhbXMgPSBbYGNvbXBsZXRlZD0ke2NvbXBsZXRlZH1gLCBgb3JkZXI9JHtvcmRlcn1gLCBgbGltaXQ9JHtsaW1pdH1gLCBgc29ydEJ5PSR7c29ydEJ5fWBdXG4gICAgICBsZXQgcmVzcG9uc2UgPSBhd2FpdCBmZXRjaChgaHR0cDovL2xvY2FsaG9zdDo1MzUzL2FwaS9xdWVzdHMvJHtxdWVzdElkfS91c2Vycz9gICsgcGFyYW1zLmpvaW4oJyYnKSkgXG4gICAgICBsZXQgZGF0YSA9IGF3YWl0IHJlc3BvbnNlLmpzb24oKVxuICAgICAgY29uc29sZS5sb2coJ2xlYWRlcmJvYXJkIGRhdGE6JywgZGF0YSk7XG4gICAgICBcbiAgICAgIC8vIFVwZGF0ZSBsZWFkZXJib2FyZCB3aXRoIGRhdGFcbiAgICAgIGZvcihsZXQgaSA9IDA7IGkgPCBsZWFkZXJib2FyZFJvd3MubGVuZ3RoOyBpKyspIHtcbiAgICAgICAgY29uc3Qgcm93ID0gbGVhZGVyYm9hcmRSb3dzW2ldXG4gICAgICAgIGNvbnN0IHJvd0RhdGEgPSBkYXRhW2ldXG4gICAgICAgIFxuICAgICAgICBpZiAocm93RGF0YSkge1xuICAgICAgICAgIC8vIFNob3cgdGhpcyByb3cgYW5kIHVwZGF0ZSB3aXRoIHVzZXIgZGF0YVxuICAgICAgICAgIGlmICghVHJhbnNmb3JtLmhhcyhyb3cucm93RW50aXR5KSkgY29udGludWVcbiAgICAgICAgICBcbiAgICAgICAgICAvLyBNYWtlIHJvdyB2aXNpYmxlXG4gICAgICAgICAgVHJhbnNmb3JtLmdldE11dGFibGUocm93LnJvd0VudGl0eSkuc2NhbGUgPSBWZWN0b3IzLmNyZWF0ZSgxLCAxLCAxKVxuICAgICAgICAgIFxuICAgICAgICAgIC8vIE9ubHkgdXBkYXRlIGJhY2tncm91bmQgaWYgaXQncyBlbmFibGVkXG4gICAgICAgICAgaWYgKHNob3dCYWNrZ3JvdW5kKSB7XG4gICAgICAgICAgICBUcmFuc2Zvcm0uZ2V0TXV0YWJsZShyb3cuYmFja2dyb3VuZEVudGl0eSkuc2NhbGUgPSBWZWN0b3IzLmNyZWF0ZShyb3dXaWR0aCwgcm93SGVpZ2h0LCAxKVxuICAgICAgICAgIH1cbiAgICAgICAgICBcbiAgICAgICAgICAvLyBTZXQgdXNlciByYW5rICgjMSwgIzIsIGV0Yy4pXG4gICAgICAgICAgY29uc3QgcmFua1RleHQgPSBgIyR7aSArIDF9YFxuICAgICAgICAgIFRleHRTaGFwZS5nZXRNdXRhYmxlKHJvdy5yYW5rRW50aXR5KS50ZXh0ID0gcmFua1RleHRcblxuICAgICAgICAgIE1hdGVyaWFsLnNldFBick1hdGVyaWFsKHJvdy5wcm9maWxlRW50aXR5LCB7XG4gICAgICAgICAgICB0ZXh0dXJlOiBNYXRlcmlhbC5UZXh0dXJlLkF2YXRhcih7XG4gICAgICAgICAgICAgIHVzZXJJZDogcm93RGF0YS51c2VySWQsXG4gICAgICAgICAgICB9KSxcbiAgICAgICAgICB9KVxuICAgICAgICAgIFxuICAgICAgICAgIC8vIFNldCB1c2VyIG5hbWVcbiAgICAgICAgICBjb25zdCBuYW1lID0gcm93RGF0YS5uYW1lIHx8ICdBbm9ueW1vdXMnXG4gICAgICAgICAgVGV4dFNoYXBlLmdldE11dGFibGUocm93Lm5hbWVFbnRpdHkpLnRleHQgPSBuYW1lXG4gICAgICAgICAgXG4gICAgICAgICAgLy8gU2V0IHVzZXIgc2NvcmUgKHRpbWUsIHByb2dyZXNzLCBldGMuKVxuICAgICAgICAgIGxldCBzY29yZVRleHQgPSAnJ1xuICAgICAgICAgIGlmIChzb3J0QnkgPT09ICdlbGFwc2VkVGltZScpIHtcbiAgICAgICAgICAgIC8vIEZvcm1hdCB0aW1lIGRpc3BsYXlcbiAgICAgICAgICAgIGNvbnN0IG1zID0gcm93RGF0YS5lbGFwc2VkVGltZSAqIDEwMDBcbiAgICAgICAgICAgIGNvbnN0IHNlY29uZHMgPSBNYXRoLmZsb29yKG1zIC8gMTAwMClcbiAgICAgICAgICAgIGNvbnN0IG1pbnV0ZXMgPSBNYXRoLmZsb29yKHNlY29uZHMgLyA2MClcbiAgICAgICAgICAgIGNvbnN0IGhvdXJzID0gTWF0aC5mbG9vcihtaW51dGVzIC8gNjApXG4gICAgICAgICAgICBcbiAgICAgICAgICAgIGlmIChob3VycyA+IDApIHtcbiAgICAgICAgICAgICAgc2NvcmVUZXh0ID0gYCR7aG91cnN9aCAke21pbnV0ZXMgJSA2MH1tYFxuICAgICAgICAgICAgfSBlbHNlIGlmIChtaW51dGVzID4gMCkge1xuICAgICAgICAgICAgICBzY29yZVRleHQgPSBgJHttaW51dGVzfW0gJHtzZWNvbmRzICUgNjB9c2BcbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgIHNjb3JlVGV4dCA9IGAke3NlY29uZHN9c2BcbiAgICAgICAgICAgIH1cbiAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgLy8gRm9yIG90aGVyIHNjb3JlIHR5cGVzXG4gICAgICAgICAgICBzY29yZVRleHQgPSByb3dEYXRhW3NvcnRCeV0/LnRvU3RyaW5nKCkgfHwgJzAnXG4gICAgICAgICAgfVxuXG4gICAgICAgICAgVGV4dFNoYXBlLmdldE11dGFibGUocm93LnNjb3JlRW50aXR5KS50ZXh0ID0gc2NvcmVUZXh0XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgLy8gSGlkZSB0aGlzIHJvdyBhcyB0aGVyZSdzIG5vIGRhdGFcbiAgICAgICAgICBpZiAoVHJhbnNmb3JtLmhhcyhyb3cucm93RW50aXR5KSkge1xuICAgICAgICAgICAgVHJhbnNmb3JtLmdldE11dGFibGUocm93LnJvd0VudGl0eSkuc2NhbGUgPSBWZWN0b3IzLlplcm8oKVxuICAgICAgICAgICAgXG4gICAgICAgICAgICAvLyBPbmx5IHVwZGF0ZSBiYWNrZ3JvdW5kIGlmIGl0J3MgZW5hYmxlZFxuICAgICAgICAgICAgaWYgKHNob3dCYWNrZ3JvdW5kKSB7XG4gICAgICAgICAgICAgIFRyYW5zZm9ybS5nZXRNdXRhYmxlKHJvdy5iYWNrZ3JvdW5kRW50aXR5KS5zY2FsZSA9IFZlY3RvcjMuWmVybygpXG4gICAgICAgICAgICB9XG4gICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICB9XG4gICAgfSBjYXRjaChlOmFueSkge1xuICAgICAgY29uc29sZS5sb2coJ2Vycm9yIHVwZGF0aW5nIHF1ZXN0IGxlYWRlcmJvYXJkJywgZSlcbiAgICB9XG4gIH1cblxuICBlbmdpbmUuYWRkU3lzdGVtKGxlYWRlcmJvYXJkVXBkYXRlKVxuXG4gIC8vIFJlYWN0RWNzUmVuZGVyZXIuc2V0VWlSZW5kZXJlcih1aUNvbXBvbmVudClcbn0iXX0=